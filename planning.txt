# PostgreSQL 迁移计划
# 连接字符串: postgresql://neondb_owner:npg_1HfX6WYBRekw@ep-fragrant-mud-a1nkzyhx-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require

================================================================================
## 迁移概览
================================================================================

从 SQLite 迁移到 PostgreSQL (Neon)
- 数据不需保留（测试数据）
- 使用 psycopg2 连接

================================================================================
## 主要改动项目
================================================================================

1. SQL 语法差异:
   - `INTEGER PRIMARY KEY AUTOINCREMENT` → `SERIAL PRIMARY KEY`
   - `datetime('now')` → `NOW()` 或 `CURRENT_TIMESTAMP`
   - `datetime('now', '+X months')` → `NOW() + INTERVAL 'X months'`
   - `datetime('now', '-X hours')` → `NOW() - INTERVAL 'X hours'`
   - 参数占位符 `?` → `%s`

2. 连接方式:
   - `sqlite3.connect()` → `psycopg2.connect()`
   - 需要添加 psycopg2 到 requirements.txt

================================================================================
## 子任务清单
================================================================================

### 任务 1: 添加依赖 [已完成]
文件: requirements.txt
操作: 添加 psycopg2-binary

### 任务 2: 修改 connection.py - 连接函数 [已完成]
文件: core/database/connection.py
操作:
  - 移除 `import sqlite3`
  - 添加 `import psycopg2`
  - 修改 DB_PATH 为 DATABASE_URL
  - 修改 get_connection() 使用 psycopg2.connect()
  - 移除 `PRAGMA foreign_keys`

### 任务 3: 修改 connection.py - init_db() 表结构 [已完成]
文件: core/database/connection.py
操作:
  - `INTEGER PRIMARY KEY AUTOINCREMENT` → `SERIAL PRIMARY KEY`
  - `DATETIME` → `TIMESTAMP`
  - `INTEGER DEFAULT 0` (布尔) → `BOOLEAN DEFAULT FALSE` 或保持 INTEGER
  - 移除所有 `sqlite3.OperationalError` 改为 `psycopg2.Error`
  - `datetime('now')` → `NOW()`

### 任务 4: 修改 connection.py - 索引和配置初始化 [已完成]
文件: core/database/connection.py
操作:
  - 修改 INSERT 语句的 datetime('now') → NOW()
  - 确保索引语法兼容

### 任务 5: 修改 user.py [已完成]
文件: core/database/user.py
操作:
  - 移除 `import sqlite3`
  - `sqlite3.IntegrityError` → `psycopg2.IntegrityError`
  - 所有 `?` → `%s`
  - `datetime('now')` → `NOW()`
  - `datetime('now', '+X months')` → `NOW() + INTERVAL 'X months'`
  - `datetime('now', '-X hours')` → `NOW() - INTERVAL 'X hours'`
  - `datetime('now', '+X minutes')` → `NOW() + INTERVAL 'X minutes'`

### 任务 6: 修改 chat.py [已完成]
文件: core/database/chat.py
操作:
  - 所有 `?` → `%s`
  - `datetime('now')` → `NOW()`

### 任务 7: 修改 cache.py [已完成]
文件: core/database/cache.py
操作:
  - 所有 `?` → `%s`
  - `datetime('now')` → `NOW()`

### 任务 8: 修改 forum.py [已完成]
文件: core/database/forum.py
操作:
  - 所有 `?` → `%s`
  - `datetime('now')` → `NOW()`

### 任务 9: 修改 friends.py [已完成]
文件: core/database/friends.py
操作:
  - 所有 `?` → `%s`
  - `datetime('now')` → `NOW()`

### 任务 10: 修改 messages.py [已完成]
文件: core/database/messages.py
操作:
  - 所有 `?` → `%s`
  - `datetime('now')` → `NOW()`
  - `c.lastrowid` → `RETURNING id`
  - `is_read = 1` → `is_read = TRUE`
  - `is_read = 0` → `is_read = FALSE`
  - DateTime 对象需要 `.isoformat()` 转换

### 任务 11: 修改 trading.py [已完成]
文件: core/database/trading.py
操作:
  - 所有 `?` → `%s`
  - `INSERT OR IGNORE` → `INSERT ... ON CONFLICT DO NOTHING`

### 任务 12: 修改 system_config.py [已完成]
文件: core/database/system_config.py
操作:
  - 所有 `?` → `%s`
  - `INTEGER PRIMARY KEY AUTOINCREMENT` → `SERIAL PRIMARY KEY`
  - `is_public = 1` → `is_public = TRUE`
  - `excluded.value` → `EXCLUDED.value` (PostgreSQL 大写)
  - DateTime 对象需要 `.isoformat()` 转换

### 任务 13: 修改 scripts/cron_expire_members.py [已完成]
文件: scripts/cron_expire_members.py
操作:
  - `datetime('now')` → `NOW()`

### 任务 14: 修改 scripts/add_indexes.py [已完成]
文件: scripts/add_indexes.py
操作:
  - 移除 `import sqlite3`
  - 改用 get_connection()

### 任务 15: 修改 scripts/clear_market_pulse_cache.py [已完成]
文件: scripts/clear_market_pulse_cache.py
操作:
  - 移除 `import sqlite3`
  - 移除 DB_PATH
  - 改用 get_connection()

### 任务 16: 测试连接 [已完成]
操作: 运行简单测试确认连接成功
结果: PostgreSQL 17.7 连接成功

### 任务 17: 初始化数据库表 [已完成]
操作: 运行 init_db() 创建所有表
结果: 成功创建 22 个表

================================================================================
## 详细修改参考
================================================================================

### datetime 函数对照表:
SQLite                              → PostgreSQL
-------------------------------------------------
datetime('now')                     → NOW()
datetime('now', '+1 months')        → NOW() + INTERVAL '1 month'
datetime('now', '+' || ? || ' months') → NOW() + (? || ' months')::INTERVAL
datetime('now', '-24 hours')        → NOW() - INTERVAL '24 hours'
datetime('now', '-' || ? || ' hours')  → NOW() - (? || ' hours')::INTERVAL
datetime(col, '+1 months')          → col + INTERVAL '1 month'

### 动态 INTERVAL 处理:
SQLite: datetime('now', '+' || ? || ' months')
PostgreSQL: NOW() + INTERVAL '1 month' * ?
或使用: NOW() + make_interval(months => ?)

### 连接字符串:
DATABASE_URL = "postgresql://neondb_owner:npg_1HfX6WYBRekw@ep-fragrant-mud-a1nkzyhx-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require"

================================================================================
## 执行顺序
================================================================================

1. 先完成任务 1-4 (connection.py 核心改动) ✅
2. 然后完成任务 5-12 (各数据库模块) ✅
3. 再完成任务 13-15 (scripts) ✅
4. 最后任务 16-17 (测试) ✅

## 迁移完成！所有 17 个任务已完成。

================================================================================
## 注意事项
================================================================================

1. psycopg2 的 cursor 不支持 lastrowid，需要用 RETURNING id
2. PostgreSQL 的 BOOLEAN 用 TRUE/FALSE，不是 1/0（但 INTEGER 也可以）
3. 字符串连接用 || 两边都支持
4. UNIQUE 约束语法相同
5. CREATE INDEX IF NOT EXISTS 语法相同
6. ON CONFLICT 语法中，PostgreSQL 使用 EXCLUDED 而非 excluded
7. DateTime 对象从 PostgreSQL 返回时需要 .isoformat() 转换为 JSON 兼容格式
