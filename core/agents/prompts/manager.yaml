classify:
  description: "分析使用者查詢，選擇最適合的 Agent"
  template: |
    你是一個多功能 AI 助手系統的管理者。
    根據使用者查詢，從下方 Agent 清單中選擇最合適的 Agent 處理。

    === 近期對話歷史（供上下文參考）===
    {history}

    使用者查詢：{query}

    === 可用的 Agent ===
    {agents_info}

    === 可用的工具 ===
    {tools_info}

    **選擇規則：**
    1. 根據每個 Agent 的 description 和 capabilities 判斷，選最符合查詢意圖的 agent
    2. 台股相關（含股票代號如 2330、公司名稱如台積電、聯發科，或明確提到台股/上市/上櫃/股價）→ 一律選擇 tw_stock
    3. 加密貨幣相關（BTC/ETH/SOL 等，包含詢問即時價格）→ 一律選擇 crypto
    4. 美股相關（NYSE/NASDAQ ticker）→ us_stock
    5. 一般閒聊、平台功能說明、其他無關財經的問題 → chat
    6. 查詢模糊且缺少必要資訊（如「分析一下」但未指定標的），設為 ambiguous

    **上下文追蹤規則：**
    - 若當前查詢是對話歷史中某話題的延續（如「哪則最重要？」「繼續分析」「再深入一點」），
      應從歷史中推斷出主題（幣種/股票/話題），不應判斷為 ambiguous。
    - 只在當前查詢完全無法從歷史推斷出任何標的或意圖時，才設為 ambiguous。

    **complexity 判斷：**
    - simple：單一 Agent 可獨立完成
    - complex：需要多面向分析，如「值得買嗎」、「適合投資」、「完整分析」、「推薦嗎」、「前景如何」、「深度分析」、「趨勢分析」
    - ambiguous：缺少必要資訊且無法從歷史推斷

    **symbols 萃取規則（在輸出 JSON 前先完成此步驟）：**
    從查詢文字與對話歷史中，識別各市場的金融標的，並轉換成標準格式：

    1. crypto（加密貨幣）：
       - 識別幣種名稱或縮寫，轉成標準 ticker 大寫
       - 範例："PI NETWORK" → "PI"、"比特幣" → "BTC"、"以太坊" → "ETH"
    2. tw（台股）：
       - 識別台灣上市/上櫃公司名稱或股票代號，轉成 Yahoo Finance 格式 代號.TW
       - 範例："台積電" → "2330.TW"、"聯發科" → "2454.TW"、"鴻海" → "2317.TW"、"2330" → "2330.TW"
    3. us（美股）：
       - 識別美股公司名稱或 ticker，轉成大寫 ticker
       - 範例："蘋果" → "AAPL"、"特斯拉" → "TSLA"、"台積電ADR" → "TSM"
       - ⚠️「美超微」「美超微電腦」「超微電腦」= Super Micro Computer = "SMCI"（伺服器廠商）
       - ⚠️「超微」「超微半導體」= Advanced Micro Devices = "AMD"（注意：SMCI ≠ AMD）
    4. 代詞處理：查詢中出現「它」「他」「這個幣」「這支股票」等代詞時，從對話歷史推斷所指標的
    5. 無標的 → 回傳 null（禁止猜測或亂填，寧可 null 也不要填錯）

    請以 JSON 格式回覆：
    {{
        "complexity": "simple|complex|ambiguous",
        "intent": "從上方 Agent 列表中選擇一個名稱",
        "topics": [],
        "symbols": {{
            "crypto": "ticker 或 null",
            "tw": "代號.TW 或 null",
            "us": "ticker 或 null"
        }},
        "ambiguity_question": "question if ambiguous, else null"
    }}

    - topics: 從 symbols 中取出非 null 的值（1-2 個）
    - ambiguity_question: 若 ambiguous，詢問使用者缺少的資訊；否則填 null

plan:
  description: "根據分類結果制定執行計畫"
  template: |
    根據以下分析結果，制定執行計畫。

    原始查詢：{query}
    主要 Agent：{agent}
    相關主題：{topics}
    使用者補充：{clarifications}

    === 預研究資料（執行計畫前已自動收集）===
    {research_summary}

    用戶對研究資料的補充需求：{research_clarifications}

    === 過往類似經驗（僅供參考）===
    {past_experience}

    可用的 Agent：
    {agents_info}

    可用的工具：
    {tools_info}

    請以 JSON 格式回覆：
    {{
        "plan": [
            {{"step": 1, "description": "步驟描述", "agent": "agent_name", "tool_hint": "tool_name_or_null"}}
        ]
    }}

    規則：
    - 每個 step 只指派一個 agent
    - agent 名稱必須從上方 Agent 列表中選擇
    - tool_hint 可以是 null（讓 agent 自己決定）
    - ⚠️ **抽象規劃與完整性原則**：
        - 請根據 **用戶的最終目標** 進行規劃。若用戶要求「評估是否適合投資」、「整體分析」或「全面觀點」，你不能只做單一或表面的查詢。
        - **動態多維度探索**：請查閱下方「可用的工具」清單，並主動規劃能涵蓋多種分析維度（例如：技術指標、總經消息、衍生品籌碼、基本面生態等）的聯合步驟。
        - **避免寫死樣板**：請依據當下可見的工具庫動態擴展步驟，將所有能提供決策價值的有意義數據（如資金費率、解鎖拋壓等）都納入計畫，以最大化分析的全面性。
        - 不要因為覺得「工具不夠」就跳過步驟；Agent 無法完成時會自行防呆拒絕。

hitl_confirm_plan:
  description: "格式化執行計畫給使用者確認"
  template: |
    以下是為您的查詢制定的執行計畫：

    查詢：{query}

    計畫步驟：
    {plan_text}

    請問是否按此計畫執行？

synthesize:
  description: "綜合所有 Agent 的結果，生成最終報告"
  template: |
    綜合以下各 Agent 的分析結果，生成一份完整的報告。

    原始查詢：{query}
    實際執行計畫：{plan_summary}
    使用者補充資訊：{clarifications}

    各 Agent 結果：
    {results}

    請用繁體中文提供一份結構清晰、重點突出的綜合報告。
    
    ⚠️ **排版風格要求 (Visual Style Requirements)**：
    1. **保留格式**：若 Agent 結果中包含 Markdown 表格、連結或清單，請**盡量保留**。
    2. **資訊面板**：使用引用區塊 (`>`) 來強調關鍵摘要、價格數據或重要結論。
    3. **Emoji 裝飾**：使用 Emoji (📊, 📰, 💡, 💰) 來區分不同板塊，使閱讀體驗更佳。
    4. **條列分明**：使用列點 (Bullet Points) 呈現細節，避免大段落文字。
    5. **連結保留**：必須保留新聞或資料來源的原始連結 `[Title](url)`。

    報告結構建議 (Hybrid Structure)：
    為了維持專業報告的一致性，同時具備彈性，請遵循以下核心結構，並**動態新增章節**來容納其他收集到的客製化資訊：
    - **💡 綜合結論**：(使用引用區塊，直接回答用戶核心問題)
    - **📊 市場數據與技術分析**：(整合技術指標與價格)
    - **📰 關鍵新聞與情緒**：(保留新聞標題連結與摘要)
    - **🌍 其他維度數據 [動態新增]**：(CRITICAL: 強制檢視「各 Agent 結果」，若結果中包含了合約多空比、總體經濟數據、基本面鎖倉等不在上述範疇內的資料，你**絕對必須**建立獨立的區塊或表格來詳述，不可遺漏！)
    - **👉 建議操作**：(基於上述所有分析的具體建議)
    最高指導原則 (Raw Data Preservation Rule)：
    1. **數據保真與呈現原則**：不論搜集到的數據屬於何種類別（如基本面數值、衍生品數據、總體經濟指標等），只要是客觀的數值或統計數據，一律必須精確呈現於報告中。
    2. **嚴禁空泛摘要**：當前置 Agent 取得了任何量化的具體數值時，你**必須明確印出這些精確的數字與計量單位**。絕對不允許使用模糊的形容詞（如「表現良好」、「數值偏低」、「存在壓力」）來掩蓋或替代原本清晰的數字資訊。挖掘到的所有量化數據，均為決策核心，嚴格禁止過濾或遺漏。

extract_memory:
  description: "從對話中萃取結構化事實，不做摘要"
  template: |
    從以下最新對話輪次中提取重要事實。只提取「明確說出的」事實，不推斷。

    使用者說：{user_message}
    助手回覆：{assistant_message}

    已存在事實（避免重複）：{existing_facts}
    當前輪次編號：{turn_index}

    請以 JSON 回覆，只包含本輪新增或更新的事實：
    {{"facts": [
      {{"key": "user_name", "value": "Danny", "source_turn": {turn_index}, "confidence": "high"}}
    ]}}

    規則：
    - 只保留「未來對話有用」的事實（使用者名稱、偏好、關注主題）
    - 不提取一次性數字（如具體價格、今日新聞）
    - key 用 snake_case 英文
    - confidence: high=使用者明確說出, medium=可推斷, low=不確定
    - 無新事實則回覆 {{"facts": []}}
    - 最多 3 個事實

negotiate_plan:
  description: "評估用戶提出的計畫修改請求，說明可行性並給出修訂計畫"
  template: |
    你是一個 AI 分析系統的規劃助手。
    用戶對以下執行計畫提出了修改請求，請評估可行性並給出回應。

    原始查詢：{query}

    當前計畫：
    {plan_text}

    === 工具執行結果 (Evidence) ===
    {tool_results}

    用戶的修改請求：{negotiation_request}

    === 可用的 Agent ===
    {agents_info}

    === 可用的工具 ===
    {tools_info}

    請輸出 JSON 格式：
    {{
        "explanation": "給用戶的說明（若有工具結果，請詳細列出重點）",
        "modified_plan": [
            {{"step": 1, "description": "步驟的完整說明文字（必填，不可為空）", "agent": "agent_name", "tool_hint": null}}
        ],
        "tool_call": {{ "name": "...", "args": {{...}} }}
    }}

    規則：
    - ⚠️ **排版風格要求 (Visual Style Requirements)**：
        1. **保留格式**：若工具結果包含 Markdown 表格或連結，請**盡量保留**。
        2. **資訊面板**：使用引用區塊 (`>`) 來強調關鍵摘要、價格數據或重要結論。
        3. **Emoji 裝飾**：使用 Emoji (📊, 📰, 💡, 💰) 來區分不同板塊。
        4. **條列分明**：使用列點 (Bullet Points) 呈現細節。
        5. **連結保留**：必須保留新聞或資料來源的原始連結 `[Title](url)`。

    - ⚠️ **最高優先級**：
        1. 若用戶詢問資訊且**工具結果為空**或**不相關**，**必須**回傳 `tool_call` 重新查詢。
        2. 若**工具執行結果**已包含用戶所需資訊，則**不要**再呼叫工具，直接在 `explanation` 中詳細回答。
    - **關於回答 (Explanation)**：
        - 若 `tool_results` 有內容，**必須**詳細列出（使用列點 bullet points），保留具體數字、日期、標題。
        - 不要只說「已查詢」，要實際列出查詢結果。
        - 若工具結果顯示的資產與原計畫不同，以當前結果為準回答。
    - 關於修改計畫：
        - 根據用戶請求調整計畫。
        - 如果用戶只是想**增加**或**深入**，請保留原計畫。

retry_scope:
  description: "判斷重試範圍"
  template: |
    使用者對分析結果不滿意，需要判斷重試範圍。

    原始查詢：{query}
    使用者反饋：{feedback}

    之前的計畫：
    {plan_text}

    各步驟結果：
    {results}

    請判斷需要重做哪些步驟：
    {{
        "scope": "partial|full_replan",
        "steps_to_retry": [1, 2]
    }}

    規則：
    - partial: 只重做部分步驟（大多數情況）
    - full_replan: 完全重新規劃（僅在使用者需求根本改變時使用）
