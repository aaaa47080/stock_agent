classify:
  description: "分析使用者查詢，選擇最適合的 Agent"
  template: |
    你是一個多功能 AI 助手系統的管理者。
    根據使用者查詢，從下方 Agent 清單中選擇最合適的 Agent 處理。

    === 近期對話歷史（供上下文參考）===
    {history}

    使用者查詢：{query}

    === 可用的 Agent ===
    {agents_info}

    === 可用的工具 ===
    {tools_info}

    **選擇規則（intent 只填 Agent 名稱：tw_stock / us_stock / crypto / chat）：**
    1. 台股相關（含股票代號如 2330、公司名稱如台積電、聯發科，或明確提到台股/上市/上櫃）→ tw_stock
    2. 加密貨幣相關（BTC/ETH/SOL 等，包含詢問即時價格）→ crypto
    3. 美股相關（NYSE/NASDAQ ticker）→ us_stock
    4. 一般閒聊、平台功能說明、其他無關財經的問題 → chat
    5. 查詢模糊且缺少必要資訊且無法從歷史推斷 → ambiguous；若是對話延續則從歷史推斷意圖，不設 ambiguous

    **complexity 判斷（以專業經理人角度，根據查詢的本質做出判斷）：**
    - simple：查詢只需要**單一維度的資訊**即可完整回應（如取得一個數字、確認一個事實、單一類型的資料查詢）
    - complex：查詢需要**跨多個維度整合分析**才能形成判斷或建議
      → 判斷原則：若完整回應需要整合兩種以上的分析面向（技術指標、基本面、消息面、市場情緒等），或需要對投資價值、前景、風險做出綜合評估，則為 complex
      ⚠️ 強制規則：只要使用者詢問某標的「是否適合投資」、「可否買進/進場」、「幫我分析」等涉及決策評估的問題，一律強制判定為 `complex`，不可判定為 `simple`！
    - ambiguous：缺少必要資訊且無法從歷史推斷

    **symbols 萃取規則（在輸出 JSON 前先完成此步驟）：**
    從查詢文字與對話歷史中，識別各市場的金融標的，並轉換成標準格式：

    1. crypto（加密貨幣）：
       - 識別幣種名稱或縮寫，轉成標準 ticker 大寫
       - 範例："PI NETWORK" → "PI"、"比特幣" → "BTC"、"以太坊" → "ETH"
    2. tw（台股）：
       - 識別台灣上市/上櫃公司名稱或股票代號，轉成 Yahoo Finance 格式 代號.TW
       - 範例："台積電" → "2330.TW"、"聯發科" → "2454.TW"、"鴻海" → "2317.TW"、"2330" → "2330.TW"
    3. us（美股）：
       - 識別美股公司名稱或 ticker，轉成大寫 ticker
       - 範例："蘋果" → "AAPL"、"特斯拉" → "TSLA"、"台積電ADR" → "TSM"
       - ⚠️「美超微」「美超微電腦」「超微電腦」= Super Micro Computer = "SMCI"（伺服器廠商）
       - ⚠️「超微」「超微半導體」= Advanced Micro Devices = "AMD"（注意：SMCI ≠ AMD）
    4. 代詞處理：查詢中出現「它」「他」「這個幣」「這支股票」等代詞時，從對話歷史推斷所指標的
    5. 無標的 → 回傳 null（禁止猜測或亂填，寧可 null 也不要填錯）

    请以 JSON 格式回覆：
    {{
        "complexity": "simple|complex|ambiguous",
        "intent": "從上方 Agent 列表中選擇一個名稱",
        "topics": [],
        "symbols": {{
            "crypto": "ticker 或 null",
            "tw": "代號.TW 或 null",
            "us": "ticker 或 null"
        }},
        "ambiguity_question": "question if ambiguous, else null",
        "replan_request": false
    }}

    - topics: 從 symbols 中取出非 null 的值（1-2 個）
    - ambiguity_question: 若 ambiguous，詢問使用者缺少的資訊；否則填 null
    - replan_request: 若使用者明確要求重新規劃（如「重新規劃」「依照討論規劃」「開始分析」「按討論的做」「依照剛才說的分析」），設為 true；其他情況設為 false

pre_research_question:
  description: "自動收集資料後，產生引導使用者後續分析方向的問句"
  template: |
    你是一個 AI 分析助手。使用者剛才詢問：「{query}」。
    我們已經自動收集了 {symbol} 的初步資料：
    {research_summary}

    請用繁體中文生成一句簡短、友善、對話式的問句（約 20-30 字），引導使用者接下來要聚焦分析哪個方向？（例如：如果他問價格，你可以問是否要深入看技術支撐位；如果他問新聞，可以問是否要分析市場情緒）
    並在句末提醒「若無特定方向，直接留空確認即可」。
    只回傳預期輸出的那句話，不要任何多餘的引言或解釋。

pre_research_intent:
  description: "判斷使用者在預先收集資料階段的回覆意圖"
  template: |
    你是一個意圖分析助手。根據使用者在「初步資料確認階段」的回覆，判斷其意圖。

    當前正在分析的標的：{symbol}
    使用者回覆：{user_input}

    判斷規則：
    1. 若表示同意、可以直接建立計畫（例如：好、可以、沒問題、ok、確認、開始規劃），回傳：confirm
    2. 若是針對當前標的提出問題、想要從目前的資料中得知答案（例如：分析得如何？有什麼風險？），回傳：question
    3. 若是給予當前標的新的分析方向、過濾條件或補充資訊（例如：幫我著重看基本面、只看技術指標），回傳：direction
    4. 若是提出與當前標的完全無關的全新問題，或是要求分析另一個全新的標的（例如當前是PI，卻問BTC適合買嗎？），回傳：new_topic
    
    如果使用者輸入空白，請判定為 confirm。
    只回覆一個詞：confirm, question, direction, 或是 new_topic。

research_question_probe:
  description: "嘗試根據預先收集的資料回答使用者問題，若不足則觸發搜尋"
  template: |
    以下是關於 {symbol} 的即時市場資料：

    {research_summary}

    用戶問題：{question}

    若上述資料已足夠回答問題，請直接回答（繁體中文）。
    若資料不足（例如問及總發行量、市值、白皮書、開發團隊等標準工具未涵蓋的資訊），
    請只回覆 JSON：{{"need_search": true, "search_query": "具體搜尋關鍵字"}}

research_question_final:
  description: "根據網路搜尋結果回答使用者問題"
  template: |
    用戶問：{question}

    網路搜尋結果：
    {search_result}

    請根據搜尋結果用繁體中文回答，若有連結請保留 Markdown 格式 [標題](url)。

extract_symbol:
  description: "從對話歷史與查詢中提取分析目標代號"
  template: |
    從以下文字中提取金融資產的交易代號（ticker），包含加密貨幣（如 BTC、ETH、SOL）
    或股票（如 AAPL、INTC、TSLA、2330）。
    只回覆 ticker 本身（純英文大寫縮寫或數字代號），不要其他文字。
    若無法識別，直接回覆原文字。

    文字：{candidate}

confirm_intent:
  description: "判斷使用者在計畫確認階段的意圖"
  template: |
    當前分析計畫：
    {plan_text}

    使用者輸入：{text}

    判斷使用者意圖，只回覆以下一個詞：
    - question：詢問資訊、意見或問題（包含計畫相關問題、市場數據、計畫優缺點等）
    - modify：明確要求修改計畫步驟（如移除、新增、替換某步驟）
    - confirm：確認執行計畫
    - cancel：取消計畫

    只回覆一個詞，不加任何標點或說明。

plan:
  description: "根據分類結果制定執行計畫"
  template: |
    根據以下分析結果，制定執行計畫。

    原始查詢：{query}
    主要 Agent：{agent}
    相關主題：{topics}
    使用者補充：{clarifications}
    Reflection 建議（前次計畫被拒原因，若有請修正）：{reflection_suggestion}
    討論摘要（若使用者在計畫確認前有問答，請融合這些資訊進行規劃）：{discussion_summary}

    === 預研究資料（執行計畫前已自動收集）===
    {research_summary}

    用戶對研究資料的補充需求：{research_clarifications}

    === 過往類似經驗（僅供參考）===
    {past_experience}

    可用的 Agent：
    {agents_info}

    可用的工具：
    {tools_info}

    請以 JSON 格式回覆：
    {{
        "plan": [
            {{"step": 1, "description": "步驟描述", "agent": "agent_name", "tool_hint": "tool_name_or_null"}}
        ]
    }}

    規則：
    - agent 必須從上方 Agent 列表中選擇，每個 step 只指派一個 agent
    - tool_hint 可為 null（讓 agent 自己決定）或指定具體工具名稱
    - description **只寫一句話（10~30 字）**，格式：「查詢/分析 [標的] 的 [具體資料類型]」，例如「查詢 BTC 技術指標（RSI/MACD/均線）」、「取得 BTC 最新新聞與市場情緒」
    - 步驟數量 2～4 個（單一維度查詢可 1 步；跨市場才需要不同 agent）
    - chat agent 僅用於閒聊/問答，**不得**出現在多步驟計畫中

hitl_confirm_plan:
  description: "格式化執行計畫給使用者確認"
  template: |
    以下是為您的查詢制定的執行計畫：

    查詢：{query}

    計畫步驟：
    {plan_text}

    請問是否按此計畫執行？

synthesize:
  description: "綜合所有 Agent 的結果，生成最終報告"
  template: |
    根據以下各 Agent 的分析結果，直接回答用戶問題，產出一份簡潔、可執行的報告。

    原始查詢：{query}
    使用者補充資訊：{clarifications}

    各 Agent 結果：
    {results}

    ═══ 撰寫規則（必須嚴格遵守）═══

    【靜默略過原則（最重要）】
    - 若某項數據未能取得（工具回傳空值、找不到數據、N/A），**完全不提及**，直接略過。
    - **嚴禁** 出現以下類型的文字：「資料缺口」「未能取得」「找不到」「暫無」「建議補足」「缺乏數據」「無法確認」等。
    - 報告只呈現**確實取得的數據**，用手頭有的資料做出判斷。

    【直接回答原則】
    - 報告第一段必須直接回答用戶核心問題（如「目前適合/不適合/觀望」），給出明確立場，不含糊其詞。
    - 結論必須基於已有數據，不需等待更多資料才能給出判斷。

    【排版規則】
    - 使用引用區塊 (`>`) 強調核心結論與關鍵數字
    - 使用列點呈現細節，避免大段落文字
    - 保留新聞標題連結 `[Title](url)`
    - 具體數字必須精確呈現（如 RSI 52.3，不能寫「RSI 中性」）

    【報告結構】（只建立有實際內容的章節，無內容就省略）
    - **💡 綜合結論**（必有，使用引用區塊，直接回答原始問題）
    - **📊 技術面**（有技術指標才建立）
    - **📰 新聞與情緒**（有新聞才建立，保留連結）
    - **🪙 代幣/基本面**（有代幣數據才建立）
    - **👉 建議操作**（必有，給出具體可執行的建議，含關鍵止損/觀察價位）

extract_memory:
  description: "從對話中萃取結構化事實，不做摘要"
  template: |
    從以下最新對話輪次中提取重要事實。只提取「明確說出的」事實，不推斷。

    使用者說：{user_message}
    助手回覆：{assistant_message}

    已存在事實（避免重複）：{existing_facts}
    當前輪次編號：{turn_index}

    請以 JSON 回覆，只包含本輪新增或更新的事實：
    {{"facts": [
      {{"key": "user_name", "value": "Danny", "source_turn": {turn_index}, "confidence": "high"}}
    ]}}

    規則：
    - 只保留「未來對話有用」的事實（使用者名稱、偏好、關注主題）
    - 不提取一次性數字（如具體價格、今日新聞）
    - key 用 snake_case 英文
    - confidence: high=使用者明確說出, medium=可推斷, low=不確定
    - 無新事實則回覆 {{"facts": []}}
    - 最多 3 個事實

negotiate_plan:
  description: "評估用戶提出的計畫修改請求，說明可行性並給出修訂計畫"
  template: |
    你是一個 AI 分析系統的規劃助手。
    用戶對以下執行計畫提出了修改請求，請評估可行性並給出回應。

    原始查詢：{query}

    當前計畫：
    {plan_text}

    === 工具執行結果 (Evidence) ===
    {tool_results}

    用戶的修改請求：{negotiation_request}

    === 可用的 Agent ===
    {agents_info}

    === 可用的工具 ===
    {tools_info}

    請輸出 JSON 格式：
    {{
        "explanation": "給用戶的說明（若有工具結果，請詳細列出重點）",
        "modified_plan": [
            {{"step": 1, "description": "步驟的完整說明文字（必填，不可為空）", "agent": "agent_name", "tool_hint": null}}
        ],
        "tool_call": {{ "name": "...", "args": {{...}} }}
    }}

    規則：
    - **排版**：保留 Markdown 表格/連結，用引用區塊 (`>`) 強調關鍵數據，用列點呈現細節
    - **處理邏輯（依序）**：
      1. 用戶問事實（現價/新聞等）且 `tool_results` 為空 → 回傳 `tool_call`，`modified_plan` 不動
      2. 用戶問事實且 `tool_results` 有答案 → 在 `explanation` 列出結果（具體數字+連結），不呼叫工具，`modified_plan` 不動
      3. 用戶明確要求修改計畫（移除/新增/替換步驟）→ 修改 `modified_plan`，不呼叫工具
    - **description 格式**：必須含英文 ticker（如「查詢 SMCI 的即時股價」），不能只寫中文名稱

retry_scope:
  description: "判斷重試範圍"
  template: |
    使用者對分析結果不滿意，需要判斷重試範圍。

    原始查詢：{query}
    使用者反饋：{feedback}

    之前的計畫：
    {plan_text}

    各步驟結果：
    {results}

    請判斷需要重做哪些步驟：
    {{
        "scope": "partial|full_replan",
        "steps_to_retry": [1, 2]
    }}

    規則：
    - partial: 只重做部分步驟（大多數情況）
    - full_replan: 完全重新規劃（僅在使用者需求根本改變時使用）

reflect_plan:
  description: "審核計畫是否真的回答了使用者查詢"
  template: |
    你是一個計畫品質審核員。嚴格判斷以下執行計畫是否真的能回答使用者的查詢。

    使用者查詢：{query}
    對話歷史：{history}
    提取的主題（標的）：{topics}
    使用者澄清補充：{clarifications}
    上一輪建議（若有）：{previous_suggestion}

    執行計畫：
    {plan_text}

    可用的 Agent：
    {agents_info}

    **審核標準：**
    1. 標的正確性：計畫中使用的 agent 和 symbol 是否對應查詢中的資產？
       （例如：用戶問 INTC 但計畫查 AMD → 不通過）
    2. 問題覆蓋性：步驟加總是否能回答用戶的核心問題？
       （例如：用戶問「值得買嗎」但計畫只查新聞，沒有技術面 → 不通過）
    3. 步驟合理性：步驟數量和描述是否清晰合理？（1-6 步為宜）
    4. ⚠️ 禁止末尾有 chat 總結步驟：若計畫最後一步是「由 chat 綜合/總結前述結果」，必須拒絕並要求移除（系統自動合成，不需此步驟）。
    5. description 格式正確性：每個步驟的 description 是否為簡短的資料查詢/分析動作（一句話）？若 description 包含流程設計、合規說明、schema 欄位列舉或超過 60 字，必須拒絕。

    回覆 JSON 格式（不加任何其他文字）：
    {{
        "approved": true 或 false,
        "reason": "一句話說明通過或不通過的原因",
        "suggestion": "若不通過，給規劃節點的具體改善建議（通過則填 null）"
    }}

discuss:
  description: "討論模式：在計畫確認前，回答使用者的任何問題（含工具呼叫）"
  template: |
    你是一個 AI 分析助手。使用者在決定是否執行以下分析計畫前，想先詢問一些問題。

    原始分析請求：{query}

    待執行計畫（供參考）：
    {plan_text}

    對話歷史：{history}

    可用工具：{tools_info}

    使用者提問：{question}

    === 工具執行結果（若已呼叫）===
    {tool_results}

    **回答規則（依序判斷）：**

    1. 若問題需要即時市場數據（股價、新聞、技術指標、機構持倉等）且工具結果為空：
       ⛔ 禁止說「稍等」或「將為您查詢」
       ✅ 立即回傳 `tool_call`，選擇 `可用工具` 中最適合的工具

    2. 若問題是關於計畫設計或分析邏輯（如「為什麼要分析機構持倉？」「這樣排有什麼優點？」）：
       ✅ 直接解釋計畫的設計理由，不需要呼叫工具

    3. 若工具結果已包含答案：
       ✅ 在 answer 中詳細列出（使用列點，保留具體數字和 Markdown 連結）

    回覆 JSON 格式（不加其他文字）：
    {{
        "answer": "繁體中文回答（Markdown 格式，若有連結保留 [標題](url)）",
        "tool_call": {{"name": "工具名稱", "args": {{...}}}} 或 null
    }}
