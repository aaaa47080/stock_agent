<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi Crypto Insight - AI 投資分析</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="glass-card h-16 flex items-center justify-between px-6 z-10">
        <div class="flex items-center gap-2">
            <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-900/20">
                <i data-lucide="trending-up" class="text-white w-6 h-6"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg leading-tight">Pi Crypto <span class="text-blue-500">Insight</span></h1>
                <p id="api-status-indicator" class="text-xs text-slate-400 flex items-center gap-1">
                    <span class="w-2 h-2 bg-slate-500 rounded-full"></span> <span id="api-status-text">檢查中...</span>
                </p>
            </div>
        </div>
        
        <!-- Global Asset Filter Button -->
        <button onclick="openGlobalFilter()" class="hidden md:flex items-center gap-2 bg-slate-800/50 hover:bg-slate-700 border border-slate-700 px-4 py-2 rounded-full transition group">
            <div class="w-2 h-2 rounded-full bg-blue-500 group-hover:animate-ping"></div>
            <span class="text-xs font-medium text-slate-300">關注資產: <span id="global-count-badge" class="text-white font-bold">自動</span></span>
            <i data-lucide="chevron-down" class="w-3 h-3 text-slate-500"></i>
        </button>

        <div class="flex items-center gap-2">
            <button onclick="location.reload()" class="p-2 bg-slate-800/50 hover:bg-slate-700 rounded-full border border-slate-700 transition text-slate-400 hover:text-white" title="重新整理頁面">
                <i data-lucide="rotate-cw" class="w-4 h-4"></i>
            </button>
            <div id="pi-user" class="text-sm bg-slate-800/50 px-3 py-1.5 rounded-full border border-slate-700 hidden">
                <!-- Pi Username will appear here -->
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex overflow-hidden">
        
        <!-- Sidebar (Desktop) / Bottom Nav (Mobile) -->
        <nav class="w-24 glass-card flex flex-col items-center py-6 gap-4 hidden md:flex">
            <!-- AI 功能（需要 LLM Key） -->
            <div class="flex flex-col items-center gap-2">
                <button onclick="switchTab('chat')" class="nav-btn active group text-blue-500 relative" title="AI 聊天分析（需要 LLM Key）">
                    <i data-lucide="bot" class="w-7 h-7"></i>
                    <div class="absolute -bottom-1 -right-1 w-3 h-3 bg-purple-500 rounded-full border-2 border-slate-900 flex items-center justify-center">
                        <i data-lucide="zap" class="w-2 h-2 text-white"></i>
                    </div>
                </button>
                <span class="text-[10px] text-slate-500">AI 分析</span>
            </div>

            <!-- 分隔線 -->
            <div class="w-12 h-px bg-slate-700/50"></div>

            <!-- 公開功能（不需要 Key） -->
            <div class="flex flex-col items-center gap-2">
                <button onclick="switchTab('pulse')" class="nav-btn group text-slate-400 hover:text-blue-400 relative" title="市場脈動（公開）">
                    <i data-lucide="activity" class="w-7 h-7"></i>
                    <div class="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-slate-900 flex items-center justify-center">
                        <i data-lucide="globe" class="w-2 h-2 text-white"></i>
                    </div>
                </button>
                <span class="text-[10px] text-slate-500">脈動</span>
            </div>

            <div class="flex flex-col items-center gap-2">
                <button onclick="switchTab('market')" class="nav-btn group text-slate-400 hover:text-blue-400 relative" title="領先幣種（公開）">
                    <i data-lucide="trending-up" class="w-7 h-7"></i>
                    <div class="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-slate-900 flex items-center justify-center">
                        <i data-lucide="globe" class="w-2 h-2 text-white"></i>
                    </div>
                </button>
                <span class="text-[10px] text-slate-500">行情</span>
            </div>

            <!-- 分隔線 -->
            <div class="w-12 h-px bg-slate-700/50"></div>

            <!-- 資產功能（需要 OKX Key） -->
            <div class="flex flex-col items-center gap-2">
                <button onclick="switchTab('assets')" class="nav-btn group text-slate-400 hover:text-blue-400 relative" title="資產管理（需要 OKX Key）">
                    <i data-lucide="wallet" class="w-7 h-7"></i>
                    <div class="absolute -bottom-1 -right-1 w-3 h-3 bg-amber-500 rounded-full border-2 border-slate-900 flex items-center justify-center">
                        <i data-lucide="key" class="w-2 h-2 text-white"></i>
                    </div>
                </button>
                <span class="text-[10px] text-slate-500">資產</span>
            </div>

            <!-- 設定（底部） -->
            <button onclick="switchTab('settings')" class="mt-auto nav-btn text-slate-400 hover:text-blue-400" title="系統設定">
                <i data-lucide="settings" class="w-7 h-7"></i>
            </button>
        </nav>

        <!-- Chat Area -->
        <div id="chat-tab" class="flex-1 flex flex-col relative bg-[#0f172a]">
            <!-- Chat Header Actions -->
            <div class="absolute top-4 right-4 z-10">
                <button onclick="clearChat()" class="p-2 bg-slate-800/80 hover:bg-slate-700 backdrop-blur-sm border border-slate-700 rounded-lg text-slate-400 hover:text-red-400 transition shadow-lg" title="清除對話紀錄">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>

            <!-- Messages Container -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 md:p-8 custom-scrollbar space-y-4">
                <!-- Welcome Message -->
                <div class="bot-message message-bubble prose">
                    <h3 class="flex items-center gap-2"><i data-lucide="bot" class="w-5 h-5"></i> 歡迎使用 Pi Crypto Insight</h3>
                    <p>我是您的 AI 投資助手。您可以輸入加密貨幣代號（如 BTC, ETH, PI），我將為您進行深度分析。</p>

                    <!-- 功能說明 -->
                    <div class="my-3 p-3 bg-slate-800/50 border border-slate-700 rounded-lg">
                        <p class="text-slate-300 text-xs m-0 mb-2"><strong>側邊欄功能說明：</strong></p>
                        <div class="flex flex-col gap-1.5 text-xs">
                            <div class="flex items-center gap-2">
                                <span class="w-2.5 h-2.5 bg-purple-500 rounded-full"></span>
                                <span class="text-slate-400">紫色 = 需要 LLM API Key（OpenAI/Gemini/OpenRouter）</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-2.5 h-2.5 bg-green-500 rounded-full"></span>
                                <span class="text-slate-400">綠色 = 公開功能（無需 API Key）</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-2.5 h-2.5 bg-amber-500 rounded-full"></span>
                                <span class="text-slate-400">黃色 = 需要 OKX API Key（查看資產）</span>
                            </div>
                        </div>
                    </div>

                    <!-- 風險警告 -->
                    <div class="my-3 p-3 bg-amber-900/20 border border-amber-500/30 rounded-lg">
                        <p class="text-amber-400 text-xs flex items-start gap-2 m-0">
                            <i data-lucide="alert-triangle" class="w-4 h-4 mt-0.5 shrink-0"></i>
                            <span><strong>風險警告：</strong>加密貨幣投資具有高度風險，價格波動劇烈。本工具提供的分析僅供參考，不構成任何投資建議。請根據自身風險承受能力謹慎決策，切勿投入超過您能承受損失的資金。</span>
                        </p>
                    </div>

                    <!-- 建議按鈕區域（需要 API key 才顯示） -->
                    <div id="suggestions-area" class="hidden">
                        <p>試試點擊下方的建議：</p>
                        <div class="flex wrap gap-2 mt-2">
                            <button onclick="quickAsk('PIUSDT 可以投資嗎？')" class="px-3 py-1 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs border border-slate-700 transition">Pi Network (PI) 分析</button>
                            <button onclick="quickAsk('比特幣現在適合買入嗎？')" class="px-3 py-1 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs border border-slate-700 transition">BTC 行情預測</button>
                            <button onclick="quickAsk('比較 ETH 和 SOL')" class="px-3 py-1 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs border border-slate-700 transition">幣種對比</button>
                        </div>
                    </div>

                    <!-- API Key 未設置提示（沒有 key 時顯示） -->
                    <div id="api-key-warning" class="hidden my-4 p-4 bg-blue-900/20 border border-blue-500/30 rounded-lg">
                        <p class="text-blue-400 text-sm flex items-start gap-2 m-0">
                            <i data-lucide="info" class="w-5 h-5 mt-0.5 shrink-0"></i>
                            <span><strong>請先設置 API Key：</strong>要使用 AI 分析功能，請先點擊右上角設定圖標 <i data-lucide="settings" class="w-4 h-4 inline"></i>，輸入您的 OpenAI、Google Gemini 或 OpenRouter API Key。</span>
                        </p>
                        <button onclick="switchTab('settings')" class="mt-3 w-full bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg transition flex items-center justify-center gap-2">
                            <i data-lucide="settings" class="w-4 h-4"></i>
                            前往設置 API Key
                        </button>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 md:p-6 bg-gradient-to-t from-[#0f172a] to-transparent">
                <div class="max-w-4xl mx-auto glass-card rounded-2xl p-1 shadow-2xl transition-all duration-300" id="input-container">
                    
                    <!-- Input Row -->
                    <div class="flex items-center gap-2 p-2">
                        <button onclick="toggleOptions()" class="p-3 text-slate-400 hover:text-blue-400 transition bg-slate-800/50 hover:bg-slate-700 rounded-xl" title="分析設定">
                            <i data-lucide="sliders-horizontal" class="w-6 h-6"></i>
                        </button>
                        <input type="text" id="user-input" 
                            class="flex-1 bg-transparent border-none focus:ring-0 text-slate-200 placeholder-slate-500 text-sm md:text-base py-3"
                            placeholder="請輸入您的問題..."
                            onkeypress="if(event.key === 'Enter') sendMessage()">
                        <button onclick="sendMessage()" id="send-btn"
                            class="bg-blue-600 hover:bg-blue-500 text-white p-3 rounded-xl transition shadow-lg shadow-blue-600/20">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <!-- Analysis Options Panel (Hidden by default) -->
                    <div id="analysis-options-panel" class="hidden border-t border-slate-700/50 p-3 animate-in slide-in-from-top-2 duration-200">
                        <div class="text-xs text-slate-500 mb-2 font-medium px-1">選擇分析模組 (留空則自動判斷):</div>
                        <div class="flex flex-wrap gap-2">
                            <label class="flex items-center gap-2 cursor-pointer bg-slate-800/40 px-3 py-2 rounded-lg border border-slate-700 hover:bg-slate-700/60 transition select-none">
                                <input type="checkbox" class="analysis-checkbox form-checkbox h-4 w-4 text-blue-500 rounded bg-slate-700 border-slate-600 focus:ring-offset-slate-800" value="Technical Analysis">
                                <span class="text-xs text-slate-300">技術分析</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer bg-slate-800/40 px-3 py-2 rounded-lg border border-slate-700 hover:bg-slate-700/60 transition select-none">
                                <input type="checkbox" class="analysis-checkbox form-checkbox h-4 w-4 text-blue-500 rounded bg-slate-700 border-slate-600 focus:ring-offset-slate-800" value="News Analysis">
                                <span class="text-xs text-slate-300">新聞分析</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer bg-slate-800/40 px-3 py-2 rounded-lg border border-slate-700 hover:bg-slate-700/60 transition select-none">
                                <input type="checkbox" class="analysis-checkbox form-checkbox h-4 w-4 text-blue-500 rounded bg-slate-700 border-slate-600 focus:ring-offset-slate-800" value="Fundamental Analysis">
                                <span class="text-xs text-slate-300">基本面</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer bg-slate-800/40 px-3 py-2 rounded-lg border border-slate-700 hover:bg-slate-700/60 transition select-none">
                                <input type="checkbox" class="analysis-checkbox form-checkbox h-4 w-4 text-blue-500 rounded bg-slate-700 border-slate-600 focus:ring-offset-slate-800" value="Sentiment Analysis">
                                <span class="text-xs text-slate-300">情緒分析</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer bg-slate-800/40 px-3 py-2 rounded-lg border border-amber-500/30 hover:bg-amber-900/10 transition select-none">
                                <input type="checkbox" id="check-trading-decision" class="analysis-checkbox form-checkbox h-4 w-4 text-amber-500 rounded bg-slate-700 border-slate-600 focus:ring-offset-slate-800" value="Full Trading Decision">
                                <span class="text-xs text-amber-400 font-medium">交易決策</span>
                            </label>
                        </div>

                        <!-- New: Execution Options -->
                        <div class="mt-4 pt-3 border-t border-slate-700/30 flex flex-wrap items-center gap-4">
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-slate-500 font-medium">交易市場:</span>
                                <select id="select-market-type" class="bg-slate-800 text-xs border border-slate-700 rounded px-2 py-1 text-slate-300 outline-none focus:border-blue-500">
                                    <option value="spot">現貨 (Spot)</option>
                                    <option value="futures">合約 (Futures)</option>
                                </select>
                            </div>

                            <label class="flex items-center gap-2 cursor-pointer group">
                                <div class="relative">
                                    <input type="checkbox" id="toggle-auto-execute" class="sr-only peer">
                                    <div class="w-8 h-4 bg-slate-700 rounded-full peer peer-checked:bg-green-600 transition-colors"></div>
                                    <div class="absolute left-0.5 top-0.5 w-3 h-3 bg-white rounded-full transition-transform peer-checked:translate-x-4"></div>
                                </div>
                                <span class="text-xs text-slate-400 group-hover:text-green-400 transition">自動執行交易</span>
                                <i data-lucide="info" class="w-3 h-3 text-slate-600" title="開啟後，AI 若建議買入且經理批准，將自動下單 (僅限 OKX)"></i>
                            </label>
                        </div>
                    </div>

                </div>
                <p class="text-[10px] text-center text-slate-500 mt-3 uppercase tracking-widest">Powered by AI Agent System & Pi Network</p>
            </div>
        </div>

        <!-- Market Tab (Hidden by default) -->
        <div id="market-tab" class="hidden flex-1 flex flex-col p-6 overflow-y-auto custom-scrollbar">
            <div class="max-w-6xl mx-auto w-full">
                
                <div class="flex justify-between items-end mb-8">
                    <div>
                        <h2 class="text-2xl font-bold">市場篩選器</h2>
                        <p class="text-slate-400">根據 RSI 與漲幅挑選優質幣種 <span id="screener-last-updated" class="text-xs text-slate-500 ml-2"></span></p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openGlobalFilter()" class="flex items-center gap-2 bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg border border-slate-600 transition">
                            <i data-lucide="filter" class="w-4 h-4"></i> 篩選資產
                        </button>
                        <button onclick="openBacktestModal()" class="flex items-center gap-2 bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg border border-slate-600 transition">
                            <i data-lucide="history" class="w-4 h-4"></i> 回測工具
                        </button>
                        <button onclick="refreshScreener(true)" class="flex items-center gap-2 bg-blue-600/20 text-blue-400 px-4 py-2 rounded-lg border border-blue-500/30 hover:bg-blue-600/30 transition">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i> 重新整理
                        </button>
                    </div>
                </div>

                <!-- Active Filter Indicator -->
                <div id="active-filter-indicator" class="hidden mb-4 flex items-center gap-2 bg-blue-900/20 border border-blue-500/30 text-blue-300 px-4 py-2 rounded-lg text-sm">
                    <i data-lucide="check-circle" class="w-4 h-4"></i>
                    <span>已套用全域關注: <span id="filter-count" class="font-bold text-white">0</span> 個幣種</span>
                    <button onclick="clearGlobalFilter()" class="ml-auto text-slate-400 hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Top Performers -->
                    <div class="glass-card rounded-2xl p-5">
                        <h3 class="flex items-center gap-2 font-semibold mb-4 text-green-400">
                            <i data-lucide="rocket" class="w-5 h-5"></i> 領漲幣種 (24H)
                        </h3>
                        <div id="top-list" class="space-y-3">
                            <div class="animate-pulse flex space-y-4">載入中...</div>
                        </div>
                    </div>
                    <!-- Oversold -->
                    <div class="glass-card rounded-2xl p-5">
                        <h3 class="flex items-center gap-2 font-semibold mb-4 text-orange-400">
                            <i data-lucide="trending-down" class="w-5 h-5"></i> 超賣區域 (RSI 14 &lt; 40)
                        </h3>
                        <div id="oversold-list" class="space-y-3">
                            <div class="animate-pulse flex space-y-4">載入中...</div>
                        </div>
                    </div>
                    <!-- Overbought -->
                    <div class="glass-card rounded-2xl p-5">
                        <h3 class="flex items-center gap-2 font-semibold mb-4 text-red-400">
                            <i data-lucide="alert-triangle" class="w-5 h-5"></i> 超買區域 (RSI 14 &gt; 70)
                        </h3>
                        <div id="overbought-list" class="space-y-3">
                            <div class="animate-pulse flex space-y-4">載入中...</div>
                        </div>
                    </div>
                </div>

                <!-- Funding Rate Section -->
                <div class="mt-6">
                    <div class="flex items-center gap-2 mb-4">
                        <h3 class="text-lg font-bold flex items-center gap-2">
                            <i data-lucide="percent" class="w-5 h-5 text-purple-400"></i> 資金費率
                        </h3>
                        <span class="text-xs text-slate-500 bg-slate-800 px-2 py-1 rounded">永續合約</span>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- High Funding Rate (Bullish Crowded) -->
                        <div class="glass-card rounded-2xl p-5">
                            <h3 class="flex items-center gap-2 font-semibold mb-2 text-red-400">
                                <i data-lucide="trending-up" class="w-5 h-5"></i> 多頭擁擠 (高資金費率)
                            </h3>
                            <p class="text-[10px] text-slate-500 mb-4">費率過高代表做多成本高，可能有回調風險</p>
                            <div id="high-funding-list" class="space-y-3">
                                <div class="animate-pulse flex space-y-4">載入中...</div>
                            </div>
                        </div>
                        <!-- Low Funding Rate (Bearish Crowded) -->
                        <div class="glass-card rounded-2xl p-5">
                            <h3 class="flex items-center gap-2 font-semibold mb-2 text-green-400">
                                <i data-lucide="trending-down" class="w-5 h-5"></i> 空頭擁擠 (負資金費率)
                            </h3>
                            <p class="text-[10px] text-slate-500 mb-4">負費率代表做空成本高，可能有軋空機會</p>
                            <div id="low-funding-list" class="space-y-3">
                                <div class="animate-pulse flex space-y-4">載入中...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Assets Tab -->
        <div id="assets-tab" class="hidden flex-1 flex flex-col p-6 overflow-y-auto custom-scrollbar">
            <div class="max-w-4xl mx-auto w-full">
                <div class="flex justify-between items-end mb-8">
                    <div>
                        <h2 class="text-2xl font-bold flex items-center gap-2">
                            <i data-lucide="wallet" class="w-6 h-6 text-green-400"></i> 我的資產
                        </h2>
                        <p class="text-slate-400">查看您的帳戶餘額與持倉狀態</p>
                    </div>
                    <button onclick="refreshAssets()" class="flex items-center gap-2 bg-green-600/20 text-green-400 px-4 py-2 rounded-lg border border-green-500/30 hover:bg-green-600/30 transition">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i> 刷新
                    </button>
                </div>

                <!-- Total Equity Card -->
                <div class="glass-card rounded-2xl p-6 mb-8 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-8 opacity-10 transform translate-x-4 -translate-y-4 group-hover:scale-110 transition duration-700">
                        <i data-lucide="pie-chart" class="w-32 h-32 text-green-400"></i>
                    </div>
                    <h3 class="text-sm font-medium text-slate-400 mb-1">總資產估值 (USDT)</h3>
                    <div class="flex items-baseline gap-2">
                        <span class="text-4xl font-bold text-white tracking-tight" id="total-equity">0.00</span>
                        <span class="text-sm text-slate-500">≈ $0.00 USD</span>
                    </div>
                    <div class="mt-4 flex gap-4 text-xs text-slate-400">
                        <div class="flex items-center gap-1">
                            <i data-lucide="clock" class="w-3 h-3"></i> <span id="asset-update-time">--:--</span>
                        </div>
                    </div>
                </div>

                <!-- Asset Breakdown -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <!-- Spot Assets -->
                    <div class="glass-card rounded-xl p-5">
                        <h3 class="font-semibold mb-4 flex items-center gap-2">
                            <i data-lucide="coins" class="w-4 h-4 text-blue-400"></i> 現貨餘額
                        </h3>
                        <div id="spot-assets-list" class="space-y-3">
                            <div class="animate-pulse text-slate-500 text-sm">載入中...</div>
                        </div>
                    </div>
                    
                    <!-- Positions Summary -->
                    <div class="glass-card rounded-xl p-5">
                        <h3 class="font-semibold mb-4 flex items-center gap-2">
                            <i data-lucide="layers" class="w-4 h-4 text-purple-400"></i> 持倉分佈
                        </h3>
                        <div id="positions-summary" class="space-y-3">
                             <div class="animate-pulse text-slate-500 text-sm">載入中...</div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Positions Table -->
                <div class="glass-card rounded-xl overflow-hidden">
                    <div class="p-4 border-b border-slate-700/50 flex justify-between items-center">
                        <h3 class="font-semibold flex items-center gap-2">
                            <i data-lucide="activity" class="w-4 h-4 text-orange-400"></i> 持倉詳情
                        </h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-400">
                            <thead class="text-xs text-slate-500 uppercase bg-slate-800/50">
                                <tr>
                                    <th class="px-4 py-3">合約/幣種</th>
                                    <th class="px-4 py-3">方向/槓桿</th>
                                    <th class="px-4 py-3 text-right">數量</th>
                                    <th class="px-4 py-3 text-right">開倉價</th>
                                    <th class="px-4 py-3 text-right">標記價</th>
                                    <th class="px-4 py-3 text-right">未實現盈虧</th>
                                </tr>
                            </thead>
                            <tbody id="positions-table-body">
                                <tr>
                                    <td colspan="6" class="px-4 py-8 text-center text-slate-500">
                                        尚無持倉數據
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pulse Tab (News/AI) -->
        <div id="pulse-tab" class="hidden flex-1 flex flex-col p-6 overflow-y-auto custom-scrollbar">
            <div class="max-w-6xl mx-auto w-full">
                <div class="flex justify-between items-end mb-6">
                    <h2 class="text-2xl font-bold flex items-center gap-2">
                        <i data-lucide="zap" class="w-6 h-6 text-yellow-400"></i> 市場脈動 AI
                    </h2>
                    <div class="flex items-center gap-2">
                        <button onclick="refreshMarketPulse()" id="pulse-refresh-btn" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg border border-blue-500 transition">
                            <i data-lucide="refresh-cw" class="w-4 h-4" id="pulse-refresh-icon"></i> 重新整理
                        </button>
                        <button onclick="openGlobalFilter()" class="flex items-center gap-2 bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg border border-slate-600 transition">
                            <i data-lucide="settings-2" class="w-4 h-4"></i> 設定關注
                        </button>
                    </div>
                </div>

                <div id="pulse-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Cards will be injected here -->
                    <div class="glass-card rounded-2xl p-8 text-center col-span-full">
                        <div class="animate-pulse text-slate-400">正在初始化 AI 分析引擎...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Watchlist Tab (自選清單) -->
        <div id="watchlist-tab" class="hidden flex-1 flex flex-col p-6 overflow-y-auto custom-scrollbar">
            <div class="max-w-4xl mx-auto w-full">
                <div class="flex justify-between items-end mb-8">
                    <div>
                        <h2 class="text-2xl font-bold flex items-center gap-2">
                            <i data-lucide="star" class="w-6 h-6 text-amber-400"></i> 我的自選清單
                        </h2>
                        <p class="text-slate-400">追蹤您關注的幣種，快速查看行情</p>
                    </div>
                    <button onclick="refreshWatchlist()" class="flex items-center gap-2 bg-amber-600/20 text-amber-400 px-4 py-2 rounded-lg border border-amber-500/30 hover:bg-amber-600/30 transition">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i> 刷新
                    </button>
                </div>

                <!-- Watchlist Items -->
                <div id="watchlist-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="glass-card rounded-xl p-6 text-center text-slate-400">
                        <i data-lucide="star" class="w-12 h-12 mx-auto mb-3 opacity-30"></i>
                        <p>您還沒有收藏任何幣種</p>
                        <p class="text-sm mt-2">在 AI 分析結果中點擊 ⭐ 按鈕來收藏</p>
                    </div>
                </div>

                <!-- Chart Container -->
                <div id="chart-section" class="mt-8 hidden">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i data-lucide="trending-up" class="w-5 h-5 text-blue-400"></i>
                        <span id="chart-title">BTC/USDT</span> K 線圖
                    </h3>
                    <div id="chart-container" class="glass-card rounded-xl p-4" style="height: 400px;"></div>
                </div>
            </div>
        </div>


        <!-- Debate Modal (Hidden) -->
        <div id="debate-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-5xl max-h-[90vh] overflow-y-auto relative shadow-2xl">
                <button onclick="closeDebate()" class="absolute top-4 right-4 p-2 bg-slate-800 rounded-full hover:bg-slate-700 transition z-10">
                    <i data-lucide="x" class="w-5 h-5 text-slate-400"></i>
                </button>
                
                <div class="p-6 md:p-8">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">AI 多空辯論擂台</h2>
                        <p class="text-slate-400 mt-2">Bull vs Bear: The Ultimate Showdown for <span id="debate-symbol" class="text-white font-bold">BTC</span></p>
                    </div>

                    <!-- Judge Score -->
                    <div class="mb-8">
                        <div class="flex justify-between text-sm font-bold mb-2 uppercase tracking-wider">
                            <span class="text-green-400">多頭 (Bull)</span>
                            <span class="text-slate-400">裁判評分</span>
                            <span class="text-red-400">空頭 (Bear)</span>
                        </div>
                        <div class="h-6 bg-slate-800 rounded-full overflow-hidden flex relative">
                            <div id="score-bull" class="h-full bg-gradient-to-r from-green-600 to-green-400 transition-all duration-1000" style="width: 50%"></div>
                            <div id="score-bear" class="h-full bg-gradient-to-l from-red-600 to-red-400 transition-all duration-1000" style="width: 50%"></div>
                            
                            <!-- Center Line -->
                            <div class="absolute top-0 bottom-0 left-1/2 w-0.5 bg-white/50 -translate-x-1/2"></div>
                        </div>
                        <div class="flex justify-between mt-2 text-xl font-bold">
                            <span id="score-val-bull" class="text-green-400">50</span>
                            <span id="winner-badge" class="px-3 py-1 bg-blue-600/20 text-blue-400 rounded-lg text-sm border border-blue-600/50">平局</span>
                            <span id="score-val-bear" class="text-red-400">50</span>
                        </div>
                    </div>

                    <!-- Arguments -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Bull Card -->
                        <div class="border border-green-900/50 bg-green-900/10 rounded-2xl p-6 relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-4 opacity-10">
                                <i data-lucide="trending-up" class="w-32 h-32 text-green-500"></i>
                            </div>
                            <h3 class="text-xl font-bold text-green-400 mb-4 flex items-center gap-2">
                                <i data-lucide="thumbs-up" class="w-5 h-5"></i> 多頭觀點
                            </h3>
                            <div id="bull-arg" class="prose prose-invert prose-sm max-w-none text-slate-300">
                                載入中...
                            </div>
                        </div>

                        <!-- Bear Card -->
                        <div class="border border-red-900/50 bg-red-900/10 rounded-2xl p-6 relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-4 opacity-10">
                                <i data-lucide="trending-down" class="w-32 h-32 text-red-500"></i>
                            </div>
                            <h3 class="text-xl font-bold text-red-400 mb-4 flex items-center gap-2">
                                <i data-lucide="thumbs-down" class="w-5 h-5"></i> 空頭觀點
                            </h3>
                            <div id="bear-arg" class="prose prose-invert prose-sm max-w-none text-slate-300">
                                載入中...
                            </div>
                        </div>
                    </div>

                    <!-- Judge Verdict -->
                    <div class="mt-8 bg-slate-800/50 border border-slate-700 rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-amber-400 mb-2 flex items-center gap-2">
                            <i data-lucide="gavel" class="w-5 h-5"></i> 裁判裁決
                        </h3>
                        <p id="judge-verdict" class="text-slate-300 leading-relaxed">
                            載入中...
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Global Filter Modal -->
        <div id="global-filter-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-md max-h-[80vh] flex flex-col shadow-2xl">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        全域關注資產
                        <select id="filter-exchange-select" onchange="switchFilterExchange(this.value)" class="bg-slate-800 text-sm border border-slate-600 rounded px-2 py-1 text-slate-300 focus:outline-none focus:border-blue-500">
                            <option value="okx">OKX</option>
                            <option value="binance">Binance</option>
                        </select>
                    </h3>
                    <button onclick="document.getElementById('global-filter-modal').classList.add('hidden')" class="text-slate-400 hover:text-white">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <div class="p-4 border-b border-slate-700 bg-slate-800/50">
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i>
                        <input type="text" id="symbol-search" placeholder="搜尋幣種 (如 BTC, ETH)..." 
                            class="w-full bg-slate-900 border border-slate-700 rounded-lg pl-9 pr-4 py-2 text-sm focus:border-blue-500 outline-none"
                            oninput="renderSymbolList(allMarketSymbols)">
                    </div>
                    <div class="flex justify-between mt-3 text-xs text-slate-400">
                        <span>已選擇: <span id="selected-count-modal" class="text-blue-400 font-bold">0</span></span>
                        <button onclick="selectAllMatches()" class="text-blue-400 hover:text-blue-300 transition">全選搜尋結果</button>
                    </div>
                </div>

                <div id="symbol-list-container" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar">
                    <div class="text-center py-8 text-slate-500">載入中...</div>
                </div>

                <div class="p-4 border-t border-slate-700 flex gap-2">
                    <button onclick="globalSelectedSymbols=[]; renderSymbolList(allMarketSymbols);" class="flex-1 bg-slate-800 hover:bg-slate-700 text-slate-300 py-2 rounded-lg transition">清除選擇</button>
                    <button onclick="applyGlobalFilter()" class="flex-[2] bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg font-bold transition">套用設定</button>
                </div>
            </div>
        </div>

        <!-- News List Modal -->
        <div id="news-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-lg max-h-[70vh] flex flex-col shadow-2xl">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <i data-lucide="newspaper" class="w-5 h-5 text-blue-400"></i>
                        AI 參考新聞: <span id="news-modal-symbol"></span>
                    </h3>
                    <button onclick="document.getElementById('news-modal').classList.add('hidden')" class="text-slate-400 hover:text-white">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div id="news-list-content" class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
                    <!-- News items will be injected here -->
                </div>
            </div>
        </div>

        <div id="settings-tab" class="hidden flex-1 flex flex-col p-6 overflow-y-auto custom-scrollbar">
            <div class="max-w-2xl mx-auto w-full">
                <h2 class="text-2xl font-bold mb-6">設定與帳戶</h2>

                <!-- LLM API Keys 設定 -->
                <div class="glass-card rounded-2xl p-6 space-y-6 mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-blue-400 flex items-center gap-2">
                                <i data-lucide="key" class="w-5 h-5"></i>
                                AI 模型 API Key
                            </h3>
                            <p class="text-xs text-slate-400 mt-1">您需要自己的 API Key 才能使用 AI 分析功能</p>
                        </div>
                    </div>

                    <!-- Provider Selection -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">選擇 AI 提供商</label>
                        <select id="llm-provider-select" onchange="updateLLMKeyInput()" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-sm text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition">
                            <option value="openai">OpenAI (GPT-4o-mini)</option>
                            <option value="google_gemini">Google Gemini (Flash)</option>
                            <option value="openrouter">OpenRouter</option>
                        </select>
                    </div>

                    <!-- API Key Input -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">API Key</label>
                        <div class="relative">
                            <input type="password" id="llm-api-key-input"
                                class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 pr-20 text-sm text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition"
                                placeholder="sk-...">
                            <button type="button" onclick="toggleLLMKeyVisibility()" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-white p-2">
                                <i data-lucide="eye" class="w-4 h-4" id="llm-key-eye-icon"></i>
                            </button>
                        </div>
                        <p class="text-xs text-slate-500 mt-2">
                            您的 API Key 僅存儲在瀏覽器本地，不會上傳到任何服務器
                        </p>
                    </div>

                    <!-- Save/Test Buttons -->
                    <div class="flex gap-3">
                        <button onclick="testLLMKey()" class="flex-1 px-4 py-2.5 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2">
                            <i data-lucide="check-circle" class="w-4 h-4"></i>
                            測試連接
                        </button>
                        <button onclick="saveLLMKey()" class="flex-1 px-4 py-2.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm font-bold shadow-lg shadow-blue-900/20 transition flex items-center justify-center gap-2">
                            <i data-lucide="save" class="w-4 h-4"></i>
                            保存設置
                        </button>
                    </div>

                    <!-- Status -->
                    <div id="llm-key-status" class="hidden p-3 rounded-lg">
                        <p class="text-sm"></p>
                    </div>

                    <!-- Help Links -->
                    <div class="pt-4 border-t border-slate-700">
                        <p class="text-xs text-slate-500 mb-2">如何獲取 API Key？</p>
                        <div class="flex flex-wrap gap-2">
                            <a href="https://platform.openai.com/api-keys" target="_blank" class="text-xs text-blue-400 hover:text-blue-300 underline">OpenAI 官網</a>
                            <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-blue-400 hover:text-blue-300 underline">Google AI Studio</a>
                            <a href="https://openrouter.ai/keys" target="_blank" class="text-xs text-blue-400 hover:text-blue-300 underline">OpenRouter</a>
                        </div>
                    </div>
                </div>

                <!-- Pi Network Identity -->
                <div class="glass-card rounded-2xl p-6 space-y-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">Pi 網路身份</label>
                        <div id="settings-user" class="text-lg font-semibold text-blue-400">未登入</div>
                    </div>
                </div>

                <!-- Support Section -->
                <div class="glass-card rounded-2xl p-6 space-y-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-4 text-amber-400">贊助與支持</h3>
                        <p class="text-sm text-slate-400 mb-4">如果您覺得這個工具對您有幫助，可以贊助 1 Pi 來支持開發者持續優化系統。</p>
                        <button onclick="alert('正式版本將串接 Pi 錢包支付 1 Pi')" class="w-full bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 text-white font-bold py-3 rounded-xl transition shadow-lg opacity-50">
                            贊助 1 Pi (開發中)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Key Setting Modal -->
        <div id="apikey-modal" class="fixed inset-0 bg-black/90 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-md">
            <div class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-md shadow-2xl relative overflow-hidden">
                <!-- Decorative background -->
                <div class="absolute top-0 right-0 w-32 h-32 bg-blue-500/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
                
                <div class="p-6 relative z-10">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-white flex items-center gap-2">
                            <i data-lucide="key" class="w-5 h-5 text-amber-400"></i>
                            設定交易所 API
                        </h3>
                        <button onclick="closeApiKeyModal()" class="text-slate-400 hover:text-white transition">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    
                    <p class="text-sm text-slate-400 mb-6 leading-relaxed">
                        🔒 <strong>安全模式 (BYOK):</strong> 您的 OKX API 金鑰僅存儲在<strong>您的瀏覽器</strong>中（localStorage），不會上傳到服務器。
                        <br>
                        ⚠️ <strong>注意:</strong> 無痕視窗不會保存您的金鑰，每次需要重新輸入。
                    </p>

                    <form id="apikey-form" onsubmit="saveApiKeys(event)" class="space-y-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">API Key</label>
                            <input type="text" id="input-api-key" required 
                                class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-sm text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition"
                                placeholder="輸入 API Key">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">Secret Key</label>
                            <input type="password" id="input-secret-key" required 
                                class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-sm text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition"
                                placeholder="輸入 Secret Key">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">Passphrase</label>
                            <input type="password" id="input-passphrase" required 
                                class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-sm text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition"
                                placeholder="輸入 Passphrase">
                        </div>

                        <div class="pt-4 flex gap-3">
                            <button type="button" onclick="closeApiKeyModal()" class="flex-1 px-4 py-2.5 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg text-sm font-medium transition">
                                取消
                            </button>
                            <button type="submit" id="btn-save-keys" class="flex-1 px-4 py-2.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm font-bold shadow-lg shadow-blue-900/20 transition flex items-center justify-center gap-2">
                                儲存並連線
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Trade Proposal Modal (HITL) -->
        <div id="proposal-modal" class="fixed inset-0 bg-black/90 z-[80] hidden flex items-center justify-center p-4 backdrop-blur-md">
            <div class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-sm shadow-2xl relative overflow-hidden">
                <div class="p-6 relative z-10">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-white flex items-center gap-2">
                            <i data-lucide="zap" class="w-5 h-5 text-blue-400"></i>
                            交易執行確認
                        </h3>
                        <button onclick="closeProposalModal()" class="text-slate-400 hover:text-white transition">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700/50">
                            <div class="flex justify-between mb-2">
                                <span class="text-slate-400 text-xs">交易對</span>
                                <span class="text-white font-bold font-mono" id="prop-symbol">BTC-USDT</span>
                            </div>
                            <div class="flex justify-between mb-2">
                                <span class="text-slate-400 text-xs">方向</span>
                                <span class="font-bold uppercase px-2 py-0.5 rounded text-xs" id="prop-side">LONG</span>
                            </div>
                            <div class="flex justify-between mb-2">
                                <span class="text-slate-400 text-xs">市場</span>
                                <span class="text-slate-300 text-xs" id="prop-market">Futures (5x)</span>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">下單金額 (USDT)</label>
                            <input type="number" id="prop-amount" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-white font-mono text-center text-lg focus:border-blue-500 outline-none">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-[10px] text-slate-500 mb-1">止損 (SL)</label>
                                <input type="number" id="prop-sl" class="w-full bg-slate-800/50 border border-slate-700 rounded px-2 py-1.5 text-slate-300 text-sm" placeholder="選填">
                            </div>
                            <div>
                                <label class="block text-[10px] text-slate-500 mb-1">止盈 (TP)</label>
                                <input type="number" id="prop-tp" class="w-full bg-slate-800/50 border border-slate-700 rounded px-2 py-1.5 text-slate-300 text-sm" placeholder="選填">
                            </div>
                        </div>

                        <button onclick="confirmTradeExecution()" id="btn-confirm-trade" class="w-full py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold rounded-xl shadow-lg shadow-blue-900/20 transition flex items-center justify-center gap-2 mt-2">
                            確認下單
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comprehensive Settings Modal -->
        <div id="settings-modal" class="fixed inset-0 bg-black/80 hidden z-[90] flex items-center justify-center backdrop-blur-sm p-4">
            <div class="bg-slate-800 border border-slate-700 rounded-xl w-full max-w-2xl p-6 shadow-2xl relative max-h-[90vh] overflow-y-auto custom-scrollbar">
                <button onclick="closeSettings()" class="absolute top-4 right-4 text-slate-400 hover:text-white">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                
                <h2 class="text-xl font-bold mb-6 flex items-center gap-2 text-white">
                    <i data-lucide="sliders" class="w-6 h-6 text-blue-400"></i> 系統設置
                </h2>
                
                <!-- 1. API Keys -->
                <div class="mb-8">
                    <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-4 border-b border-slate-700 pb-2">AI 模型 API 金鑰</h3>
                    
                    <div class="grid grid-cols-1 gap-4">
                        <div class="space-y-2">
                            <label class="text-xs text-slate-400 flex justify-between items-center">
                                OpenAI API Key
                                <span id="status-openai" class="text-[10px] text-slate-500 flex items-center gap-1">
                                    <i data-lucide="circle-dashed" class="w-3 h-3"></i> 未設定
                                </span>
                            </label>
                            <div class="flex gap-2">
                                <input type="password" id="set-openai-key" oninput="resetKeyStatus('openai')" class="flex-1 bg-slate-900 border border-slate-700 rounded p-2 text-sm text-white focus:border-blue-500 outline-none" placeholder="sk-...">
                                <button onclick="verifyKey('openai')" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded text-xs transition border border-slate-600 whitespace-nowrap">驗證</button>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs text-slate-400 flex justify-between items-center">
                                Google Gemini API Key
                                <span id="status-google_gemini" class="text-[10px] text-slate-500 flex items-center gap-1">
                                    <i data-lucide="circle-dashed" class="w-3 h-3"></i> 未設定
                                </span>
                            </label>
                            <div class="flex gap-2">
                                <input type="password" id="set-google-key" oninput="resetKeyStatus('google_gemini')" class="flex-1 bg-slate-900 border border-slate-700 rounded p-2 text-sm text-white focus:border-blue-500 outline-none" placeholder="AIza...">
                                <button onclick="verifyKey('google_gemini')" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded text-xs transition border border-slate-600 whitespace-nowrap">驗證</button>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs text-slate-400 flex justify-between items-center">
                                OpenRouter API Key
                                <span id="status-openrouter" class="text-[10px] text-slate-500 flex items-center gap-1">
                                    <i data-lucide="circle-dashed" class="w-3 h-3"></i> 未設定
                                </span>
                            </label>
                            <div class="flex gap-2">
                                <input type="password" id="set-openrouter-key" oninput="resetKeyStatus('openrouter')" class="flex-1 bg-slate-900 border border-slate-700 rounded p-2 text-sm text-white focus:border-blue-500 outline-none" placeholder="sk-or-...">
                                <button onclick="verifyKey('openrouter')" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded text-xs transition border border-slate-600 whitespace-nowrap">驗證</button>
                            </div>
                        </div>
                    </div>

                    <!-- OKX Keys -->
                    <div class="mt-6 p-4 bg-slate-900/50 rounded-lg border border-slate-700/50">
                        <h4 class="text-sm font-medium text-slate-300 mb-2 flex items-center gap-2">
                            <img src="https://static.okx.com/cdn/assets/imgs/247/5F7057067E614532.png" class="w-4 h-4 rounded-full"> OKX 交易金鑰
                            <span class="text-[10px] px-2 py-0.5 bg-green-500/20 text-green-400 rounded-full border border-green-500/30">🔒 本地存儲</span>
                        </h4>
                        <p class="text-[10px] text-slate-500 mb-3">⚠️ 金鑰僅存儲在您的瀏覽器中，不會上傳到服務器（BYOK 模式）</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <input type="password" id="set-okx-key" class="bg-slate-800 border border-slate-700 rounded p-2 text-xs text-white" placeholder="API Key">
                            <input type="password" id="set-okx-secret" class="bg-slate-800 border border-slate-700 rounded p-2 text-xs text-white" placeholder="Secret Key">
                            <input type="password" id="set-okx-pass" class="bg-slate-800 border border-slate-700 rounded p-2 text-xs text-white" placeholder="Passphrase">
                        </div>
                    </div>
                </div>

                <!-- 2. Model Configuration -->
                <div class="mb-8">
                    <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-4 border-b border-slate-700 pb-2">模型與模式設置</h3>
                    
                    <div class="flex items-center justify-between mb-6 bg-blue-900/20 p-4 rounded-lg border border-blue-500/20">
                        <div>
                            <h4 class="font-medium text-white flex items-center gap-2">
                                <i data-lucide="users" class="w-4 h-4 text-blue-400"></i>
                                委員會辯論模式 (Multi-Model)
                            </h4>
                            <p class="text-xs text-slate-400 mt-1">啟用後，將同時調用多個 AI 模型進行辯論與投票，分析更全面但速度較慢。</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="set-committee-mode" class="sr-only peer" onchange="toggleCommitteePanel()">
                            <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>

                    <div id="single-model-config" class="grid grid-cols-1 md:grid-cols-2 gap-6 transition-all duration-300">
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-slate-300">模型提供商</label>
                            <select id="set-model-provider" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2.5 text-sm text-white focus:border-blue-500 outline-none">
                                <option value="google_gemini">Google Gemini</option>
                                <option value="openai">OpenAI</option>
                                <option value="openrouter">OpenRouter</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-slate-300">模型名稱</label>
                            <div class="flex flex-col gap-2">
                                <input type="text" id="set-model-name" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2.5 text-sm text-white focus:border-blue-500 outline-none" placeholder="e.g. gemini-1.5-pro">
                                <select onchange="document.getElementById('set-model-name').value = this.value" class="w-full bg-slate-800 text-xs text-slate-400 border border-slate-700 rounded px-2 py-1 outline-none cursor-pointer">
                                    <option value="">-- 快速選擇常用模型 --</option>
                                    <option value="gemini-3-flash-preview">Google: Gemini 2.5 Flash</option>
                                    <option value="gemini-1.5-pro">Google: Gemini 1.5 Pro</option>
                                    <option value="gpt-4o">OpenAI: GPT-4o</option>
                                    <option value="gpt-4o-mini">OpenAI: GPT-4o Mini</option>
                                    <option value="anthropic/claude-3.5-sonnet">OpenRouter: Claude 3.5 Sonnet</option>
                                    <option value="deepseek/deepseek-r1">OpenRouter: DeepSeek R1</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 委員會成員列表 (僅在開啟委員會模式時顯示) -->
                    <div id="committee-management-panel" class="hidden mt-6 pt-6 border-t border-slate-700">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-sm font-bold text-white">管理委員會成員</h4>
                            <p class="text-[10px] text-slate-400">請先在上方選擇模型，再點擊下方按鈕加入對應陣營。</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- 多頭成員 -->
                            <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                                <div class="flex justify-between items-center mb-2">
                                    <h5 class="text-xs font-bold text-green-400 flex items-center gap-1">
                                        <i data-lucide="trending-up" class="w-3 h-3"></i> 多頭委員會 (Bull)
                                    </h5>
                                    <button onclick="addCurrentModelToCommittee('bull')" class="text-[10px] bg-green-600/20 hover:bg-green-600 hover:text-white text-green-400 px-2 py-1 rounded border border-green-600/30 transition flex items-center gap-1" title="將上方選擇的模型加入多頭">
                                        <i data-lucide="plus" class="w-3 h-3"></i> 加入
                                    </button>
                                </div>
                                <ul id="bull-committee-list" class="space-y-2 text-xs min-h-[40px]">
                                    <li class="text-slate-500 italic">載入中...</li>
                                </ul>
                            </div>
                            
                            <!-- 空頭成員 -->
                            <div class="bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                                <div class="flex justify-between items-center mb-2">
                                    <h5 class="text-xs font-bold text-red-400 flex items-center gap-1">
                                        <i data-lucide="trending-down" class="w-3 h-3"></i> 空頭委員會 (Bear)
                                    </h5>
                                    <button onclick="addCurrentModelToCommittee('bear')" class="text-[10px] bg-red-600/20 hover:bg-red-600 hover:text-white text-red-400 px-2 py-1 rounded border border-red-600/30 transition flex items-center gap-1" title="將上方選擇的模型加入空頭">
                                        <i data-lucide="plus" class="w-3 h-3"></i> 加入
                                    </button>
                                </div>
                                <ul id="bear-committee-list" class="space-y-2 text-xs min-h-[40px]">
                                    <li class="text-slate-500 italic">載入中...</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-3 mt-8 pt-6 border-t border-slate-700">
                    <button onclick="closeSettings()" class="px-4 py-2 text-slate-400 hover:text-white transition">取消</button>
                    <button onclick="saveSettings()" id="btn-save-settings" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg shadow-lg shadow-blue-600/20 font-medium transition flex items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i> 保存並應用
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- Mobile Navigation -->
    <nav class="md:hidden glass-card flex justify-around py-4 border-t border-slate-800">
        <button onclick="switchTab('chat')" class="flex flex-col items-center gap-1 text-blue-500 relative">
            <i data-lucide="bot" class="w-6 h-6"></i>
            <span class="text-[10px]">AI 分析</span>
            <div class="absolute top-0 right-2 w-2 h-2 bg-purple-500 rounded-full"></div>
        </button>
        <button onclick="switchTab('pulse')" class="flex flex-col items-center gap-1 text-slate-400 relative">
            <i data-lucide="activity" class="w-6 h-6"></i>
            <span class="text-[10px]">脈動</span>
            <div class="absolute top-0 right-2 w-2 h-2 bg-green-500 rounded-full"></div>
        </button>
        <button onclick="switchTab('market')" class="flex flex-col items-center gap-1 text-slate-400 relative">
            <i data-lucide="trending-up" class="w-6 h-6"></i>
            <span class="text-[10px]">行情</span>
            <div class="absolute top-0 right-2 w-2 h-2 bg-green-500 rounded-full"></div>
        </button>
        <button onclick="switchTab('assets')" class="flex flex-col items-center gap-1 text-slate-400 relative">
            <i data-lucide="wallet" class="w-6 h-6"></i>
            <span class="text-[10px]">資產</span>
            <div class="absolute top-0 right-2 w-2 h-2 bg-amber-500 rounded-full"></div>
        </button>
        <button onclick="switchTab('settings')" class="flex flex-col items-center gap-1 text-slate-400">
            <i data-lucide="settings" class="w-6 h-6"></i>
            <span class="text-[10px]">設定</span>
        </button>
    </nav>

    <!-- 固定免責聲明 Footer -->
    <footer class="hidden md:block bg-slate-900/80 border-t border-slate-800 py-2 px-4">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-2 text-[10px] text-slate-500">
            <p class="flex items-center gap-1">
                <i data-lucide="shield-alert" class="w-3 h-3"></i>
                <span><strong>免責聲明：</strong>本平台提供之所有資訊僅供參考，不構成任何投資建議或要約。加密貨幣交易具有高度風險，可能導致本金全部損失。</span>
            </p>
            <p class="text-slate-600">© 2025 Pi Crypto Insight - 投資有風險，入市需謹慎</p>
        </div>
    </footer>


    <!-- JavaScript Modules -->
    <script src="/static/js/apiKeyManager.js"></script>
    <script src="/static/js/okxKeyManager.js"></script>
    <script src="/static/js/app.js"></script>
    <script src="/static/js/llmSettings.js"></script>
    <script src="/static/js/filter.js"></script>
    <script src="/static/js/chat.js"></script>
    <script src="/static/js/market.js"></script>
    <script src="/static/js/assets.js"></script>
    <script src="/static/js/pulse.js"></script>
    <script src="/static/js/watchlist.js"></script>
    <script src="/static/js/trade.js"></script>
</body>
</html>
