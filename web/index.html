<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi Crypto Insight - AI æŠ•è³‡åˆ†æ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
    <!-- Pi SDK -->
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <!-- TradingView Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #f1f5f9;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .message-bubble {
            max-width: 85%;
            border-radius: 1.25rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .user-message {
            background: #3b82f6;
            color: white;
            border-bottom-right-radius: 0.25rem;
            margin-left: auto;
        }

        .bot-message {
            background: #1e293b;
            color: #f1f5f9;
            border-bottom-left-radius: 0.25rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }

        /* Markdown Styles */
        .prose h1, .prose h2, .prose h3 { color: #60a5fa; font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem; }
        .prose h2 { font-size: 1.25rem; border-left: 4px solid #3b82f6; padding-left: 0.5rem; }
        .prose p { margin-bottom: 0.75rem; line-height: 1.6; }
        .prose ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 0.75rem; }
        .prose strong { color: #fbbf24; }
        .prose table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.9rem; }
        .prose th, .prose td { border: 1px solid #334155; padding: 0.5rem; text-align: left; }
        .prose th { background: #1e293b; }

        .typing-indicator span {
            display: inline-block;
            width: 4px;
            height: 4px;
            background-color: #94a3b8;
            border-radius: 50%;
            margin-right: 2px;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

        /* Loading Spinner */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            color: white;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .spinner {
            width: 22px;
            height: 22px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .done-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border-radius: 8px;
            color: white;
            font-weight: 600;
            font-size: 12px;
            margin-top: 12px;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="glass-card h-16 flex items-center justify-between px-6 z-10">
        <div class="flex items-center gap-2">
            <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-900/20">
                <i data-lucide="trending-up" class="text-white w-6 h-6"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg leading-tight">Pi Crypto <span class="text-blue-500">Insight</span></h1>
                <p class="text-xs text-slate-400 flex items-center gap-1">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> AI Analysis Ready
                </p>
            </div>
        </div>
        <div id="pi-user" class="text-sm bg-slate-800/50 px-3 py-1.5 rounded-full border border-slate-700 hidden">
            <!-- Pi Username will appear here -->
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex overflow-hidden">
        
        <!-- Sidebar (Desktop) / Bottom Nav (Mobile) -->
        <nav class="w-20 glass-card flex flex-col items-center py-8 gap-8 hidden md:flex">
            <button onclick="switchTab('chat')" class="nav-btn active group text-blue-500" title="AI åˆ†æå°è©±">
                <i data-lucide="message-square" class="w-7 h-7"></i>
            </button>
            <button onclick="switchTab('watchlist')" class="nav-btn group text-slate-400 hover:text-blue-400" title="æˆ‘çš„è‡ªé¸">
                <i data-lucide="star" class="w-7 h-7"></i>
            </button>
            <button onclick="switchTab('market')" class="nav-btn group text-slate-400 hover:text-blue-400" title="è¡Œæƒ…ç¯©é¸">
                <i data-lucide="bar-chart-2" class="w-7 h-7"></i>
            </button>
            <button onclick="switchTab('social')" class="nav-btn group text-slate-400 hover:text-blue-400" title="ç¤¾ç¾¤é æ¸¬">
                <i data-lucide="users" class="w-7 h-7"></i>
            </button>
            <button onclick="switchTab('settings')" class="mt-auto nav-btn text-slate-400" title="è¨­å®š">
                <i data-lucide="settings" class="w-7 h-7"></i>
            </button>
        </nav>

        <!-- Chat Area -->
        <div id="chat-tab" class="flex-1 flex flex-col relative bg-[#0f172a]">
            <!-- Messages Container -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 md:p-8 custom-scrollbar space-y-4">
                <!-- Welcome Message -->
                <div class="bot-message message-bubble prose">
                    <h3 class="flex items-center gap-2"><i data-lucide="bot" class="w-5 h-5"></i> æ­¡è¿ä½¿ç”¨ Pi Crypto Insight</h3>
                    <p>æˆ‘æ˜¯æ‚¨çš„ AI æŠ•è³‡åŠ©æ‰‹ã€‚æ‚¨å¯ä»¥è¼¸å…¥åŠ å¯†è²¨å¹£ä»£è™Ÿï¼ˆå¦‚ BTC, ETH, PIï¼‰ï¼Œæˆ‘å°‡ç‚ºæ‚¨é€²è¡Œæ·±åº¦åˆ†æã€‚</p>
                    <p>è©¦è©¦é»æ“Šä¸‹æ–¹çš„å»ºè­°ï¼š</p>
                    <div class="flex flex-wrap gap-2 mt-2">
                        <button onclick="quickAsk('PIUSDT å¯ä»¥æŠ•è³‡å—ï¼Ÿ')" class="px-3 py-1 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs border border-slate-700 transition">Pi Network (PI) åˆ†æ</button>
                        <button onclick="quickAsk('æ¯”ç‰¹å¹£ç¾åœ¨é©åˆè²·å…¥å—ï¼Ÿ')" class="px-3 py-1 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs border border-slate-700 transition">BTC è¡Œæƒ…é æ¸¬</button>
                        <button onclick="quickAsk('æ¯”è¼ƒ ETH å’Œ SOL')" class="px-3 py-1 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs border border-slate-700 transition">å¹£ç¨®å°æ¯”</button>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 md:p-6 bg-gradient-to-t from-[#0f172a] to-transparent">
                <div class="max-w-4xl mx-auto glass-card rounded-2xl p-1 shadow-2xl transition-all duration-300" id="input-container">
                    
                    <!-- Input Row -->
                    <div class="flex items-center gap-2 p-2">
                        <button onclick="toggleOptions()" class="p-3 text-slate-400 hover:text-blue-400 transition bg-slate-800/50 hover:bg-slate-700 rounded-xl" title="åˆ†æè¨­å®š">
                            <i data-lucide="sliders-horizontal" class="w-6 h-6"></i>
                        </button>
                        <input type="text" id="user-input" 
                            class="flex-1 bg-transparent border-none focus:ring-0 text-slate-200 placeholder-slate-500 text-sm md:text-base py-3"
                            placeholder="è«‹è¼¸å…¥æ‚¨çš„å•é¡Œ..."
                            onkeypress="if(event.key === 'Enter') sendMessage()">
                        <button onclick="sendMessage()" id="send-btn"
                            class="bg-blue-600 hover:bg-blue-500 text-white p-3 rounded-xl transition shadow-lg shadow-blue-600/20">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <!-- Analysis Options Panel (Hidden by default) -->
                    <div id="analysis-options-panel" class="hidden border-t border-slate-700/50 p-3 animate-in slide-in-from-top-2 duration-200">
                        <div class="text-xs text-slate-500 mb-2 font-medium px-1">é¸æ“‡åˆ†ææ¨¡çµ„ (ç•™ç©ºå‰‡è‡ªå‹•åˆ¤æ–·):</div>
                        <div class="flex flex-wrap gap-2">
                            <label class="flex items-center gap-2 cursor-pointer bg-slate-800/40 px-3 py-2 rounded-lg border border-slate-700 hover:bg-slate-700/60 transition select-none">
                                <input type="checkbox" class="analysis-checkbox form-checkbox h-4 w-4 text-blue-500 rounded bg-slate-700 border-slate-600 focus:ring-offset-slate-800" value="Technical Analysis">
                                <span class="text-xs text-slate-300">æŠ€è¡“åˆ†æ</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer bg-slate-800/40 px-3 py-2 rounded-lg border border-slate-700 hover:bg-slate-700/60 transition select-none">
                                <input type="checkbox" class="analysis-checkbox form-checkbox h-4 w-4 text-blue-500 rounded bg-slate-700 border-slate-600 focus:ring-offset-slate-800" value="News Analysis">
                                <span class="text-xs text-slate-300">æ–°èåˆ†æ</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer bg-slate-800/40 px-3 py-2 rounded-lg border border-slate-700 hover:bg-slate-700/60 transition select-none">
                                <input type="checkbox" class="analysis-checkbox form-checkbox h-4 w-4 text-blue-500 rounded bg-slate-700 border-slate-600 focus:ring-offset-slate-800" value="Fundamental Analysis">
                                <span class="text-xs text-slate-300">åŸºæœ¬é¢</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer bg-slate-800/40 px-3 py-2 rounded-lg border border-slate-700 hover:bg-slate-700/60 transition select-none">
                                <input type="checkbox" class="analysis-checkbox form-checkbox h-4 w-4 text-blue-500 rounded bg-slate-700 border-slate-600 focus:ring-offset-slate-800" value="Sentiment Analysis">
                                <span class="text-xs text-slate-300">æƒ…ç·’åˆ†æ</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer bg-slate-800/40 px-3 py-2 rounded-lg border border-amber-500/30 hover:bg-amber-900/10 transition select-none">
                                <input type="checkbox" class="analysis-checkbox form-checkbox h-4 w-4 text-amber-500 rounded bg-slate-700 border-slate-600 focus:ring-offset-slate-800" value="Full Trading Decision">
                                <span class="text-xs text-amber-400 font-medium">äº¤æ˜“æ±ºç­–</span>
                            </label>
                        </div>
                    </div>

                </div>
                <p class="text-[10px] text-center text-slate-500 mt-3 uppercase tracking-widest">Powered by AI Agent System & Pi Network</p>
            </div>
        </div>

        <!-- Market Tab (Hidden by default) -->
        <div id="market-tab" class="hidden flex-1 flex flex-col p-6 overflow-y-auto custom-scrollbar">
            <div class="max-w-6xl mx-auto w-full">
                
                <!-- Market Pulse Ticker -->
                <div id="market-pulse" class="mb-6 bg-gradient-to-r from-blue-900/40 to-slate-900/40 border border-blue-500/20 rounded-xl p-4 flex items-center gap-4 animate-in fade-in slide-in-from-top-4 duration-500 hidden">
                    <div class="bg-blue-500/20 p-2 rounded-lg text-blue-400">
                        <i data-lucide="activity" class="w-5 h-5"></i>
                    </div>
                    <div class="flex-1">
                        <div class="text-xs text-blue-400 font-bold uppercase tracking-wider mb-0.5">Market Pulse</div>
                        <div id="pulse-content" class="text-sm font-medium text-slate-200">æ­£åœ¨åµæ¸¬å¸‚å ´ç•°å‹•...</div>
                    </div>
                </div>

                <div class="flex justify-between items-end mb-8">
                    <div>
                        <h2 class="text-2xl font-bold">å¸‚å ´ç¯©é¸å™¨</h2>
                        <p class="text-slate-400">æ ¹æ“š RSI èˆ‡æ¼²å¹…æŒ‘é¸å„ªè³ªå¹£ç¨® <span id="screener-last-updated" class="text-xs text-slate-500 ml-2"></span></p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openBacktestModal()" class="flex items-center gap-2 bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg border border-slate-600 transition">
                            <i data-lucide="history" class="w-4 h-4"></i> å›æ¸¬å·¥å…·
                        </button>
                        <button onclick="refreshScreener(true)" class="flex items-center gap-2 bg-blue-600/20 text-blue-400 px-4 py-2 rounded-lg border border-blue-500/30 hover:bg-blue-600/30 transition">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i> é‡æ–°æ•´ç†
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Top Performers -->
                    <div class="glass-card rounded-2xl p-5">
                        <h3 class="flex items-center gap-2 font-semibold mb-4 text-green-400">
                            <i data-lucide="rocket" class="w-5 h-5"></i> é ˜æ¼²å¹£ç¨® (24H)
                        </h3>
                        <div id="top-list" class="space-y-3">
                            <div class="animate-pulse flex space-y-4">è¼‰å…¥ä¸­...</div>
                        </div>
                    </div>
                    <!-- Oversold -->
                    <div class="glass-card rounded-2xl p-5">
                        <h3 class="flex items-center gap-2 font-semibold mb-4 text-orange-400">
                            <i data-lucide="trending-down" class="w-5 h-5"></i> è¶…è³£å€åŸŸ (RSI 14 < 40)
                        </h3>
                        <div id="oversold-list" class="space-y-3">
                            <div class="animate-pulse flex space-y-4">è¼‰å…¥ä¸­...</div>
                        </div>
                    </div>
                    <!-- Overbought -->
                    <div class="glass-card rounded-2xl p-5">
                        <h3 class="flex items-center gap-2 font-semibold mb-4 text-red-400">
                            <i data-lucide="alert-triangle" class="w-5 h-5"></i> è¶…è²·å€åŸŸ (RSI 14 > 70)
                        </h3>
                        <div id="overbought-list" class="space-y-3">
                            <div class="animate-pulse flex space-y-4">è¼‰å…¥ä¸­...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Watchlist Tab (è‡ªé¸æ¸…å–®) -->
        <div id="watchlist-tab" class="hidden flex-1 flex flex-col p-6 overflow-y-auto custom-scrollbar">
            <div class="max-w-4xl mx-auto w-full">
                <div class="flex justify-between items-end mb-8">
                    <div>
                        <h2 class="text-2xl font-bold flex items-center gap-2">
                            <i data-lucide="star" class="w-6 h-6 text-amber-400"></i> æˆ‘çš„è‡ªé¸æ¸…å–®
                        </h2>
                        <p class="text-slate-400">è¿½è¹¤æ‚¨é—œæ³¨çš„å¹£ç¨®ï¼Œå¿«é€ŸæŸ¥çœ‹è¡Œæƒ…</p>
                    </div>
                    <button onclick="refreshWatchlist()" class="flex items-center gap-2 bg-amber-600/20 text-amber-400 px-4 py-2 rounded-lg border border-amber-500/30 hover:bg-amber-600/30 transition">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i> åˆ·æ–°
                    </button>
                </div>

                <!-- Watchlist Items -->
                <div id="watchlist-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="glass-card rounded-xl p-6 text-center text-slate-400">
                        <i data-lucide="star" class="w-12 h-12 mx-auto mb-3 opacity-30"></i>
                        <p>æ‚¨é‚„æ²’æœ‰æ”¶è—ä»»ä½•å¹£ç¨®</p>
                        <p class="text-sm mt-2">åœ¨ AI åˆ†æçµæœä¸­é»æ“Š â­ æŒ‰éˆ•ä¾†æ”¶è—</p>
                    </div>
                </div>

                <!-- Chart Container -->
                <div id="chart-section" class="mt-8 hidden">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i data-lucide="trending-up" class="w-5 h-5 text-blue-400"></i>
                        <span id="chart-title">BTC/USDT</span> K ç·šåœ–
                    </h3>
                    <div id="chart-container" class="glass-card rounded-xl p-4" style="height: 400px;"></div>
                </div>
            </div>
        </div>

        <!-- Social Tab (New) -->
        <div id="social-tab" class="hidden flex-1 flex flex-col p-6 overflow-y-auto custom-scrollbar">
            <div class="max-w-6xl mx-auto w-full">
                <div class="flex justify-between items-end mb-8">
                    <div>
                        <h2 class="text-2xl font-bold flex items-center gap-2">
                            <i data-lucide="users" class="w-6 h-6 text-purple-400"></i> ç¤¾ç¾¤é æ¸¬
                        </h2>
                        <p class="text-slate-400">åƒèˆ‡åƒ¹æ ¼é æ¸¬ï¼Œè´å¾— Pi å¹£çå‹µ</p>
                    </div>
                    <button onclick="refreshSocial()" class="flex items-center gap-2 bg-purple-600/20 text-purple-400 px-4 py-2 rounded-lg border border-purple-500/30 hover:bg-purple-600/30 transition">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i> åˆ·æ–°
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Prediction Card -->
                    <div class="glass-card rounded-2xl p-6 lg:col-span-1">
                        <h3 class="text-lg font-semibold mb-4">ğŸ”® ç™¼èµ·é æ¸¬</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">å¹£ç¨® (å¦‚ BTC)</label>
                                <input type="text" id="predict-symbol" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2 text-sm text-white focus:border-purple-500 outline-none" placeholder="BTC">
                            </div>
                            <div class="flex gap-2">
                                <button onclick="submitPrediction('UP')" class="flex-1 bg-green-600/20 hover:bg-green-600/40 text-green-400 border border-green-600/50 py-3 rounded-xl font-bold transition flex items-center justify-center gap-2">
                                    <i data-lucide="trending-up" class="w-4 h-4"></i> çœ‹æ¼²
                                </button>
                                <button onclick="submitPrediction('DOWN')" class="flex-1 bg-red-600/20 hover:bg-red-600/40 text-red-400 border border-red-600/50 py-3 rounded-xl font-bold transition flex items-center justify-center gap-2">
                                    <i data-lucide="trending-down" class="w-4 h-4"></i> çœ‹è·Œ
                                </button>
                            </div>
                            <p class="text-xs text-slate-500 mt-2 text-center">é æ¸¬æˆåŠŸå°‡ç²å¾—ç©åˆ†ï¼Œç©åˆ†å¯ç”¨æ–¼å…Œæ› VIP åˆ†æåŠŸèƒ½ã€‚</p>
                        </div>
                    </div>

                    <!-- Leaderboard -->
                    <div class="glass-card rounded-2xl p-6 lg:col-span-2">
                        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                            <i data-lucide="trophy" class="w-5 h-5 text-yellow-400"></i> æ’è¡Œæ¦œ
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-slate-400">
                                <thead class="text-xs text-slate-500 uppercase bg-slate-800/50">
                                    <tr>
                                        <th class="px-4 py-3 rounded-l-lg">æ’å</th>
                                        <th class="px-4 py-3">ç”¨æˆ¶</th>
                                        <th class="px-4 py-3">å‹ç‡</th>
                                        <th class="px-4 py-3">å‹å ´/ç¸½è¨ˆ</th>
                                        <th class="px-4 py-3 rounded-r-lg">å¹³å‡ç²åˆ©</th>
                                    </tr>
                                </thead>
                                <tbody id="leaderboard-body">
                                    <tr><td colspan="5" class="px-4 py-4 text-center">è¼‰å…¥ä¸­...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Debate Modal (Hidden) -->
        <div id="debate-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-5xl max-h-[90vh] overflow-y-auto relative shadow-2xl">
                <button onclick="closeDebate()" class="absolute top-4 right-4 p-2 bg-slate-800 rounded-full hover:bg-slate-700 transition z-10">
                    <i data-lucide="x" class="w-5 h-5 text-slate-400"></i>
                </button>
                
                <div class="p-6 md:p-8">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">AI å¤šç©ºè¾¯è«–æ“‚å°</h2>
                        <p class="text-slate-400 mt-2">Bull vs Bear: The Ultimate Showdown for <span id="debate-symbol" class="text-white font-bold">BTC</span></p>
                    </div>

                    <!-- Judge Score -->
                    <div class="mb-8">
                        <div class="flex justify-between text-sm font-bold mb-2 uppercase tracking-wider">
                            <span class="text-green-400">å¤šé ­ (Bull)</span>
                            <span class="text-slate-400">è£åˆ¤è©•åˆ†</span>
                            <span class="text-red-400">ç©ºé ­ (Bear)</span>
                        </div>
                        <div class="h-6 bg-slate-800 rounded-full overflow-hidden flex relative">
                            <div id="score-bull" class="h-full bg-gradient-to-r from-green-600 to-green-400 transition-all duration-1000" style="width: 50%"></div>
                            <div id="score-bear" class="h-full bg-gradient-to-l from-red-600 to-red-400 transition-all duration-1000" style="width: 50%"></div>
                            
                            <!-- Center Line -->
                            <div class="absolute top-0 bottom-0 left-1/2 w-0.5 bg-white/50 -translate-x-1/2"></div>
                        </div>
                        <div class="flex justify-between mt-2 text-xl font-bold">
                            <span id="score-val-bull" class="text-green-400">50</span>
                            <span id="winner-badge" class="px-3 py-1 bg-blue-600/20 text-blue-400 rounded-lg text-sm border border-blue-600/50">å¹³å±€</span>
                            <span id="score-val-bear" class="text-red-400">50</span>
                        </div>
                    </div>

                    <!-- Arguments -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Bull Card -->
                        <div class="border border-green-900/50 bg-green-900/10 rounded-2xl p-6 relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-4 opacity-10">
                                <i data-lucide="trending-up" class="w-32 h-32 text-green-500"></i>
                            </div>
                            <h3 class="text-xl font-bold text-green-400 mb-4 flex items-center gap-2">
                                <i data-lucide="thumbs-up" class="w-5 h-5"></i> å¤šé ­è§€é»
                            </h3>
                            <div id="bull-arg" class="prose prose-invert prose-sm max-w-none text-slate-300">
                                è¼‰å…¥ä¸­...
                            </div>
                        </div>

                        <!-- Bear Card -->
                        <div class="border border-red-900/50 bg-red-900/10 rounded-2xl p-6 relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-4 opacity-10">
                                <i data-lucide="trending-down" class="w-32 h-32 text-red-500"></i>
                            </div>
                            <h3 class="text-xl font-bold text-red-400 mb-4 flex items-center gap-2">
                                <i data-lucide="thumbs-down" class="w-5 h-5"></i> ç©ºé ­è§€é»
                            </h3>
                            <div id="bear-arg" class="prose prose-invert prose-sm max-w-none text-slate-300">
                                è¼‰å…¥ä¸­...
                            </div>
                        </div>
                    </div>

                    <!-- Judge Verdict -->
                    <div class="mt-8 bg-slate-800/50 border border-slate-700 rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-amber-400 mb-2 flex items-center gap-2">
                            <i data-lucide="gavel" class="w-5 h-5"></i> è£åˆ¤è£æ±º
                        </h3>
                        <p id="judge-verdict" class="text-slate-300 leading-relaxed">
                            è¼‰å…¥ä¸­...
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div id="settings-tab" class="hidden flex-1 flex flex-col p-6 overflow-y-auto custom-scrollbar">
            <div class="max-w-2xl mx-auto w-full">
                <h2 class="text-2xl font-bold mb-6">è¨­å®šèˆ‡å¸³æˆ¶</h2>
                <div class="glass-card rounded-2xl p-6 space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">Pi ç¶²è·¯èº«ä»½</label>
                        <div id="settings-user" class="text-lg font-semibold text-blue-400">æœªç™»å…¥</div>
                    </div>
                    
                    <div class="pt-6 border-t border-slate-700">
                        <h3 class="text-lg font-semibold mb-4 text-amber-400">è´ŠåŠ©èˆ‡æ”¯æŒ</h3>
                        <p class="text-sm text-slate-400 mb-4">å¦‚æœæ‚¨è¦ºå¾—é€™å€‹å·¥å…·å°æ‚¨æœ‰å¹«åŠ©ï¼Œå¯ä»¥è´ŠåŠ© 1 Pi ä¾†æ”¯æŒé–‹ç™¼è€…æŒçºŒå„ªåŒ–ç³»çµ±ã€‚</p>
                        <button onclick="alert('æ­£å¼ç‰ˆæœ¬å°‡ä¸²æ¥ Pi éŒ¢åŒ…æ”¯ä»˜ 1 Pi')" class="w-full bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 text-white font-bold py-3 rounded-xl transition shadow-lg opacity-50">
                            è´ŠåŠ© 1 Pi (é–‹ç™¼ä¸­)
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Mobile Navigation -->
    <nav class="md:hidden glass-card flex justify-around py-4 border-t border-slate-800">
        <button onclick="switchTab('chat')" class="flex flex-col items-center gap-1 text-blue-500">
            <i data-lucide="message-square" class="w-6 h-6"></i>
            <span class="text-[10px]">åˆ†æ</span>
        </button>
        <button onclick="switchTab('watchlist')" class="flex flex-col items-center gap-1 text-slate-400">
            <i data-lucide="star" class="w-6 h-6"></i>
            <span class="text-[10px]">è‡ªé¸</span>
        </button>
        <button onclick="switchTab('market')" class="flex flex-col items-center gap-1 text-slate-400">
            <i data-lucide="bar-chart-2" class="w-6 h-6"></i>
            <span class="text-[10px]">è¡Œæƒ…</span>
        </button>
        <button onclick="switchTab('social')" class="flex flex-col items-center gap-1 text-slate-400">
            <i data-lucide="users" class="w-6 h-6"></i>
            <span class="text-[10px]">ç¤¾ç¾¤</span>
        </button>
        <button onclick="switchTab('settings')" class="flex flex-col items-center gap-1 text-slate-400">
            <i data-lucide="settings" class="w-6 h-6"></i>
            <span class="text-[10px]">è¨­å®š</span>
        </button>
    </nav>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        const md = window.markdownit({ html: true, linkify: true });
        let isAnalyzing = false;
        let marketRefreshInterval = null;

        // Pi Network Initialization (moved to end of script for watchlist integration)
        const Pi = window.Pi;

        // --- [æ­£å¼ç‰ˆæ”¯ä»˜å‡½å¼ - è¨»è§£ä¿å­˜] ---
        /*
        async function createPiPayment(amount, memo) {
            if (!Pi) return alert("è«‹åœ¨ Pi Browser ä¸­ä½¿ç”¨æ­¤åŠŸèƒ½");
            
            Pi.createPayment({
                amount: amount,
                memo: memo,
                metadata: { type: "donation" },
            }, {
                onReadyForServerApproval: (paymentId) => {
                    return fetch('/api/payment/approve', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ paymentId: paymentId })
                    });
                },
                onReadyForServerCompletion: (paymentId, txid) => {
                    return fetch('/api/payment/complete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ paymentId: paymentId, txid: txid })
                    });
                },
                onCancel: (paymentId) => console.log("æ”¯ä»˜å–æ¶ˆ", paymentId),
                onError: (error, payment) => console.error("æ”¯ä»˜éŒ¯èª¤", error, payment),
            });
        }
        */

        function switchTab(tab) {
            ['chat', 'market', 'watchlist', 'social', 'settings'].forEach(t => {
                const el = document.getElementById(t + '-tab');
                if (el) el.classList.add('hidden');
            });
            document.getElementById(tab + '-tab').classList.remove('hidden');

            // Update nav icon colors (simplified)
            document.querySelectorAll('nav button').forEach(btn => btn.classList.replace('text-blue-500', 'text-slate-400'));
            
            // Highlight active tab icon (rough heuristic)
            // In a real app, use IDs on buttons
            
            // Clear existing interval
            if (marketRefreshInterval) {
                clearInterval(marketRefreshInterval);
                marketRefreshInterval = null;
            }

            if (tab === 'market') { 
                refreshScreener(true); 
                checkMarketPulse(); 
                // Auto-refresh every 60 seconds
                marketRefreshInterval = setInterval(() => {
                    refreshScreener(false);
                    checkMarketPulse();
                }, 5000);
            }
            if (tab === 'watchlist') refreshWatchlist();
            if (tab === 'social') refreshSocial();

            // Re-render icons for new tab
            lucide.createIcons();
        }

        function quickAsk(text) {
            document.getElementById('user-input').value = text;
            sendMessage();
        }

        function appendMessage(role, content) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `message-bubble ${role === 'user' ? 'user-message' : 'bot-message prose'}`;
            
            if (role === 'bot') {
                div.innerHTML = md.render(content);
                
                // --- Auto-detect symbol to add extra action buttons ---
                const match = content.match(/\b([A-Z]{2,5})\b/);
                if (match && !content.includes('è¼‰å…¥ä¸­') && !content.includes('Error')) {
                     const symbol = match[1];
                     const actionsDiv = document.createElement('div');
                     actionsDiv.className = 'flex gap-2 mt-3 pt-3 border-t border-slate-700/50';
                     actionsDiv.innerHTML = `
                        <button onclick="showDebate('${symbol}')" class="text-xs bg-purple-900/30 text-purple-400 px-2 py-1 rounded hover:bg-purple-900/50 border border-purple-500/30 transition flex items-center gap-1">
                            <i data-lucide="swords" class="w-3 h-3"></i> è§€çœ‹è¾¯è«–
                        </button>
                        <button onclick="showChart('${symbol}'); switchTab('watchlist');" class="text-xs bg-blue-900/30 text-blue-400 px-2 py-1 rounded hover:bg-blue-900/50 border border-blue-500/30 transition flex items-center gap-1">
                            <i data-lucide="bar-chart" class="w-3 h-3"></i> Kç·šåœ–
                        </button>
                     `;
                     div.appendChild(actionsDiv);
                     // Need to re-init lucide icons for new elements
                     setTimeout(() => lucide.createIcons(), 0);
                }
            } else {
                div.textContent = content;
            }
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return div;
        }

        function toggleOptions() {
            const panel = document.getElementById('analysis-options-panel');
            panel.classList.toggle('hidden');
            // Re-render icons in case they were hidden
            lucide.createIcons();
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const text = input.value.trim();
            if (!text || isAnalyzing) return;

            // Collect selected analysis modules
            const checkboxes = document.querySelectorAll('.analysis-checkbox:checked');
            const selection = Array.from(checkboxes).map(cb => cb.value);

            input.value = '';
            appendMessage('user', text);
            isAnalyzing = true;

            // Disable input and button
            input.disabled = true;
            sendBtn.disabled = true;
            input.classList.add('opacity-50');
            sendBtn.classList.add('opacity-50', 'cursor-not-allowed');

            // Add loading indicator with spinner
            const botMsgDiv = appendMessage('bot', '');
            const startTime = Date.now();
            let timerInterval;

            // Create loading HTML (åªå»ºç«‹ä¸€æ¬¡ï¼Œé¿å…å‹•ç•«é‡ç½®)
            botMsgDiv.innerHTML = `
                <div class="loading-container">
                    <div class="spinner"></div>
                    <span>AI æ€è€ƒä¸­...</span>
                    <span id="loading-timer">â±ï¸ 0.0 ç§’</span>
                </div>
            `;

            // åªæ›´æ–°æ™‚é–“æ•¸å­—ï¼Œä¸é‡å»ºæ•´å€‹ HTML
            const timerSpan = botMsgDiv.querySelector('#loading-timer');
            timerInterval = setInterval(() => {
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                timerSpan.textContent = `â±ï¸ ${elapsed} ç§’`;
            }, 100);

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: text,
                        manual_selection: selection
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullContent = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.substring(6));
                            if (data.content) {
                                fullContent = data.content;
                                // Stop timer and show content
                                clearInterval(timerInterval);
                                botMsgDiv.innerHTML = md.render(fullContent);
                                document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
                            }
                            if (data.done) {
                                isAnalyzing = false;
                                // Add elapsed time badge
                                const totalTime = ((Date.now() - startTime) / 1000).toFixed(1);
                                const timeBadge = document.createElement('div');
                                timeBadge.className = 'done-badge';
                                timeBadge.innerHTML = `âœ… å®Œæˆ â±ï¸ ${totalTime} ç§’`;
                                botMsgDiv.appendChild(timeBadge);
                            }
                            if (data.error) {
                                clearInterval(timerInterval);
                                botMsgDiv.innerHTML = `<span class="text-red-400">Error: ${data.error}</span>`;
                                isAnalyzing = false;
                            }
                        }
                    }
                }
            } catch (err) {
                console.error(err);
                clearInterval(timerInterval);
                botMsgDiv.innerHTML = '<span class="text-red-400">é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥å¾Œç«¯ä¼ºæœå™¨ã€‚</span>';
                isAnalyzing = false;
            } finally {
                // Re-enable input and button
                clearInterval(timerInterval);
                input.disabled = false;
                sendBtn.disabled = false;
                input.classList.remove('opacity-50');
                sendBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                input.focus();
            }
        }

        async function refreshScreener(showLoading = false) {
            const containers = {
                'top': document.getElementById('top-list'),
                'oversold': document.getElementById('oversold-list'),
                'overbought': document.getElementById('overbought-list')
            };
            
            if (showLoading) {
                Object.values(containers).forEach(c => c.innerHTML = '<div class="animate-pulse space-y-2"><div class="h-4 bg-slate-700 rounded w-3/4"></div><div class="h-4 bg-slate-700 rounded w-1/2"></div></div>');
            }

            try {
                const res = await fetch('/api/screener', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ exchange: 'binance' })
                });
                const data = await res.json();

                if (data.last_updated) {
                    const date = new Date(data.last_updated);
                    const timeStr = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
                    document.getElementById('screener-last-updated').textContent = `(æ›´æ–°æ–¼: ${timeStr})`;
                }

                renderList(containers.top, data.top_performers, 'price_change_24h', '%');
                renderList(containers.oversold, data.oversold, 'RSI_14', '');
                renderList(containers.overbought, data.overbought, 'RSI_14', '');
            } catch (err) {
                console.error(err);
            }
        }

        function renderList(container, items, key, unit) {
            container.innerHTML = '';
            if (!items || items.length === 0) {
                container.innerHTML = '<p class="text-slate-500 text-sm italic">ç„¡æ•¸æ“š</p>';
                return;
            }

            items.slice(0, 8).forEach(item => {
                const val = parseFloat(item[key]);
                const isPositive = val > 0;
                
                // Render signals tags
                let signalsHtml = '';
                if (item.signals && Array.isArray(item.signals)) {
                    item.signals.forEach(sig => {
                        let colorClass = 'bg-slate-600 text-slate-200';
                        if (sig.includes('çªç ´')) colorClass = 'bg-purple-500/20 text-purple-400 border border-purple-500/30';
                        if (sig.includes('çˆ†é‡')) colorClass = 'bg-orange-500/20 text-orange-400 border border-orange-500/30';
                        if (sig.includes('é‡‘å‰')) colorClass = 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30';
                        if (sig.includes('æŠ„åº•')) colorClass = 'bg-blue-500/20 text-blue-400 border border-blue-500/30';
                        
                        signalsHtml += `<span class="text-[10px] px-1.5 py-0.5 rounded ${colorClass} mr-1">${sig}</span>`;
                    });
                }

                const div = document.createElement('div');
                div.className = "flex items-center justify-between p-2 hover:bg-slate-800/50 rounded-lg transition group cursor-pointer";
                div.onclick = () => { switchTab('chat'); quickAsk(`${item.Symbol} åˆ†æ`); };
                
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-slate-700 rounded-full flex items-center justify-center text-[10px] font-bold">${item.Symbol.substring(0, 1)}</div>
                        <div>
                            <div class="flex items-center gap-2">
                                <div class="font-medium text-sm">${item.Symbol}</div>
                                <div class="flex">${signalsHtml}</div>
                            </div>
                            <div class="text-[10px] text-slate-500">$${parseFloat(item.Close).toFixed(4)}</div>
                        </div>
                    </div>
                    <div class="text-sm font-semibold ${key === 'RSI_14' ? (val > 70 ? 'text-red-400' : (val < 40 ? 'text-green-400' : 'text-slate-300')) : (val > 0 ? 'text-green-400' : 'text-red-400')}">
                        ${val.toFixed(2)}${unit}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // ========== è‡ªé¸æ¸…å–®åŠŸèƒ½ ==========
        let currentUserId = 'guest'; // é è¨­ç”¨æˆ¶ IDï¼Œç™»å…¥å¾Œæœƒæ›´æ–°
        let chart = null;
        let candleSeries = null;

        // æ›´æ–° Pi ç™»å…¥å¾Œçš„ç”¨æˆ¶ ID
        function updateUserId(uid) {
            currentUserId = uid || 'guest';
        }

        // ç²å–ä¸¦é¡¯ç¤ºè‡ªé¸æ¸…å–®
        async function refreshWatchlist() {
            const container = document.getElementById('watchlist-container');
            container.innerHTML = '<div class="glass-card rounded-xl p-6 text-center"><div class="animate-pulse">è¼‰å…¥ä¸­...</div></div>';

            try {
                const res = await fetch(`/api/watchlist/${currentUserId}`);
                const data = await res.json();

                if (!data.symbols || data.symbols.length === 0) {
                    container.innerHTML = `
                        <div class="glass-card rounded-xl p-6 text-center text-slate-400">
                            <i data-lucide="star" class="w-12 h-12 mx-auto mb-3 opacity-30"></i>
                            <p>æ‚¨é‚„æ²’æœ‰æ”¶è—ä»»ä½•å¹£ç¨®</p>
                            <p class="text-sm mt-2">åœ¨ AI åˆ†æçµæœä¸­é»æ“Š â­ æŒ‰éˆ•ä¾†æ”¶è—</p>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                container.innerHTML = '';
                for (const symbol of data.symbols) {
                    const card = document.createElement('div');
                    card.className = 'glass-card rounded-xl p-4 hover:bg-slate-800/50 transition cursor-pointer';
                    card.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-purple-600 rounded-full flex items-center justify-center font-bold">
                                    ${symbol.replace('USDT', '').substring(0, 2)}
                                </div>
                                <div>
                                    <div class="font-semibold">${symbol}</div>
                                    <div class="text-xs text-slate-400">é»æ“ŠæŸ¥çœ‹åœ–è¡¨</div>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="event.stopPropagation(); showChart('${symbol}')" class="p-2 bg-blue-600/20 text-blue-400 rounded-lg hover:bg-blue-600/30 transition" title="æŸ¥çœ‹åœ–è¡¨">
                                    <i data-lucide="trending-up" class="w-4 h-4"></i>
                                </button>
                                <button onclick="event.stopPropagation(); removeFromWatchlist('${symbol}')" class="p-2 bg-red-600/20 text-red-400 rounded-lg hover:bg-red-600/30 transition" title="ç§»é™¤">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    card.onclick = () => showChart(symbol);
                    container.appendChild(card);
                }
                lucide.createIcons();
            } catch (err) {
                console.error('Failed to load watchlist:', err);
                container.innerHTML = '<div class="glass-card rounded-xl p-6 text-center text-red-400">è¼‰å…¥å¤±æ•—</div>';
            }
        }

        // æ·»åŠ åˆ°è‡ªé¸æ¸…å–®
        async function addToWatchlist(symbol) {
            try {
                const res = await fetch('/api/watchlist/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentUserId, symbol: symbol })
                });
                const data = await res.json();
                if (data.success) {
                    alert(`âœ… ${symbol} å·²åŠ å…¥è‡ªé¸æ¸…å–®ï¼`);
                }
            } catch (err) {
                console.error('Failed to add to watchlist:', err);
            }
        }

        // å¾è‡ªé¸æ¸…å–®ç§»é™¤
        async function removeFromWatchlist(symbol) {
            if (!confirm(`ç¢ºå®šè¦ç§»é™¤ ${symbol} å—ï¼Ÿ`)) return;
            try {
                const res = await fetch('/api/watchlist/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentUserId, symbol: symbol })
                });
                const data = await res.json();
                if (data.success) {
                    refreshWatchlist();
                }
            } catch (err) {
                console.error('Failed to remove from watchlist:', err);
            }
        }

        // ========== TradingView åœ–è¡¨åŠŸèƒ½ ==========
        async function showChart(symbol) {
            const chartSection = document.getElementById('chart-section');
            const chartContainer = document.getElementById('chart-container');
            const chartTitle = document.getElementById('chart-title');

            chartSection.classList.remove('hidden');
            chartTitle.textContent = symbol;
            chartContainer.innerHTML = '<div class="flex items-center justify-center h-full"><div class="animate-pulse text-slate-400">è¼‰å…¥åœ–è¡¨ä¸­...</div></div>';

            try {
                const res = await fetch('/api/klines', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: symbol, interval: '1d', limit: 100 })
                });
                const data = await res.json();

                if (!data.klines || data.klines.length === 0) {
                    chartContainer.innerHTML = '<div class="flex items-center justify-center h-full text-red-400">ç„¡æ³•è¼‰å…¥æ•¸æ“š</div>';
                    return;
                }

                // æ¸…ç©ºå®¹å™¨ä¸¦å‰µå»ºåœ–è¡¨
                chartContainer.innerHTML = '';

                if (chart) {
                    chart.remove();
                }

                chart = LightweightCharts.createChart(chartContainer, {
                    width: chartContainer.clientWidth,
                    height: 380,
                    layout: {
                        background: { type: 'solid', color: 'transparent' },
                        textColor: '#94a3b8',
                    },
                    grid: {
                        vertLines: { color: 'rgba(51, 65, 85, 0.3)' },
                        horzLines: { color: 'rgba(51, 65, 85, 0.3)' },
                    },
                    crosshair: {
                        mode: LightweightCharts.CrosshairMode.Normal,
                    },
                    rightPriceScale: {
                        borderColor: '#334155',
                    },
                    timeScale: {
                        borderColor: '#334155',
                        timeVisible: true,
                    },
                });

                candleSeries = chart.addCandlestickSeries({
                    upColor: '#22c55e',
                    downColor: '#ef4444',
                    borderDownColor: '#ef4444',
                    borderUpColor: '#22c55e',
                    wickDownColor: '#ef4444',
                    wickUpColor: '#22c55e',
                });

                candleSeries.setData(data.klines);
                chart.timeScale().fitContent();

                // éŸ¿æ‡‰å¼èª¿æ•´
                window.addEventListener('resize', () => {
                    if (chart) {
                        chart.applyOptions({ width: chartContainer.clientWidth });
                    }
                });

            } catch (err) {
                console.error('Failed to load chart:', err);
                chartContainer.innerHTML = '<div class="flex items-center justify-center h-full text-red-400">åœ–è¡¨è¼‰å…¥å¤±æ•—</div>';
            }
        }

        // ========== Market Pulse Logic ==========
        async function checkMarketPulse() {
            const symbols = ['BTC', 'ETH', 'SOL', 'PI'];
            const randomSymbol = symbols[Math.floor(Math.random() * symbols.length)];
            const ticker = document.getElementById('market-pulse');
            const content = document.getElementById('pulse-content');
            
            try {
                const res = await fetch(`/api/market-pulse/${randomSymbol}`);
                const data = await res.json();
                
                if (data.explanation) {
                    // Extract unique sources
                    const sources = [...new Set(data.news_sources.map(n => n.source.split(' ')[0]))].join(', ');
                    
                    content.textContent = `${data.symbol}: ${data.explanation} (${data.change_1h > 0 ? '+' : ''}${data.change_1h.toFixed(2)}%)`;
                    content.title = `è³‡è¨Šä¾†æº: ${sources || 'AI Market Analysis'}`; // Tooltip
                    ticker.classList.remove('hidden');
                }
            } catch (e) {
                console.error("Pulse check failed", e);
            }
        }

        // ========== Social & Prediction Logic ==========
        async function refreshSocial() {
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-4 text-center animate-pulse">è¼‰å…¥æ’è¡Œæ¦œä¸­...</td></tr>';
            
            try {
                const res = await fetch('/api/social/leaderboard');
                const data = await res.json();
                const list = data.leaderboard || [];
                
                tbody.innerHTML = '';
                if (list.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-4 text-center text-slate-500">æš«ç„¡æ•¸æ“š</td></tr>';
                    return;
                }
                
                list.forEach((user, idx) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-slate-700/50 hover:bg-slate-800/30';
                    row.innerHTML = `
                        <td class="px-4 py-3 font-bold ${idx < 3 ? 'text-yellow-400' : 'text-slate-400'}">#${idx + 1}</td>
                        <td class="px-4 py-3 font-medium text-white">${user.username}</td>
                        <td class="px-4 py-3">${user.win_rate.toFixed(1)}%</td>
                        <td class="px-4 py-3 text-slate-400 text-xs">${user.wins} / ${user.total_predictions}</td>
                        <td class="px-4 py-3 ${user.avg_pnl > 0 ? 'text-green-400' : 'text-red-400'}">${user.avg_pnl.toFixed(2)}%</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-4 text-center text-red-400">è¼‰å…¥å¤±æ•—</td></tr>';
            }
        }

        async function submitPrediction(direction) {
            const symbol = document.getElementById('predict-symbol').value.toUpperCase();
            if (!symbol) return alert("è«‹è¼¸å…¥å¹£ç¨®");
            
            if (!currentUserId || currentUserId === 'guest') {
                return alert("è«‹å…ˆç™»å…¥ Pi å¸³æˆ¶æ‰èƒ½åƒèˆ‡é æ¸¬ (ç›®å‰ç‚º Guest æ¨¡å¼)");
            }
            
            try {
                const res = await fetch('/api/social/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUserId,
                        username: document.getElementById('settings-user').innerText.replace('@', '') || 'Guest',
                        symbol: symbol,
                        direction: direction
                    })
                });
                const data = await res.json();
                if (data.success) {
                    alert(`âœ… é æ¸¬æˆåŠŸï¼é€²å ´åƒ¹: $${data.entry_price}`);
                    refreshSocial();
                } else {
                    alert("é æ¸¬å¤±æ•—: " + data.detail);
                }
            } catch (e) {
                alert("æäº¤å¤±æ•—");
            }
        }

        // ========== Backtest Logic ==========
        function openBacktestModal() {
            document.getElementById('backtest-modal').classList.remove('hidden');
        }

        async function runBacktest() {
            const symbol = document.getElementById('bt-symbol').value;
            const strategy = document.getElementById('bt-strategy').value;
            const resultDiv = document.getElementById('bt-result');
            
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<div class="animate-pulse">å›æ¸¬ä¸­...</div>';
            
            try {
                const res = await fetch('/api/backtest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: symbol, signal_type: strategy, interval: '1h' })
                });
                const data = await res.json();
                
                if (data.error) throw new Error(data.error);
                
                const isProfitable = data.return_pct > 0;
                resultDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-white">${symbol} (${strategy})</span>
                        <span class="${isProfitable ? 'text-green-400' : 'text-red-400'} font-bold">${data.return_pct.toFixed(2)}%</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-xs text-slate-300">
                        <div>å‹ç‡: <span class="text-white">${data.win_rate.toFixed(1)}%</span></div>
                        <div>äº¤æ˜“æ¬¡æ•¸: <span class="text-white">${data.total_trades}</span></div>
                        <div>æœ€å¤§å›æ’¤: <span class="text-red-400">${data.max_drawdown.toFixed(2)}%</span></div>
                        <div>æ·¨åˆ©: <span class="${isProfitable ? 'text-green-400' : 'text-red-400'}">$${(data.final_capital - data.initial_capital).toFixed(2)}</span></div>
                    </div>
                `;
            } catch (e) {
                resultDiv.innerHTML = `<span class="text-red-400">å›æ¸¬å¤±æ•—: ${e.message}</span>`;
            }
        }

        // ========== AI Debate Visualization ==========
        async function showDebate(symbol) {
            const modal = document.getElementById('debate-modal');
            const bullArg = document.getElementById('bull-arg');
            const bearArg = document.getElementById('bear-arg');
            const verdict = document.getElementById('judge-verdict');
            
            modal.classList.remove('hidden');
            document.getElementById('debate-symbol').textContent = symbol;
            
            bullArg.innerHTML = '<div class="animate-pulse">AI ç ”ç©¶å“¡æ­£åœ¨åˆ†æ...</div>';
            bearArg.innerHTML = '<div class="animate-pulse">AI ç ”ç©¶å“¡æ­£åœ¨åˆ†æ...</div>';
            verdict.innerHTML = 'è£åˆ¤æ­£åœ¨å¯©æ ¸...';
            
            try {
                const res = await fetch(`/api/debate/${symbol}`);
                const data = await res.json();
                
                // Update Scores
                const bullScore = data.debate_judgment.bull_score;
                const bearScore = data.debate_judgment.bear_score;
                const total = bullScore + bearScore;
                const bullPct = (bullScore / total) * 100;
                
                document.getElementById('score-bull').style.width = `${bullPct}%`;
                document.getElementById('score-bear').style.width = `${100 - bullPct}%`;
                document.getElementById('score-val-bull').textContent = bullScore;
                document.getElementById('score-val-bear').textContent = bearScore;
                
                const winnerBadge = document.getElementById('winner-badge');
                if (data.debate_judgment.winning_stance === 'Bull') {
                    winnerBadge.textContent = 'å¤šé ­å‹å‡º ğŸ‚';
                    winnerBadge.className = 'px-3 py-1 bg-green-600/20 text-green-400 rounded-lg text-sm border border-green-600/50';
                } else if (data.debate_judgment.winning_stance === 'Bear') {
                    winnerBadge.textContent = 'ç©ºé ­å‹å‡º ğŸ»';
                    winnerBadge.className = 'px-3 py-1 bg-red-600/20 text-red-400 rounded-lg text-sm border border-red-600/50';
                } else {
                    winnerBadge.textContent = 'å¹³å±€ âš–ï¸';
                    winnerBadge.className = 'px-3 py-1 bg-slate-600/20 text-slate-400 rounded-lg text-sm border border-slate-600/50';
                }

                // Render Arguments
                bullArg.innerHTML = md.render(data.bull_argument.argument);
                bearArg.innerHTML = md.render(data.bear_argument.argument);
                verdict.innerHTML = md.render(data.debate_judgment.judge_rationale);
                
            } catch (e) {
                console.error(e);
                bullArg.textContent = 'è¼‰å…¥å¤±æ•—';
                bearArg.textContent = 'è¼‰å…¥å¤±æ•—';
            }
        }
        
        function closeDebate() {
            document.getElementById('debate-modal').classList.add('hidden');
        }

        // Expose globally
        window.showDebate = showDebate;
        if (Pi) {
            Pi.init({ version: "2.0", sandbox: true });
            Pi.authenticate(['username'], (payment) => {}).then(auth => {
                const userEl = document.getElementById('pi-user');
                userEl.innerHTML = `<span class="text-blue-400 font-medium">@${auth.user.username}</span>`;
                userEl.classList.remove('hidden');

                const settingsUserEl = document.getElementById('settings-user');
                if (settingsUserEl) settingsUserEl.innerText = "@" + auth.user.username;

                // æ›´æ–°ç”¨æˆ¶ ID ç”¨æ–¼è‡ªé¸æ¸…å–®
                updateUserId(auth.user.uid || auth.user.username);
            }).catch(err => console.error(err));
        }
    </script>
</body>
</html>
