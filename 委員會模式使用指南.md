# 🏛️ 委員會模式使用指南

## 📖 目錄

1. [什麼是委員會模式](#什麼是委員會模式)
2. [為什麼使用委員會模式](#為什麼使用委員會模式)
3. [快速開始](#快速開始)
4. [配置說明](#配置說明)
5. [運行示例](#運行示例)
6. [成本分析](#成本分析)
7. [最佳實踐](#最佳實踐)
8. [故障排除](#故障排除)

---

## 什麼是委員會模式

委員會模式是一種**多專家協作決策系統**，讓多個 AI 模型分別給出**同一方向**的觀點，然後由**綜合模型**整合成最終論證。

### 工作流程

```
┌─────────────────────────────────────────────────────────┐
│                  分析師報告 (4位)                        │
│  技術分析 | 情緒分析 | 基本面分析 | 新聞分析             │
└─────────────────────────────────────────────────────────┘
                          ↓
         ┌────────────────┴────────────────┐
         ↓                                  ↓
┌──────────────────┐              ┌──────────────────┐
│  多頭委員會      │              │  空頭委員會      │
├──────────────────┤              ├──────────────────┤
│ 1. GPT-4o        │              │ 1. o4-mini       │
│ 2. Claude 3.5    │              │ 2. Llama 70B     │
│ 3. Gemini Pro    │              │ 3. Qwen 72B      │
└──────────────────┘              └──────────────────┘
         ↓                                  ↓
┌──────────────────┐              ┌──────────────────┐
│  綜合模型        │              │  綜合模型        │
│  (GPT-4o)        │              │  (GPT-4o)        │
└──────────────────┘              └──────────────────┘
         ↓                                  ↓
┌──────────────────┐              ┌──────────────────┐
│  最終多頭論證    │              │  最終空頭論證    │
└──────────────────┘              └──────────────────┘
         └────────────────┬────────────────┘
                          ↓
                 ┌──────────────────┐
                 │   交易員決策     │
                 └──────────────────┘
```

---

## 為什麼使用委員會模式

### 🎯 核心優勢

#### 1. **減少偏見**
```
單一模型: GPT-4o 可能對某些市場條件有固定偏好
委員會模式: 3個模型投票，消除單一模型偏見
```

#### 2. **提高可信度**
```
單一模型信心度: 75%
委員會一致意見: 85% (多數共識)
委員會分歧意見: 45% (降低信心，提醒風險)
```

#### 3. **發現盲點**
```
模型 A: 注重技術面突破
模型 B: 警告基本面風險
模型 C: 發現市場情緒變化
→ 綜合後得到全面觀點
```

#### 4. **專業多樣性**
```
GPT-4o:    商業化成熟，分析專業
Claude:    風險識別強，保守謹慎
Gemini:    長上下文，數據分析好
Llama:     開源社區，多樣觀點
```

---

## 快速開始

### 1. 安裝依賴

確保已安裝所有必要的包：

```bash
pip install openai python-dotenv pandas pydantic langgraph
```

### 2. 設置 API 金鑰

編輯 `.env` 文件：

```bash
# OpenAI API Key (必需)
OPENAI_API_KEY=sk-your-openai-key

# OpenRouter API Key (使用 OpenRouter 模型時必需)
OPENROUTER_API_KEY=sk-or-your-openrouter-key
```

### 3. 配置委員會模式

編輯 `config_simple.py`：

```python
# 啟用委員會模式
ENABLE_COMMITTEE_MODE = True

# 多頭委員會 (3個模型)
BULL_COMMITTEE_MODELS = [
    "openai:gpt-4o",                              # GPT-4o 多頭專家
    "openrouter:anthropic/claude-3.5-sonnet",     # Claude 多頭專家
    "openrouter:google/gemini-pro-1.5",           # Gemini 多頭專家
]

# 空頭委員會 (3個模型)
BEAR_COMMITTEE_MODELS = [
    "openai:o4-mini",                                     # o4-mini 空頭專家
    "openrouter:meta-llama/llama-3.1-70b-instruct",       # Llama 空頭專家
    "openrouter:qwen/qwen-2.5-72b-instruct",              # Qwen 空頭專家
]

# 綜合模型 (整合委員會意見)
SYNTHESIS_MODEL = "openai:gpt-4o"
```

### 4. 運行分析

```bash
# 使用命令行
python main.py --symbol BTCUSDT

# 或使用聊天界面
python run_chat.py
```

---

## 配置說明

### 配置格式

使用簡化的 `"provider:model"` 格式：

```python
"openai:模型名"        # OpenAI 官方 API
"openrouter:模型全名"  # OpenRouter API
```

### 可用模型

#### OpenAI 官方模型

| 模型字符串 | 說明 | 特點 |
|-----------|------|------|
| `openai:gpt-4o` | GPT-4o | 最新多模態，分析專業 ⭐ |
| `openai:gpt-4o-mini` | GPT-4o Mini | 經濟版本 |
| `openai:o4-mini` | o4-mini | 深度推理 |

#### Anthropic Claude (via OpenRouter)

| 模型字符串 | 說明 | 特點 |
|-----------|------|------|
| `openrouter:anthropic/claude-3.5-sonnet` | Claude 3.5 Sonnet | 分析深入，風險識別強 ⭐ |
| `openrouter:anthropic/claude-3-opus` | Claude 3 Opus | 最強，但較貴 |
| `openrouter:anthropic/claude-3-haiku` | Claude 3 Haiku | 快速經濟 |

#### Google Gemini (via OpenRouter)

| 模型字符串 | 說明 | 特點 |
|-----------|------|------|
| `openrouter:google/gemini-pro-1.5` | Gemini Pro 1.5 | 長上下文，數據分析強 ⭐ |
| `openrouter:google/gemini-flash-1.5` | Gemini Flash 1.5 | 快速響應 |

#### Meta Llama (via OpenRouter)

| 模型字符串 | 說明 | 特點 |
|-----------|------|------|
| `openrouter:meta-llama/llama-3.1-405b-instruct` | Llama 3.1 405B | 最大開源模型 |
| `openrouter:meta-llama/llama-3.1-70b-instruct` | Llama 3.1 70B | 平衡性能成本 ⭐ |

#### 中國開源模型 (via OpenRouter)

| 模型字符串 | 說明 | 特點 |
|-----------|------|------|
| `openrouter:qwen/qwen-2.5-72b-instruct` | 通義千問 2.5 | 中文友好 ⭐ |
| `openrouter:deepseek/deepseek-chat` | DeepSeek Chat | 數學推理強 |

---

## 運行示例

### 示例 1: 三大商業模型 (質量最高)

```python
ENABLE_COMMITTEE_MODE = True

BULL_COMMITTEE_MODELS = [
    "openai:gpt-4o",
    "openrouter:anthropic/claude-3.5-sonnet",
    "openrouter:google/gemini-pro-1.5",
]

BEAR_COMMITTEE_MODELS = [
    "openai:o4-mini",
    "openrouter:anthropic/claude-3-opus",
    "openrouter:google/gemini-flash-1.5",
]

SYNTHESIS_MODEL = "openai:gpt-4o"
```

**預期輸出:**
```
[節點 3/7] 研究團隊 (多空辯論)...
  🏛️ 啟用委員會模式

  🏛️ 多頭委員會開始辯論 (3 位專家)...
    1. GPT-4o 正在分析...
       ✅ 完成 (信心度: 78%)
    2. Claude 3.5 Sonnet 正在分析...
       ✅ 完成 (信心度: 72%)
    3. Gemini Pro 1.5 正在分析...
       ✅ 完成 (信心度: 75%)
    🔄 正在綜合 3 位專家的觀點...
    ✅ 多頭委員會論證完成 (綜合信心度: 75%)

  🏛️ 空頭委員會開始辯論 (3 位專家)...
    1. o4-mini 正在分析...
       ✅ 完成 (信心度: 65%)
    2. Claude 3 Opus 正在分析...
       ✅ 完成 (信心度: 70%)
    3. Gemini Flash 1.5 正在分析...
       ✅ 完成 (信心度: 68%)
    🔄 正在綜合 3 位專家的觀點...
    ✅ 空頭委員會論證完成 (綜合信心度: 68%)

✅ 委員會辯論完成
```

---

### 示例 2: 全開源模型 (經濟實惠)

```python
ENABLE_COMMITTEE_MODE = True

BULL_COMMITTEE_MODELS = [
    "openrouter:meta-llama/llama-3.1-70b-instruct",
    "openrouter:qwen/qwen-2.5-72b-instruct",
    "openrouter:deepseek/deepseek-chat",
]

BEAR_COMMITTEE_MODELS = [
    "openrouter:meta-llama/llama-3.1-70b-instruct",
    "openrouter:qwen/qwen-2.5-72b-instruct",
    "openrouter:deepseek/deepseek-chat",
]

SYNTHESIS_MODEL = "openrouter:meta-llama/llama-3.1-70b-instruct"
```

**成本:** 約為商業模型的 1/5

---

### 示例 3: 關閉委員會模式（單一模型辯論）

```python
ENABLE_COMMITTEE_MODE = False
ENABLE_MULTI_MODEL_DEBATE = True

BULL_MODEL = "openai:gpt-4o"
BEAR_MODEL = "openai:o4-mini"
```

**預期輸出:**
```
[節點 3/7] 研究團隊 (多空辯論)...
  🎭 啟用多模型辯論
  🐂 多頭研究員使用模型: gpt-4o
  🐻 空頭研究員使用模型: o4-mini
✅ 多空辯論完成
```

---

## 成本分析

### 委員會模式成本計算

```
總成本 = (多頭委員會成員數 × 單次成本) +
         (空頭委員會成員數 × 單次成本) +
         (綜合模型調用次數 × 單次成本)
```

### 示例配置成本對比

| 配置 | 模型調用次數 | 相對成本 | 推薦場景 |
|------|-------------|---------|---------|
| 單一模型 | 2次 | 1x | 日常分析 |
| 多模型辯論 | 2次 | 1x | 日常分析 |
| 委員會 (3+3+2) | 8次 | 4x | 重要決策 |
| 委員會 (5+5+2) | 12次 | 6x | 重大決策 |

### 成本控制建議

#### 高頻日常分析
```python
ENABLE_COMMITTEE_MODE = False
BULL_MODEL = "openai:gpt-4o-mini"
BEAR_MODEL = "openai:gpt-4o-mini"
```
**成本:** 低

#### 中等重要決策
```python
ENABLE_COMMITTEE_MODE = False
BULL_MODEL = "openai:gpt-4o"
BEAR_MODEL = "openrouter:anthropic/claude-3.5-sonnet"
```
**成本:** 中

#### 重大投資決策
```python
ENABLE_COMMITTEE_MODE = True
BULL_COMMITTEE_MODELS = [
    "openai:gpt-4o",
    "openrouter:anthropic/claude-3.5-sonnet",
    "openrouter:google/gemini-pro-1.5",
]
# ... 完整委員會配置
```
**成本:** 高，**但可信度最高**

---

## 最佳實踐

### 1. 委員會成員選擇

#### ✅ 好的做法
```python
# 多樣性：不同公司的模型
BULL_COMMITTEE_MODELS = [
    "openai:gpt-4o",                              # OpenAI
    "openrouter:anthropic/claude-3.5-sonnet",     # Anthropic
    "openrouter:google/gemini-pro-1.5",           # Google
]
```

#### ❌ 不好的做法
```python
# 缺乏多樣性：全部同一家公司
BULL_COMMITTEE_MODELS = [
    "openai:gpt-4o",
    "openai:gpt-4o-mini",
    "openai:o4-mini",
]
```

---

### 2. 綜合模型選擇

#### ✅ 推薦
```python
# 使用強大的模型做綜合（重要！）
SYNTHESIS_MODEL = "openai:gpt-4o"
# 或
SYNTHESIS_MODEL = "openrouter:anthropic/claude-3.5-sonnet"
```

#### ❌ 不推薦
```python
# 不要用較弱的模型綜合
SYNTHESIS_MODEL = "openai:gpt-4o-mini"  # 綜合能力可能不足
```

---

### 3. 委員會規模

| 規模 | 成員數 | 優點 | 缺點 |
|------|-------|------|------|
| 小 | 2-3 | 成本低，速度快 | 多樣性有限 |
| 中 ⭐ | 3-4 | 平衡 | - |
| 大 | 5+ | 多樣性高 | 成本高，速度慢 |

**推薦:** 3-4 個成員是最佳平衡

---

### 4. 不同市場條件的配置

#### 牛市（樂觀市場）
```python
# 空頭委員會用更保守的模型
BEAR_COMMITTEE_MODELS = [
    "openrouter:anthropic/claude-3.5-sonnet",  # 保守
    "openrouter:anthropic/claude-3-opus",       # 極度保守
    "openai:o4-mini",                           # 深度推理
]
```

#### 熊市（悲觀市場）
```python
# 多頭委員會用更激進的模型
BULL_COMMITTEE_MODELS = [
    "openai:gpt-4o",                           # 創新
    "openrouter:google/gemini-pro-1.5",        # 數據驅動
    "openrouter:meta-llama/llama-3.1-70b-instruct",  # 開源視角
]
```

---

## 故障排除

### 問題 1: ImportError - 找不到 config_simple.py

**錯誤信息:**
```
⚠️ 未找到 config_simple.py，嘗試使用傳統配置...
```

**解決方案:**
1. 確認 `config_simple.py` 存在於項目根目錄
2. 檢查文件權限
3. 如果文件存在但仍報錯，檢查 Python 路徑：
   ```bash
   python -c "import sys; print(sys.path)"
   ```

---

### 問題 2: API Key 錯誤

**錯誤信息:**
```
❌ 失敗: Unauthorized - Invalid API Key
```

**解決方案:**
1. 檢查 `.env` 文件是否正確設置
2. 確認 API Key 有效且有足夠額度
3. OpenRouter 用戶檢查：
   ```bash
   echo $OPENROUTER_API_KEY
   ```

---

### 問題 3: 模型不可用

**錯誤信息:**
```
❌ 失敗: Model not found
```

**解決方案:**
1. 檢查模型名稱是否正確
2. 查看 OpenRouter 文檔確認模型是否可用:
   https://openrouter.ai/models
3. 某些模型可能需要特殊權限

---

### 問題 4: 委員會某個成員失敗

**場景:**
```
  🏛️ 多頭委員會開始辯論 (3 位專家)...
    1. GPT-4o 正在分析...
       ✅ 完成 (信心度: 78%)
    2. Claude 3.5 Sonnet 正在分析...
       ❌ 失敗: Timeout
    3. Gemini Pro 1.5 正在分析...
       ✅ 完成 (信心度: 75%)
```

**影響:**
系統會**自動跳過失敗的成員**，用剩餘成員的意見進行綜合。

**解決方案:**
1. 檢查該模型的 API 狀態
2. 如果經常失敗，考慮更換為更穩定的模型
3. 確保網絡連接穩定

---

### 問題 5: 綜合信心度異常低

**場景:**
```
✅ 多頭委員會論證完成 (綜合信心度: 35%)
```

**原因:**
委員會成員意見分歧很大，系統降低了綜合信心度。

**這是好事！** 說明模型們對市場看法不一致，建議謹慎決策。

---

## 檢查清單

在啟用委員會模式前，確保：

- [ ] ✅ 已安裝所有依賴包
- [ ] ✅ 已設置 `OPENAI_API_KEY`
- [ ] ✅ 已設置 `OPENROUTER_API_KEY` (如果使用 OpenRouter)
- [ ] ✅ 已配置 `config_simple.py`
- [ ] ✅ 設置 `ENABLE_COMMITTEE_MODE = True`
- [ ] ✅ 配置了多頭委員會 (至少2個成員)
- [ ] ✅ 配置了空頭委員會 (至少2個成員)
- [ ] ✅ 配置了綜合模型
- [ ] ✅ 測試過 API 連接正常 (`python test_committee.py`)
- [ ] ✅ 了解各模型的成本
- [ ] ✅ 已閱讀本使用指南

---

## 快速參考

### 配置模板

```python
# config_simple.py

# === 基礎配置 ===
ENABLE_MULTI_MODEL_DEBATE = True
ENABLE_COMMITTEE_MODE = True  # 啟用委員會模式

# === 委員會配置 ===
BULL_COMMITTEE_MODELS = [
    "openai:gpt-4o",
    "openrouter:anthropic/claude-3.5-sonnet",
    "openrouter:google/gemini-pro-1.5",
]

BEAR_COMMITTEE_MODELS = [
    "openai:o4-mini",
    "openrouter:meta-llama/llama-3.1-70b-instruct",
    "openrouter:qwen/qwen-2.5-72b-instruct",
]

SYNTHESIS_MODEL = "openai:gpt-4o"
```

### 運行命令

```bash
# 測試委員會模式
python test_committee.py

# 查看當前配置
python model_parser.py

# 運行分析
python main.py --symbol BTCUSDT

# 聊天界面
python run_chat.py
```

---

**🎉 現在你已經準備好使用委員會模式進行高質量的加密貨幣投資分析了！**

需要幫助？查看其他文檔：
- `多模型辯論配置指南.md` - 多模型配置詳解
- `多空辯論機制說明.md` - 辯論機制原理
- `CHAT_README.md` - 聊天界面使用說明
