# é†«ç™‚ AI Agent ç³»çµ±äº¤æ¥æ–‡ä»¶

**å°ˆæ¡ˆåç¨±**: Medical AI Agent System (Taiwan Infectious Disease & Health Education)
**ç³»çµ±è·¯å¾‘**: `/home/danny/AI-agent/Agent_System`
**æœ€å¾Œæ›´æ–°**: 2026-01-08
**äº¤æ¥äºº**: Danny

---

## ç›®éŒ„

0. [ä¼ºæœå™¨ç’°å¢ƒèˆ‡ç¡¬é«”è¦æ ¼](#0-ä¼ºæœå™¨ç’°å¢ƒèˆ‡ç¡¬é«”è¦æ ¼)
1. [ç³»çµ±æ¦‚è§€](#1-ç³»çµ±æ¦‚è§€)
2. [æŠ€è¡“æ¶æ§‹](#2-æŠ€è¡“æ¶æ§‹)
3. [ç›®éŒ„çµæ§‹èˆ‡æª”æ¡ˆèªªæ˜](#3-ç›®éŒ„çµæ§‹èˆ‡æª”æ¡ˆèªªæ˜)
4. [æ ¸å¿ƒçµ„ä»¶è©³è§£](#4-æ ¸å¿ƒçµ„ä»¶è©³è§£)
5. [å·¥ä½œæµç¨‹è©³è§£](#5-å·¥ä½œæµç¨‹è©³è§£)
6. [è³‡æ–™åº«æ¶æ§‹](#6-è³‡æ–™åº«æ¶æ§‹)
7. [é…ç½®ç³»çµ±](#7-é…ç½®ç³»çµ±)
8. [éƒ¨ç½²èˆ‡å•Ÿå‹•](#8-éƒ¨ç½²èˆ‡å•Ÿå‹•)
9. [ç¶­è­·æŒ‡å—](#9-ç¶­è­·æŒ‡å—)
10. [å¸¸è¦‹å•é¡Œæ’æŸ¥](#10-å¸¸è¦‹å•é¡Œæ’æŸ¥)

---

## 0. ä¼ºæœå™¨ç’°å¢ƒèˆ‡ç¡¬é«”è¦æ ¼

### 0.1 ä¼ºæœå™¨åŸºæœ¬è³‡è¨Š

| é …ç›® | è¦æ ¼ |
|------|------|
| **ä¸»æ©Ÿåç¨±** | `ai-infer2` |
| **å…§ç¶² IP (ç®¡ç†)** | `172.23.53.2` |
| **å…§ç¶² IP (API)** | `172.23.37.2` |
| **ä½œæ¥­ç³»çµ±** | Ubuntu 20.04.6 LTS (Focal Fossa) |
| **æ ¸å¿ƒç‰ˆæœ¬** | 5.4.0-182-generic |
| **ç³»çµ±è·¯å¾‘** | `/home/danny/AI-agent/` |

### 0.2 ç¡¬é«”è¦æ ¼

| é …ç›® | è¦æ ¼ |
|------|------|
| **CPU** | Intel(R) Xeon(R) Gold 6248 @ 2.50GHz |
| **CPU æ ¸å¿ƒæ•¸** | 80 æ ¸å¿ƒï¼ˆé›™è·¯ 40 æ ¸å¿ƒï¼‰ |
| **ç³»çµ±è¨˜æ†¶é«”** | 376 GB DDR4 |
| **GPU** | 8 x NVIDIA Tesla V100-SXM2-32GB |
| **GPU ç¸½é¡¯å­˜** | 256 GB (8 x 32GB) |
| **GPU Driver** | 535.129.03 |
| **CUDA ç‰ˆæœ¬** | å°æ‡‰ Driver ç‰ˆæœ¬ |

### 0.3 æœå‹™ç«¯å£é…ç½®

| æœå‹™ | ç«¯å£ | èªªæ˜ | ä½¿ç”¨çš„ GPU |
|------|------|------|------------|
| **vLLM LLM Server** | `8080` | Qwen3-4B-2507 æ¨è«–æœå‹™ | GPU 6, 7 (tensor-parallel-size=2) |
| **vLLM Embedding Server** | `8081` | Qwen3-Embedding-4B å‘é‡åŒ–æœå‹™ | GPU 4, 5 (tensor-parallel-size=2) |
| **FastAPI Server** | `8100` | é†«ç™‚ AI Agent API æœå‹™ | - |
| **PostgreSQL** | `5432` | pgvector å‘é‡è³‡æ–™åº« | - |
| **Langfuse Web** | `3000` | LLM è¿½è¹¤ç›£æ§ UI | - |
| **Langfuse Worker** | `3030` | Langfuse èƒŒæ™¯è™•ç†æœå‹™ | - |
| **Redis/Valkey** | `6379` | å¿«å–æœå‹™ | - |
| **MinIO** | `9090` | Langfuse ç‰©ä»¶å„²å­˜ | - |
| **ClickHouse** | `8123` (HTTP), `9000` (Native) | Langfuse è¿½è¹¤è³‡æ–™åˆ†æ (OLAP åˆ—å¼è³‡æ–™åº«) | - |

### 0.4 Python ç’°å¢ƒèˆ‡å¥—ä»¶ç‰ˆæœ¬

> è™›æ“¬ç’°å¢ƒè©³ç´°èªªæ˜è¦‹ [3.1 Python è™›æ“¬ç’°å¢ƒ](#31-python-è™›æ“¬ç’°å¢ƒ)

#### langchain_postgres é«˜ç¶­åº¦ä¿®å¾© (HNSW > 2000 ç¶­)

ç”±æ–¼ä½¿ç”¨ Qwen3-Embedding-4Bï¼ˆ2560 ç¶­ï¼‰ï¼Œéœ€ä¿®æ”¹ `langchain_postgres` åº•å±¤ç¨‹å¼ç¢¼ã€‚

**å•é¡Œ**ï¼šPostgreSQL HNSW ç´¢å¼•é™åˆ¶ 2000 ç¶­ï¼Œæœƒå ±éŒ¯ï¼š
```
column cannot have more than 2000 dimensions for hnsw index
```

**ä¿®å¾©æª”æ¡ˆ**ï¼š`.venv/lib/python3.12/site-packages/langchain_postgres/vectorstores.py`

**ä¿®æ”¹æ­¥é©Ÿ**ï¼š

1. ç¬¬ 109 è¡Œå·¦å³ï¼Œä¿®æ”¹ importï¼š
   ```python
   # åŸæœ¬
   from pgvector.sqlalchemy import Vector
   # æ”¹ç‚º
   from pgvector.sqlalchemy import Vector, HALFVEC
   ```

2. ç¬¬ 214 è¡Œå·¦å³ï¼Œä¿®æ”¹æ¬„ä½å®šç¾©ï¼š
   ```python
   # åŸæœ¬
   embedding: Vector = sqlalchemy.Column(Vector(vector_dimension))
   # æ”¹ç‚º
   embedding: HALFVEC = sqlalchemy.Column(HALFVEC(dim=vector_dimension))
   ```

> âš ï¸ **é‡æ–°å®‰è£å¥—ä»¶å¾Œéœ€é‡æ–°å¥—ç”¨æ­¤ä¿®å¾©ï¼**
>
> è©³ç´°èªªæ˜è«‹åƒè€ƒï¼š`/home/danny/AI-agent/LANGCHAIN_POSTGRES_PATCH.txt`

### 0.5 AI æ¨¡å‹ç¸½è¦½

æœ¬ç³»çµ±ä½¿ç”¨ä»¥ä¸‹å››å€‹ AI æ¨¡å‹ï¼š

| æ¨¡å‹ | ç”¨é€” | æœ¬åœ°è·¯å¾‘ | GPU | æœå‹™æ–¹å¼ |
|------|------|----------|-----|----------|
| **Qwen3-4B-Instruct-2507** | ä¸»è¦ LLMï¼ˆå•ç­”ã€è¦åŠƒã€é©—è­‰ï¼‰ | `/home/danny/AI-agent/Qwen3_4B_2507` | GPU 6-7 | vLLM (Port 8080) |
| **Qwen3-Embedding-4B** | æ–‡æœ¬å‘é‡åŒ–ï¼ˆ2560 ç¶­ï¼‰ | `/home/danny/AI-agent/Qwen3-Embedding-4B` | GPU 4-5 | vLLM (Port 8081) |
| **DeepSeek-OCR** | PDF æ–‡å­—è­˜åˆ¥ã€è¡¨æ ¼æ“·å– | `/home/danny/AI-agent/deepseek_ocr` | GPU 0 | Python ç›´æ¥è¼‰å…¥ |
| **Qwen3-VL-4B-Instruct** | è¡›æ•™åœ–ç‰‡åˆ†æèˆ‡ç¯©é¸ | `/home/danny/AI-agent/Qwen3_4b_VL` | GPU 1 | Python ç›´æ¥è¼‰å…¥ |

#### æ¨¡å‹è©³ç´°è³‡è¨Š

**1. Qwen3-4B-Instruct-2507ï¼ˆä¸»è¦ LLMï¼‰**

- **HuggingFace**: https://huggingface.co/Qwen/Qwen3-4B-Instruct-2507
- **ç”¨é€”**: ç³»çµ±çš„æ ¸å¿ƒèªè¨€æ¨¡å‹ï¼Œè² è²¬ï¼š
  - å•é¡Œåˆ†é¡ï¼ˆclassify_query_typeï¼‰
  - æŸ¥è©¢è¦åŠƒï¼ˆplanning_nodeï¼‰
  - å›ç­”ç”Ÿæˆï¼ˆgenerate_responseï¼‰
  - å›ç­”é©—è­‰ï¼ˆvalidate_answerï¼‰
  - å›ç­”ç²¾ç…‰ï¼ˆrefine_answerï¼‰
- **æœå‹™æ–¹å¼**: é€é vLLM æä¾› OpenAI ç›¸å®¹ APIï¼ˆPort 8080ï¼‰
- **ç‰¹æ®Šåƒæ•¸**: å•Ÿç”¨ `--enable-auto-tool-choice --tool-call-parser hermes` æ”¯æ´å·¥å…·èª¿ç”¨

**2. Qwen3-Embedding-4Bï¼ˆå‘é‡åŒ–æ¨¡å‹ï¼‰**

- **HuggingFace**: https://huggingface.co/Qwen/Qwen3-Embedding-4B
- **ç”¨é€”**: å°‡æ–‡æœ¬è½‰æ›ç‚º 2560 ç¶­å‘é‡ï¼Œç”¨æ–¼ï¼š
  - PDF/JSONL è³‡æ–™å…¥åº«æ™‚çš„å‘é‡åŒ–
  - ç”¨æˆ¶æŸ¥è©¢çš„å‘é‡åŒ–
  - èªç¾©ç›¸ä¼¼åº¦æª¢ç´¢
- **æœå‹™æ–¹å¼**: é€é vLLM æä¾› OpenAI ç›¸å®¹ Embedding APIï¼ˆPort 8081ï¼‰
- **æ³¨æ„äº‹é …**: å› ç¶­åº¦ > 2000ï¼Œéœ€ä¿®æ”¹ `langchain_postgres` ä½¿ç”¨ HALFVECï¼ˆè¦‹ 0.4 ç¯€ï¼‰

**3. DeepSeek-OCRï¼ˆæ–‡å­—è­˜åˆ¥æ¨¡å‹ï¼‰**

- **HuggingFace**: https://huggingface.co/deepseek-ai/DeepSeek-OCR
- **ç”¨é€”**: PDF æ–‡ä»¶çš„ OCR è™•ç†ï¼ŒåŒ…æ‹¬ï¼š
  - é é¢æ–‡å­—è­˜åˆ¥
  - è¡¨æ ¼çµæ§‹è­˜åˆ¥èˆ‡ HTML è¼¸å‡º
  - åœ–ç‰‡/åœ–è¡¨å€åŸŸåµæ¸¬
- **ä½¿ç”¨ä½ç½®**:
  - `data_process/unified_advanced_loader_stop.py`ï¼ˆçµ±ä¸€è¼‰å…¥å™¨ï¼‰
  - `data_process/ingest_dialysis_pdf.py`ï¼ˆæ´—è…è¡›æ•™è™•ç†ï¼‰
  - `data_process/ingest_general_medical.py`ï¼ˆé†«ç™‚ PDF è™•ç†ï¼‰
- **è¼‰å…¥æ–¹å¼**: Python ç›´æ¥è¼‰å…¥ï¼ˆé vLLM æœå‹™ï¼‰
- **transformers ç‰ˆæœ¬**: éœ€è¦ `4.46.3`

**4. Qwen3-VL-4B-Instructï¼ˆè¦–è¦ºèªè¨€æ¨¡å‹ï¼‰**

- **HuggingFace**: https://huggingface.co/Qwen/Qwen3-VL-4B-Instruct
- **ç”¨é€”**: è¡›æ•™åœ–ç‰‡çš„æ™ºèƒ½åˆ†æèˆ‡ç¯©é¸ï¼š
  - åˆ†æåœ–ç‰‡å…§å®¹ï¼ˆå¥åº·ä¸»é¡Œã€åˆ†é¡ï¼‰
  - åˆ¤æ–·åœ–ç‰‡æ˜¯å¦é©åˆæ°‘çœ¾é–±è®€
  - è©•ä¼°åœ–ç‰‡è¡›æ•™åƒ¹å€¼ï¼ˆ1-5 åˆ†ï¼‰
  - éæ¿¾ä½å“è³ª/è£é£¾æ€§åœ–ç‰‡
- **ä½¿ç”¨ä½ç½®**: `data_process/ingest_health_images.py`
- **è¼‰å…¥æ–¹å¼**: Python ç›´æ¥è¼‰å…¥ï¼ˆé vLLM æœå‹™ï¼‰
- **transformers ç‰ˆæœ¬**: éœ€è¦ `4.57.0`

#### GPU åˆ†é…ç¸½è¦½

```
GPU 0   : DeepSeek-OCRï¼ˆPDF æ–‡å­—è­˜åˆ¥ï¼‰
GPU 1   : Qwen3-VL-4B-Instructï¼ˆåœ–ç‰‡åˆ†æï¼‰
GPU 2-3 : ä¿ç•™ / å…¶ä»–ç”¨é€”
GPU 4-5 : vLLM Embedding æœå‹™ï¼ˆQwen3-Embedding-4Bï¼‰
GPU 6-7 : vLLM LLM æœå‹™ï¼ˆQwen3-4B-Instruct-2507ï¼‰
```

#### transformers ç‰ˆæœ¬è¡çªè™•ç†

> ä¸åŒæ¨¡å‹éœ€è¦ä¸åŒç‰ˆæœ¬çš„ transformersï¼Œè©³è¦‹ [3.1 Python è™›æ“¬ç’°å¢ƒ](#31-python-è™›æ“¬ç’°å¢ƒ)

---

### 0.6 vLLM æœå‹™ç®¡ç†

vLLM æœå‹™é€éç®¡ç†è…³æœ¬é€²è¡Œæ§åˆ¶ï¼š

#### æª”æ¡ˆä½ç½®

| æª”æ¡ˆ | è·¯å¾‘ | èªªæ˜ |
|------|------|------|
| **ç®¡ç†è…³æœ¬** | `/home/danny/AI-agent/Agent_System/vllm_sh.sh` | å®Œæ•´ç®¡ç†è…³æœ¬ï¼ˆæ¨è–¦ä½¿ç”¨ï¼‰ |
| **LLM æ—¥èªŒ** | `/home/danny/AI-agent/vllm/vllm_8080.log` | Qwen3-4B æœå‹™æ—¥èªŒ |
| **LLM PID** | `/home/danny/AI-agent/vllm/vllm_8080.pid` | Qwen3-4B æœå‹™ PID |
| **Embedding æ—¥èªŒ** | `/home/danny/AI-agent/vllm/vllm_8081.log` | Embedding æœå‹™æ—¥èªŒ |
| **Embedding PID** | `/home/danny/AI-agent/vllm/vllm_8081.pid` | Embedding æœå‹™ PID |

#### ç®¡ç†å‘½ä»¤

```bash
cd /home/danny/AI-agent/Agent_System

# æŸ¥çœ‹æœå‹™ç‹€æ…‹
./vllm_sh.sh status

# å•Ÿå‹•æ‰€æœ‰æœå‹™
./vllm_sh.sh start all

# å•Ÿå‹•å–®ä¸€æœå‹™
./vllm_sh.sh start qwen    # å•Ÿå‹• LLM (8080)
./vllm_sh.sh start embed   # å•Ÿå‹• Embedding (8081)

# åœæ­¢æœå‹™
./vllm_sh.sh stop all
./vllm_sh.sh stop 8080
./vllm_sh.sh stop 8081

# é‡å•Ÿæœå‹™
./vllm_sh.sh restart all

# æŸ¥çœ‹æ—¥èªŒï¼ˆæœ€å¾Œ 100 è¡Œï¼‰
./vllm_sh.sh logs 8080 100
./vllm_sh.sh logs 8081 100
```

#### vLLM å•Ÿå‹•åƒæ•¸èªªæ˜

**LLM æœå‹™ (Port 8080) - Qwen3-4B-2507**

```bash
CUDA_VISIBLE_DEVICES=6,7 \
PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True \
VLLM_WORKER_MULTIPROC_METHOD=spawn \
VLLM_ATTENTION_BACKEND=XFORMERS \
VLLM_USE_V1=0 \
vllm serve /home/danny/AI-agent/Qwen3_4B_2507 \
  --tensor-parallel-size 2 \           # ä½¿ç”¨ 2 å¼µ GPU é€²è¡Œå¼µé‡ä¸¦è¡Œ
  --dtype float16 \                    # ä½¿ç”¨åŠç²¾åº¦æµ®é»
  --gpu-memory-utilization 0.9 \       # GPU è¨˜æ†¶é«”ä½¿ç”¨ç‡ 90%
  --max-model-len 32768 \              # æœ€å¤§åºåˆ—é•·åº¦ 32K
  --max-num-seqs 16 \                  # æœ€å¤§ä¸¦è¡Œåºåˆ—æ•¸
  --host 0.0.0.0 \                     # ç›£è½æ‰€æœ‰ä»‹é¢
  --port 8080 \
  --trust-remote-code \
  --enable-auto-tool-choice \          # å•Ÿç”¨è‡ªå‹•å·¥å…·é¸æ“‡
  --tool-call-parser hermes \          # Hermes æ ¼å¼å·¥å…·èª¿ç”¨è§£æ
  --disable-custom-all-reduce
```

**Embedding æœå‹™ (Port 8081) - Qwen3-Embedding-4B**

```bash
CUDA_VISIBLE_DEVICES=4,5 \
python -m vllm.entrypoints.openai.api_server \
  --model /home/danny/AI-agent/Qwen3-Embedding-4B \
  --task embed \                       # æŒ‡å®šç‚º embedding ä»»å‹™
  --dtype float16 \
  --port 8081 \
  --tensor-parallel-size 2 \
  --gpu-memory-utilization 0.9 \
  --enable-prefix-caching \            # å•Ÿç”¨å‰ç¶´å¿«å–ï¼ˆæé«˜æ•ˆèƒ½ï¼‰
  --max-model-len 8192                 # Embedding æœ€å¤§é•·åº¦ 8K
```

### 0.7 Langfuse V3 éƒ¨ç½²

Langfuse é€é Docker Compose éƒ¨ç½²ï¼Œé…ç½®æª”æ¡ˆä½æ–¼ `/home/danny/AI-agent/langfuse/docker-compose.yml`ã€‚

#### å•Ÿå‹• Langfuse

```bash
cd /home/danny/AI-agent/langfuse
docker-compose up -d
```

#### ä¸»è¦æœå‹™

| æœå‹™ | ç”¨é€” |
|------|------|
| `langfuse-web` | Web UI å’Œ API æœå‹™ (Port 3000) |
| `langfuse-worker` | èƒŒæ™¯è³‡æ–™è™•ç† (Port 3030) |
| `postgres` | Langfuse å…ƒè³‡æ–™å„²å­˜ |
| `clickhouse` | è¿½è¹¤è³‡æ–™åˆ†æå„²å­˜ |
| `minio` | ç‰©ä»¶å„²å­˜ (å¤§å‹ payload) |
| `redis` | ä½‡åˆ—å’Œå¿«å– |

#### å­˜å–æ–¹å¼

- **Web UI**: `http://172.23.53.2:3000`
- **API ç«¯é»**: `http://172.23.53.2:3000` (ç”¨æ–¼ SDK é€£æ¥)

### 0.8 ç³»çµ±è³‡æºç›£æ§

```bash
# æŸ¥çœ‹ GPU ä½¿ç”¨ç‹€æ³
nvidia-smi

# æŒçºŒç›£æ§ GPU
watch -n 1 nvidia-smi

# æŸ¥çœ‹è¨˜æ†¶é«”ä½¿ç”¨
free -h

# æŸ¥çœ‹ç£ç¢Ÿä½¿ç”¨
df -h

# æŸ¥çœ‹ç‰¹å®šæœå‹™ç«¯å£
lsof -i :8080
lsof -i :8081
lsof -i :8100
```

---

## 1. ç³»çµ±æ¦‚è§€

### 1.1 ç³»çµ±å®šä½

æœ¬ç³»çµ±æ˜¯ä¸€å€‹åŸºæ–¼ **LangGraph** çš„å¤šæ¨¡æ…‹é†«ç™‚å•ç­” Agentã€‚å®ƒä¸åªæ˜¯å‚³çµ±çš„ RAG (Retrieval-Augmented Generation) ç³»çµ±ï¼Œæ›´æ˜¯ä¸€å€‹å…·å‚™ã€Œæ€è€ƒã€è¦åŠƒã€åæ€ã€è‡ªæˆ‘ä¿®æ­£ã€èƒ½åŠ›çš„æ™ºèƒ½ Agentã€‚

### 1.2 æ ¸å¿ƒå·®ç•°åŒ–åŠŸèƒ½

| åŠŸèƒ½ | èªªæ˜ |
|------|------|
| **å‹•æ…‹è·¯ç”±** | æ ¹æ“šä½¿ç”¨è€…å•é¡Œè‡ªå‹•åˆ¤æ–·èµ°ã€ŒæŸ¥è³‡æ–™åº«ã€ã€ã€ŒæŸ¥ CDC å³æ™‚è³‡è¨Šã€ã€ã€ŒæŸ¥è¨˜æ†¶ã€æˆ–ã€Œé–’èŠã€è·¯å¾‘ |
| **å¤šæ¨¡æ…‹æª¢ç´¢** | æ–‡å­—ï¼šé€é pgvector æª¢ç´¢ PDF èˆ‡ JSONLï¼›è¦–è¦ºï¼šé€é OCR æª¢ç´¢ä¸¦é¡¯ç¤º PDF ä¸­çš„åœ–ç‰‡èˆ‡è¡¨æ ¼ |
| **Planning è¦åŠƒ** | è¤‡é›œå•é¡Œæœƒå…ˆç¶“é Planning ç¯€é»ï¼Œè‡ªå‹•åˆ†è§£æˆå¤šå€‹å­å•é¡Œé€æ­¥æª¢ç´¢ |
| **è‡ªæˆ‘ä¿®æ­£** | å…·å‚™ ValidationNodeï¼Œè‹¥å›ç­”ä¸å®Œæ•´æˆ–æœ‰å¹»è¦ºï¼Œæœƒè‡ªå‹•è§¸ç™¼é‡è©¦æˆ–ç¶²è·¯æœå°‹è£œå…… |
| **ä¸‰å±¤è¨˜æ†¶** | çŸ­æœŸè¨˜æ†¶ï¼ˆå°è©±æ­·å²ï¼‰ã€é•·æœŸè¨˜æ†¶ï¼ˆmem0 å€‹äººç—…å²ï¼‰ã€èªç¾©æ‘˜è¦ï¼ˆSummarizationNodeï¼‰ |
| **å³æ™‚æœå°‹** | å¯é¸æ“‡ä½¿ç”¨ CDCã€Googleã€DuckDuckGo å³æ™‚æœå°‹å·¥å…·ç²å–æœ€æ–°è³‡è¨Š |

### 1.3 ç³»çµ±èƒ½åŠ›ç¯„åœ

- å°ç£æ³•å®šå‚³æŸ“ç—…è³‡è¨ŠæŸ¥è©¢
- æ„ŸæŸ“ç®¡åˆ¶ç…§è­·æŒ‡å¼•
- æ´—è…è¡›æ•™è³‡è¨Š
- è¡›æ•™åœ’åœ°å¥åº·è³‡è¨Š
- å³æ™‚ç–«æƒ…è³‡è¨Šï¼ˆé€é CDC çˆ¬èŸ²ï¼‰

---

## 2. æŠ€è¡“æ¶æ§‹

### 2.1 ç³»çµ±æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ä½¿ç”¨è€…ä»‹é¢å±¤                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚  FastAPI Server     â”‚    â”‚  CLI æ¸¬è©¦å…¥å£        â”‚                          â”‚
â”‚  â”‚  (fastapi_main.py)  â”‚    â”‚  (langgraph_clean.py)â”‚                          â”‚
â”‚  â”‚  - /chat           â”‚    â”‚                      â”‚                          â”‚
â”‚  â”‚  - /chat/stream     â”‚    â”‚                      â”‚                          â”‚
â”‚  â”‚  - /api/config      â”‚    â”‚                      â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚             â”‚                          â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                          â”‚
              â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           LangGraph ç‹€æ…‹æ©Ÿå¼•æ“                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                         graph/graph_routing.py                          â”‚  â”‚
â”‚  â”‚  å®šç¾© FullStateï¼ˆ40+ æ¬„ä½ï¼‰ã€è·¯ç”±å‡½æ•¸ï¼ˆ11 å€‹æ¢ä»¶è·¯ç”±ï¼‰                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                         graph/graph_nodes.py                            â”‚  â”‚
â”‚  â”‚  å¯¦ç¾ 13 å€‹ç¯€é»ï¼šextract_current_query, retrieve_memory, classify_query, â”‚  â”‚
â”‚  â”‚  planning_node, retrieve_knowledge, generate_response, validate_answer...â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æ”¯æ´æ¨¡çµ„å±¤                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ retrieval/       â”‚  â”‚ tools/           â”‚  â”‚ utils/           â”‚            â”‚
â”‚  â”‚ - retrieval_utilsâ”‚  â”‚ - cdc_search_toolâ”‚  â”‚ - cache_manager  â”‚            â”‚
â”‚  â”‚ - clue_extractionâ”‚  â”‚ - google_search  â”‚  â”‚ - prompt_functionâ”‚            â”‚
â”‚  â”‚ - image_retrieverâ”‚  â”‚ - duckduckgo     â”‚  â”‚ - response_utils â”‚            â”‚
â”‚  â”‚ - table_matcher  â”‚  â”‚ - table_finder   â”‚  â”‚                  â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              åŸºç¤è¨­æ–½å±¤                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ PostgreSQL       â”‚  â”‚ vLLM Server      â”‚  â”‚ Langfuse         â”‚            â”‚
â”‚  â”‚ + pgvector       â”‚  â”‚ (æœ¬åœ° LLM æ¨è«–)   â”‚  â”‚ (è¿½è¹¤ç›£æ§)        â”‚            â”‚
â”‚  â”‚ (å‘é‡è³‡æ–™åº«)      â”‚  â”‚                  â”‚  â”‚                  â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚  â”‚ Valkey/Redis     â”‚  â”‚ mem0             â”‚                                  â”‚
â”‚  â”‚ (å¿«å–ç³»çµ±)        â”‚  â”‚ (é•·æœŸè¨˜æ†¶)        â”‚                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 LangGraph å·¥ä½œæµç¨‹åœ–

```
START
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    (å¯é¸)
â”‚  summarize      â”‚â—„â”€â”€â”€ å•Ÿç”¨ MESSAGE_SUMMARIZATION æ™‚æ‰åŸ·è¡Œ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚extract_current_ â”‚     æå–ç•¶å‰å•é¡Œ
â”‚    query        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ retrieve_memory â”‚     å¾ mem0 æª¢ç´¢é•·æœŸè¨˜æ†¶ï¼ˆå¦‚å€‹äººç—…å²ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚answer_from_     â”‚     ç”¨è¨˜æ†¶è£œå……å•é¡Œä¸Šä¸‹æ–‡
â”‚   memory        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚classify_        â”‚     LLM åˆ†é¡å•é¡Œé¡å‹
â”‚query_type       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼                 â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚greet  â”‚       â”‚rag_neededâ”‚    â”‚out_of_scope â”‚
â”‚æ‰“æ‹›å‘¼ â”‚       â”‚éœ€è¦æª¢ç´¢   â”‚    â”‚è¶…å‡ºç¯„åœ      â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
    â”‚                â”‚                 â”‚
    â–¼                â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚generateâ”‚     â”‚ planning â”‚     â”‚set_out_of_  â”‚
â”‚responseâ”‚     â”‚  ç¯€é»    â”‚     â”‚scope_messageâ”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
    â”‚               â”‚                  â”‚
    â”‚               â–¼                  â–¼
    â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         END
    â”‚        â”‚ retrieve_   â”‚
    â”‚        â”‚ knowledge   â”‚
    â”‚        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
    â”‚               â”‚
    â”‚               â–¼
    â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚        â”‚supplement_  â”‚  â—„â”€â”€â”€ å¯é¸ï¼šCDC/Google/DuckDuckGo æœå°‹
    â”‚        â”‚realtime     â”‚
    â”‚        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
    â”‚               â”‚
    â”‚               â–¼
    â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â””â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ generate_   â”‚
             â”‚ response    â”‚
             â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚check_       â”‚
             â”‚question_typeâ”‚
             â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
           â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚(é†«ç™‚å•é¡Œ)   â”‚  â”‚(å…¶ä»–å•é¡Œ)  â”‚
    â”‚é©—è­‰å›ç­”å“è³ª  â”‚  â”‚ç›´æ¥çµæŸ    â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
           â”‚               â”‚
           â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       END
    â”‚validate_    â”‚
    â”‚answer       â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
  â”‚ é©—è­‰çµæœ â”‚
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚
  â”Œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â–¼    â–¼            â–¼               â–¼
â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ENDâ”‚ â”‚refine_   â”‚ â”‚retrieve_  â”‚ â”‚set_out_of_  â”‚
â”‚   â”‚ â”‚answer    â”‚ â”‚knowledge  â”‚ â”‚scope_messageâ”‚
â””â”€â”€â”€â”˜ â”‚(ç²¾ç…‰å›ç­”)â”‚ â”‚(å†æª¢ç´¢)   â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜        â”‚
           â”‚             â”‚              â–¼
           â”‚             â”‚            END
           â–¼             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
    â”‚validate_     â”‚â—„â”€â”€â”€â”€â”˜
    â”‚answer        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         (è¿´åœˆç›´åˆ° pass æˆ–é”åˆ°ä¸Šé™)
```

### 2.3 æŠ€è¡“æ£§

| å±¤ç´š | æŠ€è¡“ |
|------|------|
| **æ¡†æ¶** | LangGraph (ç‹€æ…‹æ©Ÿ)ã€LangChain (LLM æŠ½è±¡) |
| **LLM** | æœ¬åœ° vLLM æœå‹™ (Qwen3-4B-2507) |
| **Embedding** | æœ¬åœ° vLLM æœå‹™ (Qwen3-Embedding-4B) |
| **OCR æ¨¡å‹** | deepseek-ai/DeepSeek-OCRï¼ˆPDF æ–‡å­—è­˜åˆ¥ã€è¡¨æ ¼æ“·å–ï¼ŒGPU 0ï¼‰ |
| **è¦–è¦ºèªè¨€æ¨¡å‹** | Qwen3-VL-4Bï¼ˆè¡›æ•™åœ–ç‰‡åˆ†æèˆ‡ç¯©é¸ï¼ŒGPU 1ï¼‰ |
| **å‘é‡è³‡æ–™åº«** | PostgreSQL + pgvector |
| **å¿«å–** | Valkey/Redis (å¯é¸) æˆ–è¨˜æ†¶é«” LRU |
| **é•·æœŸè¨˜æ†¶** | mem0 |
| **ç›£æ§** | Langfuse V3 |
| **API æ¡†æ¶** | FastAPI |
| **ç°¡ç¹è½‰æ›** | OpenCC |

---

## 3. ç›®éŒ„çµæ§‹èˆ‡æª”æ¡ˆèªªæ˜

### 3.1 Python è™›æ“¬ç’°å¢ƒ

å°ˆæ¡ˆæ ¹ç›®éŒ„ `/home/danny/AI-agent/` ä¸‹æœ‰ä¸‰å€‹è™›æ“¬ç’°å¢ƒï¼š

```
/home/danny/AI-agent/
â”œâ”€â”€ .vllm_env/           # vLLM æœå‹™ç’°å¢ƒï¼ˆQwen3-4B-Instruct æ¨è«–æ¨¡å‹ + Embeddingï¼‰
â”œâ”€â”€ .venv_qwen_vl/       # Qwen3-VL è¦–è¦ºèªè¨€æ¨¡å‹ç’°å¢ƒ
â”œâ”€â”€  Agent_System        # Agent_Systeamè·¯å¾‘
â””â”€â”€ .venv/               # ä¸»ç’°å¢ƒï¼ˆDeepSeek-OCR + FastAPI Agent Systemï¼‰
```

| ç’°å¢ƒ | transformers ç‰ˆæœ¬ | ç”¨é€” | å•Ÿå‹•æ–¹å¼ |
|------|-------------------|------|----------|
| `.vllm_env` | 4.51.1 | vLLM æœå‹™ï¼ˆ**Qwen3-4B-Instruct-2507 æ¨è«–æ¨¡å‹**ã€Embeddingï¼‰ | `source .vllm_env/bin/activate` |
| `.venv_qwen_vl` | 4.57.0 | Qwen3-VL-4B-Instruct è¦–è¦ºèªè¨€æ¨¡å‹ | `source .venv_qwen_vl/bin/activate` |
| `.venv` | 4.46.3 | DeepSeek-OCRã€FastAPI Agent System | `source .venv/bin/activate` |

#### æª”æ¡ˆèˆ‡ç’°å¢ƒå°æ‡‰

| ç’°å¢ƒ | åŸ·è¡Œçš„æª”æ¡ˆ/æœå‹™ |
|------|----------------|
| `.vllm_env` | `vllm_sh.sh`ï¼ˆå•Ÿå‹• vLLM æ¨è«–æœå‹™ï¼‰ |
| `.venv_qwen_vl` | `data_process/ingest_health_images.py`ï¼ˆè¡›æ•™åœ–ç‰‡åˆ†æï¼‰ |
| `.venv` | `fastapi_main.py`ã€`langgraph_clean.py`ã€`data_process/ingest_dialysis_pdf.py`ã€`data_process/ingest_general_medical.py` |

> âš ï¸ **é‡è¦**ï¼šä¸‰å€‹ç’°å¢ƒçš„ transformers ç‰ˆæœ¬ä¸åŒï¼Œç„¡æ³•æ··ç”¨ã€‚å•Ÿå‹•æœå‹™å‰è«‹ç¢ºèªä½¿ç”¨æ­£ç¢ºçš„ç’°å¢ƒã€‚

### 3.2 Agent System ç›®éŒ„çµæ§‹

```
Agent_System/
â”œâ”€â”€ fastapi_main.py          # FastAPI ä¼ºæœå™¨å…¥å£
â”œâ”€â”€ langgraph_clean.py       # LangGraph ä¸»ç¨‹å¼ + CLI å…¥å£
â”œâ”€â”€ manage_api.sh            # API ç®¡ç†è…³æœ¬ï¼ˆstart/stop/restart/status/logsï¼‰
â”œâ”€â”€ vllm_sh.sh               # vLLM æœå‹™ç®¡ç†è…³æœ¬
â”œâ”€â”€ api.log                  # API é‹è¡Œæ—¥èªŒ
â”œâ”€â”€ tools_config.py          # å·¥å…·è¨»å†Šç³»çµ±
â”œâ”€â”€ tools_init.py            # å·¥å…·åˆå§‹åŒ–
â”œâ”€â”€ datasource_image_config.json  # è³‡æ–™æºèˆ‡åœ–ç‰‡ç›®éŒ„å°æ‡‰é…ç½®
â”‚
â”œâ”€â”€ core/                    # æ ¸å¿ƒé…ç½®
â”‚   â”œâ”€â”€ config.py            # ç³»çµ±ä¸»é…ç½®ï¼ˆLLMã€è³‡æ–™åº«ã€è¨˜æ†¶ã€å¿«å–ï¼‰
â”‚   â”œâ”€â”€ dataclass.py         # Pydantic è³‡æ–™æ¨¡å‹å®šç¾©
â”‚   â”œâ”€â”€ datasource_config.py # è³‡æ–™æºï¼ˆçŸ¥è­˜åº«ï¼‰é…ç½®
â”‚   â””â”€â”€ prompt_config.py     # Prompt æ¨¡æ¿é›†ä¸­ç®¡ç†
â”‚
â”œâ”€â”€ graph/                   # LangGraph å·¥ä½œæµç¨‹
â”‚   â”œâ”€â”€ graph_routing.py     # FullState å®šç¾© + è·¯ç”±å‡½æ•¸
â”‚   â””â”€â”€ graph_nodes.py       # æ‰€æœ‰ç¯€é»å¯¦ç¾
â”‚
â”œâ”€â”€ retrieval/               # çŸ¥è­˜æª¢ç´¢æ¨¡çµ„
â”‚   â”œâ”€â”€ retrieval_utils.py   # æª¢ç´¢ä¸»å…¥å£ï¼ˆæ··åˆæœå°‹ï¼‰
â”‚   â”œâ”€â”€ medical_knowledge_fetcher.py  # åº•å±¤å‘é‡æŸ¥è©¢
â”‚   â”œâ”€â”€ clue_extraction.py   # ç·šç´¢æå–ï¼ˆå»å™ªï¼‰
â”‚   â”œâ”€â”€ image_retriever.py   # è¡›æ•™åœ–ç‰‡æª¢ç´¢
â”‚   â””â”€â”€ table_matcher.py     # è¡¨æ ¼åŒ¹é…
â”‚
â”œâ”€â”€ tools/                   # å¤–éƒ¨å·¥å…·
â”‚   â”œâ”€â”€ cdc_search_tool.py   # CDC å³æ™‚æœå°‹
â”‚   â”œâ”€â”€ google_search_tool.py    # Google æœå°‹
â”‚   â”œâ”€â”€ duckduckgo.py        # DuckDuckGo æœå°‹
â”‚   â””â”€â”€ table_image_finder.py    # è¡¨æ ¼åœ–ç‰‡æŸ¥æ‰¾
â”‚
â”œâ”€â”€ utils/                   # å·¥å…·å‡½æ•¸
â”‚   â”œâ”€â”€ cache_manager.py     # å¿«å–ç®¡ç†ï¼ˆLRU + Redisï¼‰
â”‚   â”œâ”€â”€ prompt_function.py   # å‹•æ…‹ Prompt ç”Ÿæˆ
â”‚   â””â”€â”€ response_utils.py    # å›ç­”å¾Œè™•ç†
â”‚
â”œâ”€â”€ monitoring/              # ç›£æ§ç³»çµ±
â”‚   â”œâ”€â”€ langfuse_integration.py  # Langfuse V3 æ•´åˆ
â”‚   â””â”€â”€ langfuse_config.py   # Langfuse é…ç½®
â”‚
â”œâ”€â”€ rag_system/              # RAG ç³»çµ±
â”‚   â”œâ”€â”€ rag_jsonl.py         # JSONL è™•ç†
â”‚   â”œâ”€â”€ rag_files.py         # PDF è™•ç†
â”‚   â””â”€â”€ unified_metadata.py  # çµ±ä¸€å…ƒæ•¸æ“šæ ¼å¼
â”‚
â”œâ”€â”€ data_process/            # è³‡æ–™è™•ç† ETL
â”‚   â”œâ”€â”€ medical_pdf_to_vectordb.py  # é†«ç™‚ PDF é€šç”¨è™•ç†ï¼ˆDeepSeek OCR, GPU 0ï¼‰
â”‚   â”œâ”€â”€ convert_pdf.py              # PDF æ ¼å¼è½‰æ›å·¥å…·
â”‚   â””â”€â”€ convert_xlsx_to_jsonl.py    # Excel è½‰ JSONL
â”‚
â”œâ”€â”€ cdc_websearch/           # CDC çˆ¬èŸ²ï¼ˆå³æ™‚æœå°‹ï¼‰
â”‚   â”œâ”€â”€ scraper_cdc_search.py   # CDC é—œéµå­—æœå°‹
â”‚   â””â”€â”€ scraper_cdc_website.py  # CDC é é¢å…§å®¹çˆ¬èŸ²
â”‚
â”œâ”€â”€ embedding/               # Embedding æœå‹™
â”‚   â””â”€â”€ vllm_embedding_server.py  # VLLM Embedding å®¢æˆ¶ç«¯
â”‚
â”œâ”€â”€ ocr_model/               # OCR èˆ‡è¦–è¦ºæ¨¡å‹è™•ç†
â”‚   â”œâ”€â”€ update_pdf_to_db_v2.py              # æ´—è…è¡›æ•™ PDF è™•ç†ï¼ˆDeepSeek OCR, GPU 0ï¼‰
â”‚   â””â”€â”€ health_image_pipeline_v2_strict.py  # è¡›æ•™åœ–ç‰‡æ“·å–åˆ†æï¼ˆQwen3-4B-VL, GPU 1ï¼‰
â”‚
â””â”€â”€ extracted_tables/        # æå–çš„è¡¨æ ¼èˆ‡åœ–ç‰‡
    â””â”€â”€ images/              # è¡¨æ ¼åœ–ç‰‡å„²å­˜ç›®éŒ„
```

### 3.3 è¡¨æ ¼è™•ç†ç³»çµ±

æœ¬ç³»çµ±å…·å‚™å®Œæ•´çš„è¡¨æ ¼æ“·å–èˆ‡åŒ¹é…åŠŸèƒ½ï¼Œå°‡ PDF ä¸­çš„è¡¨æ ¼è½‰æ›ç‚ºå¯æª¢ç´¢çš„åœ–ç‰‡ã€‚

#### è¡¨æ ¼è™•ç†æµç¨‹

```
PDF æ–‡ä»¶
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DeepSeek-OCR    â”‚  1. OCR è­˜åˆ¥é é¢å…§å®¹
â”‚ (GPU 0)         â”‚  2. åµæ¸¬è¡¨æ ¼/åœ–ç‰‡å€åŸŸ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  3. æ“·å–åº§æ¨™å’Œ HTML çµæ§‹
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¡¨æ ¼è£åˆ‡èˆ‡å„²å­˜  â”‚  4. é«˜è§£æåº¦è£åˆ‡è¡¨æ ¼å€åŸŸ
â”‚                 â”‚  5. å„²å­˜ JPG åœ–ç‰‡ + HTML æ–‡å­—
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘é‡è³‡æ–™åº«      â”‚  6. è¡¨æ ¼å…§å®¹å‘é‡åŒ–
â”‚ (pgvector)      â”‚  7. metadata è¨˜éŒ„ table_images
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æª¢ç´¢æ™‚åŒ¹é…      â”‚  8. æ ¹æ“š metadata æˆ–ç›¸ä¼¼åº¦åŒ¹é…
â”‚ table_matcher   â”‚  9. è¿”å›å°æ‡‰è¡¨æ ¼åœ–ç‰‡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æª”æ¡ˆå„²å­˜çµæ§‹

```
extracted_tables/
â”œâ”€â”€ images/                          # çµ±ä¸€åœ–ç‰‡å„²å­˜ç›®éŒ„
â”‚   â”œâ”€â”€ {PDFå}_p{é ç¢¼}_t{åºè™Ÿ}.jpg  # è¡¨æ ¼åœ–ç‰‡
â”‚   â””â”€â”€ {PDFå}_p{é ç¢¼}_i{åºè™Ÿ}.jpg  # åœ–ç‰‡/åœ–è¡¨
â””â”€â”€ {PDFå}/                         # éƒ¨åˆ†èˆŠè³‡æ–™å¯èƒ½æœ‰ç¨ç«‹ç›®éŒ„
```

#### æª”åå‘½åè¦å‰‡

æ ¼å¼ï¼š`{PDFå}_p{é ç¢¼}_{é¡å‹}{åºè™Ÿ}.jpg`

| é¡åˆ¥ | ä»£ç¢¼ | OCR è­˜åˆ¥é¡å‹ | ç¯„ä¾‹ |
|------|------|-------------|------|
| **è¡¨æ ¼** | `t` | `table` | `ç³–å°¿ç—…æŒ‡å—_p3_t1.jpg` |
| **åœ–ç‰‡** | `i` | `image` | `ç³–å°¿ç—…æŒ‡å—_p5_i1.jpg` |

> ğŸ’¡ æœ¬è³ªä¸Šå°±æ˜¯ã€Œè¡¨æ ¼ (t)ã€å’Œã€Œåœ–ç‰‡ (i)ã€å…©å¤§é¡ï¼Œç´°åˆ†é¡å‹ç”± DeepSeek-OCR æ¨¡å‹è‡ªå‹•è­˜åˆ¥ã€‚

#### è¡¨æ ¼åŒ¹é…æ©Ÿåˆ¶ (retrieval/table_matcher.py)

ç³»çµ±æä¾›å…©ç¨®è¡¨æ ¼åŒ¹é…æ–¹å¼ï¼š

**æ–¹æ¡ˆ 1ï¼šMetadata ç²¾ç¢ºåŒ¹é…ï¼ˆå„ªå…ˆï¼‰**
```python
# æª¢ç´¢çµæœçš„ metadata ä¸­åŒ…å« table_images æ¬„ä½
metadata = {
    "has_table": True,
    "table_images": ["ç³–å°¿ç—…æŒ‡å—_p3_t1.jpg", "ç³–å°¿ç—…æŒ‡å—_p3_t2.jpg"]
}
# ç›´æ¥è¿”å›é€™äº›åœ–ç‰‡ï¼Œç„¡éœ€ç›¸ä¼¼åº¦è¨ˆç®—
```

**æ–¹æ¡ˆ 2ï¼šæ–‡æœ¬ç›¸ä¼¼åº¦åŒ¹é…ï¼ˆFallbackï¼‰**
```python
# ç•¶ metadata æ²’æœ‰ table_images æ™‚
# æå– OCR æ–‡æœ¬ä¸­çš„è¡¨æ ¼å…§å®¹ï¼Œèˆ‡ HTML æª”æ¡ˆæ¯”å°
similarity = SequenceMatcher(ocr_table_text, html_content).ratio()
if similarity > 0.05:  # ä½é–¾å€¼ä»¥å¢åŠ åŒ¹é…æ©Ÿæœƒ
    return matched_table
```

#### è¡¨æ ¼æŸ¥æ‰¾å·¥å…· (tools/table_image_finder.py)

æ”¯æ´ç”¨æˆ¶ç›´æ¥è¼¸å…¥æª”åæŸ¥æ‰¾è¡¨æ ¼ï¼š

```python
# æ”¯æ´çš„æŸ¥è©¢æ ¼å¼
"ç³–å°¿ç—…æŒ‡å—_p3_t1.jpg"    # å®Œæ•´æª”å
"ç³–å°¿ç—…æŒ‡å—_p3_t1"        # ç„¡å‰¯æª”å
"p3_t1"                   # ç°¡åŒ–æ ¼å¼ï¼ˆé ç¢¼_é¡å‹åºè™Ÿï¼‰
```

#### API ç«¯é»

| ç«¯é» | èªªæ˜ |
|------|------|
| `/api/table-image/{filename}` | è¿”å›è¡¨æ ¼åœ–ç‰‡ï¼ˆJPGï¼‰ |
| `/api/educational-image/{filename}` | è¿”å›è¡›æ•™åœ–ç‰‡ |

#### ç›¸é—œå‡½æ•¸

| å‡½æ•¸ | ä½ç½® | åŠŸèƒ½ |
|------|------|------|
| `has_table_format()` | table_matcher.py | åˆ¤æ–·æ–‡æœ¬æ˜¯å¦åŒ…å«è¡¨æ ¼ |
| `extract_table_content()` | table_matcher.py | å¾æ–‡æœ¬æå–è¡¨æ ¼å…§å®¹ |
| `find_matching_table()` | table_matcher.py | æ ¹æ“š OCR å…§å®¹åŒ¹é…è¡¨æ ¼åœ–ç‰‡ |
| `process_search_result()` | table_matcher.py | è™•ç†æª¢ç´¢çµæœï¼Œè‡ªå‹•åŒ¹é…è¡¨æ ¼ |
| `match_tables_for_answer()` | graph_nodes.py | ç‚ºç”Ÿæˆçš„å›ç­”åŒ¹é…è¡¨æ ¼åœ–ç‰‡ |
| `is_table_filename()` | table_image_finder.py | åˆ¤æ–·è¼¸å…¥æ˜¯å¦ç‚ºè¡¨æ ¼æª”å |
| `find_table_image_by_filename()` | table_image_finder.py | æ ¹æ“šæª”åæŸ¥æ‰¾è¡¨æ ¼ |

---

## 4. æ ¸å¿ƒçµ„ä»¶è©³è§£

### 4.1 FullStateï¼ˆç‹€æ…‹å®šç¾©ï¼‰

ä½æ–¼ `graph/graph_routing.py`ï¼Œå®šç¾©äº† Agent åœ¨å„ç¯€é»é–“å‚³éçš„å®Œæ•´ç‹€æ…‹ï¼š

```python
class FullState(BaseModel):
    # è¨Šæ¯å±¤
    messages: Annotated[Sequence[BaseMessage], add_messages]  # å°è©±æ­·å²

    # ç”¨æˆ¶è­˜åˆ¥
    user_id: str                           # ç”¨æˆ¶å”¯ä¸€è­˜åˆ¥ç¢¼

    # æŸ¥è©¢è™•ç†
    current_query: str = ""                # ç•¶å‰å•é¡Œï¼ˆå¯èƒ½ç¶“éç²¾ç¢ºåŒ–ï¼‰
    query_type: str = ""                   # å•é¡Œé¡å‹ï¼ˆgreet/short_term/rag_needed/out_of_scopeï¼‰
    question_category: str = ""            # å•é¡Œé¡åˆ¥ï¼ˆmedical/otherï¼‰

    # çŸ¥è­˜æª¢ç´¢
    knowledge: str = ""                    # æª¢ç´¢åˆ°çš„çŸ¥è­˜å…§å®¹
    used_sources_dict: dict = {}           # ä½¿ç”¨çš„åƒè€ƒæ–‡ç»
    original_docs_dict: dict = {}          # åŸå§‹æ–‡æª”å…§å®¹
    knowledge_retrieval_count: int = 0     # æª¢ç´¢æ¬¡æ•¸

    # è¨˜æ†¶ç³»çµ±
    memory_summary: str = ""               # é•·æœŸè¨˜æ†¶æ‘˜è¦
    memory_response: str = ""              # è¨˜æ†¶å›ç­”
    memory_source: str = ""                # è¨˜æ†¶ä¾†æºï¼ˆshort_term/long_termï¼‰

    # Planning ç³»çµ±
    planning_result: Optional[dict] = None # Planning åˆ†æçµæœ
    retrieval_steps: list = []             # æª¢ç´¢æ­¥é©Ÿåˆ—è¡¨
    current_step: int = 0                  # ç•¶å‰åŸ·è¡Œæ­¥é©Ÿ

    # é©—è­‰èˆ‡ä¿®æ­£
    final_answer: str = ""                 # æœ€çµ‚å›ç­”
    validation_result: str = ""            # é©—è­‰çµæœï¼ˆpass/regenerate/need_more_knowledgeï¼‰
    validation_feedback: str = ""          # é©—è­‰åé¥‹
    retry_count: int = 0                   # é‡è©¦æ¬¡æ•¸

    # å¤šæ¨¡æ…‹
    matched_table_images: list = []        # åŒ¹é…çš„è¡¨æ ¼åœ–ç‰‡
    matched_educational_images: list = []  # åŒ¹é…çš„è¡›æ•™åœ–ç‰‡

    # æ§åˆ¶åƒæ•¸
    enable_short_term_memory: bool = False # æ˜¯å¦å•Ÿç”¨çŸ­æœŸè¨˜æ†¶
    enable_long_term_memory: bool = False  # æ˜¯å¦å•Ÿç”¨é•·æœŸè¨˜æ†¶
    datasource_ids: Optional[list] = None  # æŒ‡å®šä½¿ç”¨çš„è³‡æ–™æº
    enabled_tool_ids: Optional[list] = None # æŒ‡å®šä½¿ç”¨çš„å·¥å…·

    # å®‰å…¨æ§åˆ¶
    iteration_count: int = 0               # è¿­ä»£æ¬¡æ•¸ï¼ˆé˜²æ­¢ç„¡é™å¾ªç’°ï¼‰
```

### 4.2 è·¯ç”±å‡½æ•¸

ä½æ–¼ `graph/graph_routing.py`ï¼Œå…± 5 å€‹è·¯ç”±å‡½æ•¸ï¼š

| å‡½æ•¸ | è§¸ç™¼ç¯€é» | å¯èƒ½çš„ä¸‹ä¸€æ­¥ |
|------|----------|--------------|
| `route_after_memory` | answer_from_memory | classify_query_type / set_out_of_scope_message |
| `route_after_classification` | classify_query_type | planning (â†’ retrieve_knowledge) / generate_response / set_out_of_scope_message |
| `route_after_generate` | generate_response | check_question_type / set_out_of_scope_message / END |
| `route_after_check_question_type` | check_question_type | validate_answer / set_out_of_scope_message / END |
| `route_after_validation` | validate_answer | END / refine_answer / retrieve_knowledge / set_out_of_scope_message |

### 4.3 ä¸»è¦ç¯€é»åŠŸèƒ½

ä½æ–¼ `graph/graph_nodes.py`ï¼š

| ç¯€é» | åŠŸèƒ½ | é—œéµé‚è¼¯ |
|------|------|----------|
| `extract_current_query` | æå–ç•¶å‰å•é¡Œ | å¾ messages[-1] å–å¾—ç”¨æˆ¶å•é¡Œï¼Œé‡ç½®ç‹€æ…‹ |
| `retrieve_memory` | æª¢ç´¢é•·æœŸè¨˜æ†¶ | èª¿ç”¨ mem0 searchï¼Œè¿”å›å€‹äººç—…å²/éæ•å²ç­‰ |
| `answer_from_memory` | ç²¾ç¢ºåŒ–å•é¡Œ | ç”¨çŸ­æœŸ/é•·æœŸè¨˜æ†¶è£œå……å•é¡Œä¸Šä¸‹æ–‡ |
| `classify_query_type` | åˆ†é¡å•é¡Œé¡å‹ | LLM åˆ¤æ–·ï¼šgreet / short_term / rag_needed / out_of_scope |
| `planning_node` | è¦åŠƒæª¢ç´¢ç­–ç•¥ | åˆ†æå•é¡Œè¤‡é›œåº¦ï¼Œç”Ÿæˆå¤šæ­¥é©Ÿæª¢ç´¢è¨ˆåŠƒ |
| `retrieve_knowledge` | çŸ¥è­˜æª¢ç´¢ | ä¸¦è¡Œæª¢ç´¢å¤šå€‹å­å•é¡Œï¼Œåˆä½µçµæœï¼Œæå–åœ–ç‰‡ |
| `supplement_with_realtime_info` | å³æ™‚æœå°‹è£œå…… | èª¿ç”¨ CDC/Google/DuckDuckGo å·¥å…· |
| `generate_response` | ç”Ÿæˆå›ç­” | èª¿ç”¨ LLM ç”Ÿæˆï¼Œé™„åŠ åƒè€ƒæ–‡ç»å’Œåœ–ç‰‡ |
| `validate_answer` | é©—è­‰å›ç­”å“è³ª | LLM è©•ä¼°ï¼špass / regenerate / need_more_knowledge |
| `refine_answer` | ç²¾ç…‰å›ç­” | æ ¹æ“šé©—è­‰åé¥‹é‡æ–°ç”Ÿæˆ |
| `check_question_type` | æª¢æŸ¥å•é¡Œé¡åˆ¥ | åˆ¤æ–·å•é¡Œé¡å‹ï¼Œæ±ºå®šæ˜¯å¦éœ€è¦é©—è­‰ï¼ˆè¦‹ä¸‹æ–¹è©³ç´°èªªæ˜ï¼‰|
| `set_out_of_scope_message` | è¨­ç½®è¶…å‡ºç¯„åœè¨Šæ¯ | è¿”å›æ¨™æº–çš„ã€Œè¶…å‡ºç¯„åœã€å›è¦† |

#### check_question_type ç¯€é»è©³è§£

æ­¤ç¯€é»åœ¨ `generate_response` ä¹‹å¾ŒåŸ·è¡Œï¼Œä½œç‚ºé€²å…¥ `validate_answer` çš„ã€Œé–€æª»ã€ï¼Œé¿å…å°ä¸éœ€è¦é©—è­‰çš„å•é¡Œé€²è¡Œä¸å¿…è¦çš„ LLM èª¿ç”¨ã€‚

**åˆ†é¡çµæœèˆ‡å¾ŒçºŒå‹•ä½œ**ï¼š

| é¡åˆ¥ | èªªæ˜ | å¾ŒçºŒå‹•ä½œ |
|------|------|----------|
| `medical` | é†«ç™‚ç›¸é—œå•é¡Œï¼ˆç—‡ç‹€ã€ç–¾ç—…ã€æ²»ç™‚ã€æ„ŸæŸ“ç®¡åˆ¶ç­‰ï¼‰ | â†’ é€²å…¥ `validate_answer` é©—è­‰å›ç­”å“è³ª |
| `other` | æ‰“æ‹›å‘¼ï¼ˆå¦‚ã€Œä½ å¥½ã€ï¼‰ã€æƒ…æ„Ÿè¡¨é”ï¼ˆå¦‚ã€Œè¬è¬ã€ï¼‰ã€å®Œå…¨ç„¡é—œå•é¡Œ | â†’ ç›´æ¥çµæŸï¼Œä¸éœ€é©—è­‰ |

**è¨­è¨ˆåŸå› **ï¼š

é©—è­‰ç¯€é»æœƒæª¢æŸ¥å›ç­”æ˜¯å¦æœ‰å¹»è¦ºã€æ˜¯å¦å®Œæ•´ã€‚å°æ–¼æ‰“æ‹›å‘¼ã€ç„¡é—œå•é¡Œç­‰éé†«ç™‚å•é¡Œï¼Œé©—è­‰æ˜¯æ²’æœ‰æ„ç¾©çš„ã€‚å› æ­¤åªè®“çœŸæ­£çš„é†«ç™‚å•é¡Œé€²å…¥é©—è­‰æµç¨‹ã€‚

#### 4.4 è¨˜æ†¶ç³»çµ±è©³è§£

ç³»çµ±æ¡ç”¨ä¸‰å±¤è¨˜æ†¶æ¶æ§‹ï¼Œç¢ºä¿å°è©±çš„é€£è²«æ€§èˆ‡å€‹äººåŒ–è™•ç†ï¼š

| è¨˜æ†¶å±¤ç´š | å¯¦ä½œæ–¹å¼ | å„²å­˜ä½ç½® | éš”é›¢æ©Ÿåˆ¶ | èªªæ˜ |
|----------|----------|----------|----------|------|
| **çŸ­æœŸè¨˜æ†¶** | `messages` åˆ—è¡¨ | `conversation_store` (FastAPI) | `session_id` | å„²å­˜ç•¶å‰æœƒè©±çš„åŸå§‹å•ç­”ï¼Œç”¨æ–¼ç¶­æŒå°è©±é€£è²«æ€§ã€‚ |
| **é•·æœŸè¨˜æ†¶** | mem0 | PostgreSQL | `user_id` | å„²å­˜ç¶“ LLM æå–å¾Œçš„å€‹äººå¥åº·äº‹å¯¦ï¼ˆå¦‚ç—…å²ã€éæ•å²ï¼‰ã€‚ |
| **è¨Šæ¯æ‘˜è¦** | `SummarizationNode` | FullState | `thread_id` | ç•¶å°è©±éé•·æ™‚ï¼Œè‡ªå‹•å°‡èˆŠè¨Šæ¯å£“ç¸®ç‚ºæ‘˜è¦ï¼Œç¯€çœ Token ä¸¦ä¿ç•™é‡é»ã€‚ |

**çŸ­æœŸè¨˜æ†¶ç®¡ç† (MemoryManager)**:
- ä½æ–¼ `utils/cache_manager.py`ã€‚
- è² è²¬é™åˆ¶ `conversation_history` çš„è¼ªæ•¸ï¼ˆé è¨­ 50 è¼ªï¼‰ï¼Œé¿å…å…§å­˜æº¢å‡ºã€‚
- æä¾›è‡ªå‹•æ¸…ç†åŠŸèƒ½ï¼Œä¿ç•™æœ€è¿‘çš„ N è¼ªå°è©±ã€‚

**è¨˜æ†¶æå–èˆ‡è£œå…¨æµç¨‹**:
1. `retrieve_memory`ï¼šæ ¹æ“šå•é¡Œå‘ mem0 æª¢ç´¢ç›¸é—œçš„å€‹äººç—…å²ã€‚
2. `answer_from_memory`ï¼šå°‡æª¢ç´¢åˆ°çš„äº‹å¯¦èˆ‡è¿‘æœŸå°è©±æ­·å²æ•´åˆï¼Œç”¢å‡ºã€Œç²¾ç¢ºåŒ–å•é¡Œã€ä¾›å¾ŒçºŒæª¢ç´¢ä½¿ç”¨ã€‚

---

## 5. å·¥ä½œæµç¨‹è©³è§£

### 5.1 æ¨™æº–é†«ç™‚å•ç­”æµç¨‹

```
1. ç”¨æˆ¶æå•ï¼šã€Œç³–å°¿ç—…æ‚£è€…å¯ä»¥åƒä»€éº¼æ°´æœï¼Ÿã€

2. extract_current_query
   - æå–å•é¡Œï¼Œé‡ç½®ç‹€æ…‹

3. retrieve_memory
   - æª¢ç´¢é•·æœŸè¨˜æ†¶ï¼šã€Œç”¨æˆ¶æœ‰ç³–å°¿ç—…ï¼Œæ­£åœ¨æœç”¨ metforminã€

4. answer_from_memory
   - ç²¾ç¢ºåŒ–å•é¡Œï¼šã€Œç³–å°¿ç—…æ‚£è€…ï¼ˆæ­£åœ¨æœç”¨ metforminï¼‰å¯ä»¥åƒä»€éº¼æ°´æœï¼Ÿã€

5. classify_query_type
   - åˆ¤æ–·é¡å‹ï¼šrag_needed

6. planning_node
   - åˆ†æè¤‡é›œåº¦ï¼šneeds_planning = True
   - ç”Ÿæˆæ­¥é©Ÿï¼š
     1. ç³–å°¿ç—…é£²é£ŸåŸå‰‡
     2. ä½å‡ç³–æŒ‡æ•¸æ°´æœ
     3. ç³–å°¿ç—…æ‚£è€…æ°´æœæ”å–é‡

7. retrieve_knowledge
   - ä¸¦è¡Œæª¢ç´¢ 3 å€‹å­å•é¡Œ
   - åˆä½µçŸ¥è­˜ï¼Œæå–ç·šç´¢
   - æª¢ç´¢ç›¸é—œè¡›æ•™åœ–ç‰‡

8. generate_response
   - LLM ç”Ÿæˆå®Œæ•´å›ç­”
   - é™„åŠ åƒè€ƒæ–‡ç»
   - é™„åŠ ç›¸é—œåœ–ç‰‡

9. check_question_type
   - åˆ¤æ–·é¡åˆ¥ï¼šmedical

10. validate_answer
    - é©—è­‰çµæœï¼špass

11. END
    - è¿”å›æœ€çµ‚å›ç­”
```

### 5.2 é©—è­‰å¤±æ•—çš„ä¿®æ­£æµç¨‹

```
validate_answer åˆ¤å®š need_more_knowledge

â†’ è¿”å› retrieve_knowledgeï¼ˆå¸¶æœ‰ validation_need_supplement_infoï¼‰
  â†’ æ ¹æ“šç¼ºå¤±è³‡è¨Šç”Ÿæˆæ–°çš„å­å•é¡Œ
  â†’ å†æ¬¡æª¢ç´¢
  â†’ å†æ¬¡ç”Ÿæˆ
  â†’ å†æ¬¡é©—è­‰

ï¼ˆå¾ªç’°ç›´åˆ° pass æˆ–é”åˆ° max_retry_countï¼‰
```

### 5.3 å³æ™‚æœå°‹æµç¨‹

```
ç”¨æˆ¶å•Ÿç”¨ enabled_tool_ids = ["cdc_realtime_search"]

â†’ retrieve_knowledge å®Œæˆå¾Œ
â†’ supplement_with_realtime_info
  â†’ æ ¹æ“šå•é¡Œèª¿ç”¨ CDC çˆ¬èŸ²
  â†’ çˆ¬å–æœ€æ–°ç–«æƒ…è³‡è¨Š
  â†’ åˆä½µåˆ° knowledge
â†’ generate_response
  â†’ ç”ŸæˆåŒ…å«æœ€æ–°è³‡è¨Šçš„å›ç­”
```

---

## 6. è³‡æ–™åº«æ¶æ§‹

### 6.1 PostgreSQL + pgvector

**é€£æ¥è³‡è¨Š**ï¼ˆè¦‹ `core/config.py`ï¼‰ï¼š

```python
DB_HOST = "localhost"
DB_PORT = "5432"
DB_NAME = "infection_rag"
DB_USER = "langchain"
DB_PASSWORD = "langchain"
```

### 6.2 ä¸»è¦ Collections

| Collection åç¨± | è³‡æ–™ä¾†æº | èªªæ˜ |
|----------------|----------|------|
| `medical_knowledge_base` | JSONL å•ç­”å° | é†«ç™‚çŸ¥è­˜åº«ï¼Œå« question/answer/reference |
| `public_health_information_of_education_sites` | è¡›æ•™åœ’åœ° PDF | è¡›æ•™å–®å¼µå‘é‡åŒ– |
| `dialysis_education_materials` | æ´—è…è¡›æ•™ PDF | OCR è™•ç†å¾Œçš„æ´—è…è¡›æ•™ |
| `educational_images` | PDF åœ–ç‰‡ | è¡›æ•™åœ–ç‰‡æè¿°èˆ‡å‘é‡ |
| `memory_agent_chinese_v2` | mem0 | ç”¨æˆ¶é•·æœŸè¨˜æ†¶ |

> **æ³¨æ„**ï¼šCDC æ³•å®šå‚³æŸ“ç—…è³‡è¨Šå·²æ”¹ç”¨å³æ™‚æœå°‹å·¥å…· (`search_cdc_realtime`)ï¼Œä¸å†ä½¿ç”¨å‘é‡è³‡æ–™åº«ã€‚æ¯æ¬¡æŸ¥è©¢æœƒç›´æ¥å¾ CDC ç¶²ç«™çˆ¬å–æœ€æ–°è³‡æ–™ã€‚

### 6.3 å‘é‡ç¶­åº¦

ä½¿ç”¨ `Qwen3-Embedding-4B` æ¨¡å‹ï¼Œå‘é‡ç¶­åº¦ç‚º **2560**ã€‚

---

## 7. é…ç½®ç³»çµ±

### 7.1 ä¸»é…ç½®æ–‡ä»¶ (core/config.py)

#### LLM é…ç½®

```python
CURRENT_MODEL = "qwen3_4b_2507"  # ç•¶å‰ä½¿ç”¨çš„æ¨¡å‹
MODEL_PATH = "openai:/home/danny/AI-agent/Qwen3_4B_2507"

llm = init_chat_model(
    base_url="http://0.0.0.0:8080/v1",  # vLLM æœå‹™åœ°å€
    api_key="not-needed",
    model=MODEL_PATH,
    temperature=0.1,
    seed=42
)
```

#### è¨˜æ†¶ç³»çµ±é…ç½®

```python
SHORT_TERM_MEMORY_CONFIG = {
    'enabled': False,  # æ˜¯å¦å•Ÿç”¨çŸ­æœŸè¨˜æ†¶ï¼ˆå°è©±æ­·å²ï¼‰
}

LONG_TERM_MEMORY_CONFIG = {
    'enabled': False,  # æ˜¯å¦å•Ÿç”¨é•·æœŸè¨˜æ†¶ï¼ˆmem0ï¼‰
}

MESSAGE_SUMMARIZATION_CONFIG = {
    'enabled': True,                    # æ˜¯å¦å•Ÿç”¨è¨Šæ¯æ‘˜è¦
    'max_tokens': 12000,                # ç›®æ¨™ä¿ç•™çš„æ­·å²å¤§å°
    'max_tokens_before_summary': 8000,  # è§¸ç™¼æ‘˜è¦çš„é–¾å€¼
    'max_summary_tokens': 1500,         # æ‘˜è¦æœ€å¤§é•·åº¦
}
```

#### æª¢ç´¢é…ç½®

```python
RETRIEVAL_CONFIG = {
    'public_rag_k': 5,    # è¡›æ•™åœ’åœ°æª¢ç´¢æ•¸é‡
    'pdf_rag_k': 3,       # PDF æª¢ç´¢æ•¸é‡
    'medical_rag_k': 10,  # é†«ç™‚çŸ¥è­˜åº«æª¢ç´¢æ•¸é‡
    'dialysis_rag_k': 5,  # æ´—è…è¡›æ•™æª¢ç´¢æ•¸é‡
    'cdc_rag_k': 1,       # CDC è³‡æ–™æª¢ç´¢æ•¸é‡

    'enable_clue_extraction': True,  # å•Ÿç”¨ç·šç´¢æå–
    'clue_max_length': 4096,         # ç·šç´¢æœ€å¤§é•·åº¦

    'default_datasource_ids': ["public_health", "educational_images"],
}
```

#### å·¥å…·é…ç½®

```python
TOOLS_CONFIG = {
    'enabled': True,                           # æ˜¯å¦å•Ÿç”¨å·¥å…·ç³»çµ±
    'default_tools': ["cdc_realtime_search"],  # é è¨­å•Ÿç”¨çš„å·¥å…·
    'max_tool_calls_per_query': 3,             # å–®æ¬¡æŸ¥è©¢æœ€å¤šå‘¼å«å·¥å…·æ¬¡æ•¸
    'tool_timeout': 30,                        # å·¥å…·åŸ·è¡Œè¶…æ™‚æ™‚é–“
}
```

#### å¿«å–é…ç½®

```python
CACHE_CONFIG = {
    'enabled': True,           # æ˜¯å¦å•Ÿç”¨å¿«å–
    'use_valkey': True,        # ä½¿ç”¨ Valkey/Redisï¼ˆFalse = è¨˜æ†¶é«” LRUï¼‰

    'valkey': {
        'host': 'localhost',
        'port': 6379,
        'db': 0,
    },

    'enable_query_cache': True,      # å®Œæ•´å›ç­”å¿«å–
    'query_cache_ttl': 3600,         # 1 å°æ™‚

    'enable_planning_cache': True,   # Planning çµæœå¿«å–
    'planning_cache_ttl': 7200,      # 2 å°æ™‚

    'enable_retrieval_cache': True,  # æª¢ç´¢çµæœå¿«å–
    'retrieval_cache_ttl': 3600,     # 1 å°æ™‚
}
```

#### å·¥ä½œæµç¨‹é™åˆ¶

```python
WORKFLOW_LIMITS = {
    'langgraph_recursion_limit': 50,      # LangGraph éè¿´é™åˆ¶
    'max_iteration_count': 5,             # æœ€å¤§è¿­ä»£æ¬¡æ•¸
    'max_knowledge_retrieval_count': 5,   # æœ€å¤§æª¢ç´¢æ¬¡æ•¸
    'max_retry_count': 5,                 # æœ€å¤§é‡è©¦æ¬¡æ•¸
}
```

### 7.2 è³‡æ–™æºé…ç½® (core/datasource_config.py)

```python
# é å®šç¾©è³‡æ–™æº
MEDICAL_KB_JSONL = DataSource(
    id="medical_kb_jsonl",
    name="é†«ç™‚çŸ¥è­˜åº«(JSONL)",
    collection_name="medical_knowledge_base",
    source_type="jsonl",
    default_k=3,
    enabled=True,
)

PUBLIC_HEALTH_EDUCATION = DataSource(
    id="public_health",
    name="è¡›æ•™åœ’åœ°",
    collection_name="public_health_information_of_education_sites",
    source_type="pdf",
    default_k=3,
    enabled=True,
)

# å‹•æ…‹è¨»å†Šæ–°è³‡æ–™æº
register_datasource(custom_source)
```

### 7.3 å·¥å…·é…ç½® (tools_config.py)

```python
# è¨»å†Šå·¥å…·
register_tool(ToolConfig(
    id="cdc_realtime_search",
    name="CDC å³æ™‚æœå°‹",
    description="æœå°‹ CDC ç–¾ç—…ç®¡åˆ¶ç½²æœ€æ–°è³‡è¨Š",
    tool_func=cdc_search_tool,
    enabled=True,
    support_medical=True,
    timeout=30,
    metadata={"category": "external_search"}
))
```

### 7.4 åœ–ç‰‡è³‡æ–™æºé…ç½® (datasource_image_config.json)

æ­¤é…ç½®æª”ç”¨æ–¼å»ºç«‹**æ–‡å­—è³‡æ–™æºèˆ‡åœ–ç‰‡ç›®éŒ„çš„å°æ‡‰é—œä¿‚**ï¼Œè®“ç³»çµ±æ ¹æ“šæª¢ç´¢åˆ°çš„ PDF ä¾†æºï¼Œè¿”å›æ­£ç¢ºé¡åˆ¥çš„è¡›æ•™åœ–ç‰‡ã€‚

```json
{
  "description": "è³‡æ–™æºèˆ‡åœ–ç‰‡ç›®éŒ„å°æ‡‰é…ç½®ï¼Œç”¨æ–¼æ ¹æ“š PDF ä¾†æºéæ¿¾åœ–ç‰‡",
  "datasources": {
    "public_health": {
      "name": "è¡›æ•™åœ’åœ°",
      "pdf_directories": ["/home/danny/AI-agent/è¡›æ•™åœ’åœ°ç¶œåˆè³‡è¨Š"],
      "description": "ä¸€èˆ¬è¡›æ•™åœ–ç‰‡ï¼ˆæ…¢æ€§ç—…ã€ç”¨è—¥æŒ‡å°ã€æª¢æŸ¥æµç¨‹ç­‰ï¼‰"
    },
    "infection_control": {
      "name": "æ„ŸæŸ“æ§åˆ¶",
      "pdf_directories": ["/home/danny/AI-agent/DataSet"],
      "description": "æ„ŸæŸ“ç®¡åˆ¶ç›¸é—œåœ–ç‰‡ï¼ˆå‚³æŸ“ç—…ã€æ¶ˆæ¯’ã€éš”é›¢ç­‰ï¼‰"
    }
  },
  "text_to_image_datasource_mapping": {
    "_description": "æ–‡å­—è³‡æ–™æº ID â†’ åœ–ç‰‡è³‡æ–™æº ID çš„æ˜ å°„",
    "public_health": "public_health",
    "dialysis_education": "public_health",
    "medical_kb_jsonl": "infection_control",
    "cdc_infectious_diseases": "infection_control"
  },
  "mapping_notes": "ç³»çµ±å•Ÿå‹•æ™‚æœƒæƒæ pdf_directories ä¸­çš„æ‰€æœ‰ PDF æª”æ¡ˆï¼Œå»ºç«‹ PDF åç¨± â†’ datasource_id çš„æ˜ å°„"
}
```

#### é…ç½®èªªæ˜

| æ¬„ä½ | èªªæ˜ |
|------|------|
| `datasources` | å®šç¾©åœ–ç‰‡è³‡æ–™æºï¼ŒåŒ…å«åç¨±ã€PDF ç›®éŒ„ã€æè¿° |
| `pdf_directories` | è©²è³‡æ–™æºå°æ‡‰çš„ PDF æª”æ¡ˆç›®éŒ„ï¼ˆç”¨æ–¼å»ºç«‹ PDF â†’ datasource æ˜ å°„ï¼‰ |
| `text_to_image_datasource_mapping` | æ–‡å­—è³‡æ–™æº ID â†’ åœ–ç‰‡è³‡æ–™æº ID çš„æ˜ å°„ |

#### å·¥ä½œåŸç†

1. ç³»çµ±å•Ÿå‹•æ™‚æƒæå„ `pdf_directories` ä¸­çš„ PDF æª”æ¡ˆ
2. å»ºç«‹ `PDF æª”å â†’ datasource_id` çš„æ˜ å°„
3. æª¢ç´¢æ™‚æ ¹æ“šæ–‡å­—ä¾†æºçš„ `source_file` åˆ¤æ–·å±¬æ–¼å“ªå€‹ datasource
4. è¿”å›å°æ‡‰ datasource çš„è¡›æ•™åœ–ç‰‡

#### ä½¿ç”¨å ´æ™¯

- æŸ¥è©¢ã€Œç³–å°¿ç—…é£²é£Ÿã€â†’ ä¾†è‡ªè¡›æ•™åœ’åœ° â†’ è¿”å›æ…¢æ€§ç—…ç›¸é—œåœ–ç‰‡
- æŸ¥è©¢ã€Œçµæ ¸ç—…å‚³æŸ“ã€â†’ ä¾†è‡ªæ„ŸæŸ“ç®¡åˆ¶ â†’ è¿”å›å‚³æŸ“ç—…ç›¸é—œåœ–ç‰‡

---

## 8. éƒ¨ç½²èˆ‡å•Ÿå‹•

### 8.1 ç’°å¢ƒè®Šæ•¸ (.env)

```ini
# è³‡æ–™åº«
DB_HOST=localhost
DB_PORT=5432
DB_NAME=infection_rag
DB_USER=langchain
DB_PASSWORD=langchain

# vLLM API
OPENAI_API_BASE=http://localhost:8080/v1

# Langfuse ç›£æ§ï¼ˆå¯é¸ï¼‰
LANGFUSE_ENABLED=true
LANGFUSE_PUBLIC_KEY=...
LANGFUSE_SECRET_KEY=...
LANGFUSE_HOST=http://localhost:3000
```

### 8.2 å‰ç½®æœå‹™

åœ¨å•Ÿå‹• Agent ä¹‹å‰ï¼Œç¢ºä¿ä»¥ä¸‹æœå‹™å·²é‹è¡Œï¼š

| æœå‹™ | å•Ÿå‹•æ–¹å¼ | è©³ç´°èªªæ˜ |
|------|----------|----------|
| PostgreSQL + pgvector | `sudo systemctl start postgresql` | - |
| vLLM æœå‹™ï¼ˆLLM + Embeddingï¼‰ | `./vllm_sh.sh start all` | è¦‹ [0.6 vLLM æœå‹™ç®¡ç†](#06-vllm-æœå‹™ç®¡ç†) |
| Valkey/Redisï¼ˆå¯é¸ï¼‰ | `valkey-server` | ç”¨æ–¼å¿«å– |
| Langfuseï¼ˆå¯é¸ï¼‰ | `cd langfuse && docker-compose up -d` | è¦‹ [0.7 Langfuse V3 éƒ¨ç½²](#07-langfuse-v3-éƒ¨ç½²) |

### 8.3 å•Ÿå‹•æŒ‡ä»¤

```bash
cd /home/danny/AI-agent/Agent_System

# æ–¹å¼ 1: ä½¿ç”¨ç®¡ç†è…³æœ¬ï¼ˆæ¨è–¦ï¼‰
bash manage_api.sh start     # å•Ÿå‹• API
bash manage_api.sh stop      # åœæ­¢ API
bash manage_api.sh restart   # é‡å•Ÿ API
bash manage_api.sh status    # æŸ¥çœ‹ç‹€æ…‹
bash manage_api.sh logs      # æŸ¥çœ‹æ—¥èªŒï¼ˆCtrl+C é€€å‡ºï¼‰

# é è¨­ç›£è½: http://172.23.37.2:8100

# æ–¹å¼ 2: ç›´æ¥åŸ·è¡Œï¼ˆå‰å°é‹è¡Œï¼Œç”¨æ–¼é™¤éŒ¯ï¼‰
python fastapi_main.py

# æ–¹å¼ 3: CLI æ¸¬è©¦æ¨¡å¼
python langgraph_clean.py
```

#### manage_api.sh èªªæ˜

ç®¡ç†è…³æœ¬ä½æ–¼ `/home/danny/AI-agent/Agent_System/manage_api.sh`ï¼š

| å‘½ä»¤ | èªªæ˜ |
|------|------|
| `start` | èƒŒæ™¯å•Ÿå‹• APIï¼Œæ—¥èªŒè¼¸å‡ºè‡³ `api.log` |
| `stop` | åœæ­¢ API é€²ç¨‹ |
| `restart` | é‡å•Ÿ APIï¼ˆå…ˆ stop å† startï¼‰ |
| `status` | é¡¯ç¤º API é‹è¡Œç‹€æ…‹å’Œ PID |
| `logs` | å³æ™‚æŸ¥çœ‹æ—¥èªŒï¼ˆtail -fï¼‰ |

### 8.4 API ç«¯é»

| ç«¯é» | æ–¹æ³• | èªªæ˜ |
|------|------|------|
| `/` | GET | å¥åº·æª¢æŸ¥ |
| `/api/config` | GET | ç²å–å¯ç”¨çš„è³‡æ–™æºå’Œå·¥å…· |
| `/chat` | POST | ä¸€èˆ¬å•ç­”ï¼ˆå®Œæ•´å›æ‡‰ï¼‰ |
| `/chat/stream` | POST | ä¸²æµå•ç­”ï¼ˆSSEï¼‰ |
| `/api/table-image/{filename}` | GET | ç²å–è¡¨æ ¼åœ–ç‰‡ |
| `/api/educational-image/{filename}` | GET | ç²å–è¡›æ•™åœ–ç‰‡ |
| `/memory/clear/short_term` | DELETE | æ¸…é™¤çŸ­æœŸè¨˜æ†¶ |
| `/memory/clear/long_term` | DELETE | æ¸…é™¤é•·æœŸè¨˜æ†¶ |
| `/memory/clear/all` | DELETE | æ¸…é™¤æ‰€æœ‰è¨˜æ†¶ |

---

## 9. ç¶­è­·æŒ‡å—

### 9.1 è³‡æ–™è™•ç†å·¥å…·ç¸½è¦½

ç³»çµ±æœ‰å¤šå€‹è³‡æ–™è™•ç†å·¥å…·ï¼Œè™•ç†ä¸åŒé¡å‹çš„è³‡æ–™ï¼š

| å·¥å…· | ç”¨é€” | GPU | æ¨¡å‹ | è¼¸å‡º Collection |
|------|------|-----|------|-----------------|
| `ingest_dialysis_pdf.py` | æ´—è…è¡›æ•™ PDF | GPU 0 | DeepSeek OCR | `dialysis_education_materials` |
| `ingest_health_images.py` | è¡›æ•™åœ–ç‰‡æ“·å–åˆ†æ | GPU 1 | Qwen3-4B-VL | `educational_images` |
| `ingest_general_medical.py` | é†«ç™‚ PDF é€šç”¨è™•ç† | GPU 0 | DeepSeek OCR | å¯è‡ªè¨‚ |

#### 9.1.1 æ´—è…è¡›æ•™ PDF è™•ç†

```bash
cd /home/danny/AI-agent/Agent_System

# è™•ç†æ´—è…è¡›æ•™è³‡æ–™ (æ¨è–¦)
python -m etl.run_pipeline dialysis

# æˆ–ç›´æ¥åŸ·è¡Œè…³æœ¬
python data_process/ingest_dialysis_pdf.py
```

**è³‡æ–™ä¾†æºç›®éŒ„**ï¼š`/home/danny/AI-agent/æ´—è…è¡›æ•™/`

**åŠŸèƒ½ç‰¹é»**ï¼š
- å°ˆç‚ºæ´—è…è¡›æ•™è¨­è¨ˆ
- å…¨å¯¬åº¦è¡¨æ ¼è£åˆ‡ç­–ç•¥
- è‡ªå‹•åˆä½µé‡ç–Šè¡¨æ ¼
- ç´”åœ–ç‰‡/åœ–è¡¨å¼·åˆ¶å¯«å…¥å‘é‡ç´¢å¼•

#### 9.1.2 è¡›æ•™åœ–ç‰‡æ“·å–èˆ‡åˆ†æ

```bash
cd /home/danny/AI-agent/Agent_System

# åŸ·è¡Œåœ–ç‰‡è™•ç†æµæ°´ç·š (æ¨è–¦)
python -m etl.run_pipeline images

# æˆ–ç›´æ¥åŸ·è¡Œè…³æœ¬
python data_process/ingest_health_images.py
```

**è¼¸å‡ºç›®éŒ„**ï¼š
- æš«å­˜ï¼š`/home/danny/AI-agent/image_search/`
- æœ€çµ‚ï¼š`/home/danny/AI-agent/high_value_images/`
- åˆ†æçµæœï¼š`/home/danny/AI-agent/pipeline_data/`

**åŠŸèƒ½ç‰¹é»**ï¼š
- ä½¿ç”¨ Qwen3-4B-VL è¦–è¦ºæ¨¡å‹åˆ†æåœ–ç‰‡å…§å®¹
- åš´æ ¼ç¯©é¸é«˜å“è³ªè¡›æ•™åœ–ç‰‡ï¼ˆè©•åˆ† â‰¥ 4ï¼‰
- æ’é™¤è£é£¾æ€§ã€å¡é€šã€ç„¡æ–‡å­—åœ–ç‰‡
- æ”¯æ´æ–·é»çºŒå‚³

**ç¯©é¸æ¨™æº–**ï¼š
- âœ… é†«ç™‚ç›¸é—œ + æœ‰æ–‡å­—èªªæ˜ + æ°‘çœ¾å¯çœ‹æ‡‚ + å¯¦ç”¨åƒ¹å€¼é«˜
- âŒ è£é£¾æ€§åœ–ç‰‡ã€å¡é€šã€ç´”å™¨å®˜åœ–ç¤ºã€ç„¡æ–‡å­—ç…§ç‰‡

#### 9.1.3 Metadata æ ¼å¼èªªæ˜

å„å·¥å…·å¯«å…¥å‘é‡è³‡æ–™åº«æ™‚ä½¿ç”¨çš„ metadata æ ¼å¼ï¼š

**PDF æ–‡ä»¶ Metadataï¼ˆingest_dialysis_pdf.pyï¼‰**

```json
{
  "source_file": "ç³–å°¿ç—…é£²é£ŸæŒ‡å—.pdf",
  "source_type": "ocr_pdf_advanced",
  "page": 3,
  "original_text": "åŸå§‹ OCR æ–‡å­—å…§å®¹...",
  "folder": "è¡›æ•™åœ’åœ°",
  "page_label": "3",
  "has_table": true,
  "table_images": ["ç³–å°¿ç—…é£²é£ŸæŒ‡å—_p3_t1.jpg"],
  "pdf_file": "ç³–å°¿ç—…é£²é£ŸæŒ‡å—.pdf",
  "category": "æ´—è…è¡›æ•™",
  "reference": "ç³–å°¿ç—…é£²é£ŸæŒ‡å—.pdf",
  "collection_name": "dialysis_education_materials"
}
```

| æ¬„ä½ | èªªæ˜ |
|------|------|
| `source_file` | ä¾†æº PDF æª”å |
| `source_type` | ä¾†æºé¡å‹ï¼ˆ`ocr_pdf` / `ocr_pdf_advanced`ï¼‰ |
| `page` | é ç¢¼ï¼ˆæ•´æ•¸ï¼‰ |
| `original_text` | åŸå§‹ OCR æ–‡å­— |
| `folder` | ä¾†æºè³‡æ–™å¤¾åç¨± |
| `has_table` | æ˜¯å¦åŒ…å«è¡¨æ ¼ |
| `table_images` | æ“·å–çš„è¡¨æ ¼åœ–ç‰‡æª”ååˆ—è¡¨ |
| `category` | åˆ†é¡ï¼ˆå¦‚ã€Œæ´—è…è¡›æ•™ã€ï¼‰ |

**JSONL å•ç­”è³‡æ–™ Metadata**

```json
{
  "id": "qa_001",
  "source_file": "é†«ç™‚å•ç­”.jsonl",
  "sheet_name": "æ„ŸæŸ“ç§‘",
  "title": "ä»€éº¼æ˜¯ç³–å°¿ç—…ï¼Ÿ",
  "keywords": "ç³–å°¿ç—…,è¡€ç³–,èƒ°å³¶ç´ ",
  "reference": "è¡›ç”Ÿç¦åˆ©éƒ¨åœ‹æ°‘å¥åº·ç½²",
  "original_text": "å®Œæ•´å›ç­”å…§å®¹...",
  "original_full_text": "å•é¡Œ + å›ç­”å®Œæ•´å…§å®¹",
  "source_type": "jsonl"
}
```

| æ¬„ä½ | èªªæ˜ |
|------|------|
| `id` | å”¯ä¸€è­˜åˆ¥ç¢¼ |
| `title` | å•é¡Œæ¨™é¡Œ |
| `keywords` | é—œéµå­—ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰ |
| `reference` | åƒè€ƒä¾†æº |
| `original_text` | åŸå§‹å›ç­” |
| `source_type` | å›ºå®šç‚º `jsonl` |

**è¡›æ•™åœ–ç‰‡ Metadataï¼ˆingest_health_images.pyï¼‰**

```json
{
  "filename": "æ´—æ‰‹æ­¥é©Ÿ_p2_i1.jpg",
  "image_path": "æ´—æ‰‹æ­¥é©Ÿ_p2_i1.jpg",
  "health_topic": "æ‰‹éƒ¨è¡›ç”Ÿ",
  "main_category": "æ„ŸæŸ“é é˜²",
  "content_type": "æ­¥é©ŸæŒ‡å°",
  "has_text_description": true,
  "is_self_explanatory": true,
  "source_pdf": "æ„ŸæŸ“é é˜²æ‰‹å†Š.pdf",
  "page": 2,
  "score": 5,
  "source": "strict_pipeline"
}
```

| æ¬„ä½ | èªªæ˜ |
|------|------|
| `filename` | åœ–ç‰‡æª”å |
| `health_topic` | å¥åº·ä¸»é¡Œï¼ˆVLM åˆ†æï¼‰ |
| `main_category` | ä¸»è¦åˆ†é¡ï¼ˆVLM åˆ†æï¼‰ |
| `content_type` | å…§å®¹é¡å‹ï¼ˆæ­¥é©ŸæŒ‡å°/ç—‡ç‹€å°ç…§/æ•¸æ“šè¡¨æ ¼ç­‰ï¼‰ |
| `has_text_description` | åœ–ç‰‡æ˜¯å¦åŒ…å«æ–‡å­—èªªæ˜ |
| `is_self_explanatory` | æ˜¯å¦è‡ªæˆ‘èªªæ˜ï¼ˆæ°‘çœ¾å¯ç›´æ¥ç†è§£ï¼‰ |
| `score` | å“è³ªè©•åˆ†ï¼ˆ1-5ï¼Œâ‰¥4 æ‰æœƒå¯«å…¥ï¼‰ |
| `source` | è™•ç†ä¾†æºï¼ˆ`strict_pipeline`ï¼‰ |

### 9.2 ä¿®æ”¹ Prompt

æ‰€æœ‰ Prompt æ¨¡æ¿é›†ä¸­åœ¨ `core/prompt_config.py`ï¼š

- `QUERY_PLANNING_PROMPT` - Planning è¦åŠƒæç¤º
- `ANSWER_VALIDATION_PROMPT` - å›ç­”é©—è­‰æç¤º
- `GREET_PROMPTTEMPLATE` - å•å€™å›æ‡‰æç¤º
- `QUESTION_TYPE_CHECK_PROMPT` - å•é¡Œé¡å‹æª¢æŸ¥æç¤º

### 9.3 æ–°å¢æœå°‹å·¥å…·

1. åœ¨ `tools/` å‰µå»ºæ–°å·¥å…·æª”æ¡ˆ
2. ä½¿ç”¨ `@tool` è£é£¾å™¨å®šç¾©å·¥å…·å‡½æ•¸
3. åœ¨ `tools_init.py` è¨»å†Šå·¥å…·
4. åœ¨ `core/config.py` çš„ `TOOLS_CONFIG['default_tools']` ä¸­å•Ÿç”¨

### 9.4 æŸ¥çœ‹æ—¥èªŒ

```bash
# æ–¹å¼ 1: ä½¿ç”¨ç®¡ç†è…³æœ¬ï¼ˆæ¨è–¦ï¼‰
bash manage_api.sh logs

# æ–¹å¼ 2: ç›´æ¥æŸ¥çœ‹æ—¥èªŒæª”æ¡ˆ
tail -f /home/danny/AI-agent/Agent_System/api.log

# Langfuse è¿½è¹¤
# ç™»å…¥ http://172.23.53.2:3000 æŸ¥çœ‹è©³ç´° Trace
```

### 9.5 å¿«å–ç®¡ç†

```bash
# CLI æ¨¡å¼ä¸‹æ¸…é™¤å¿«å–
> /clear

# æŸ¥çœ‹å¿«å–çµ±è¨ˆ
> /stats
```

---

## 10. å¸¸è¦‹å•é¡Œæ’æŸ¥

### 10.1 GraphRecursionError

**ç—‡ç‹€**: `RecursionError: maximum recursion depth exceeded`

**åŸå› **: å·¥ä½œæµç¨‹è¿´åœˆæ¬¡æ•¸è¶…éé™åˆ¶

**è§£æ±ºæ–¹æ¡ˆ**:
1. æª¢æŸ¥ `WORKFLOW_LIMITS['langgraph_recursion_limit']`ï¼ˆé è¨­ 50ï¼‰
2. æª¢æŸ¥æ˜¯å¦æœ‰è·¯ç”±é‚è¼¯å°è‡´ç„¡é™è¿´åœˆ
3. æŸ¥çœ‹ `iteration_count` æ˜¯å¦æ­£ç¢ºéå¢

### 10.2 æª¢ç´¢ç„¡çµæœ

**ç—‡ç‹€**: `knowledge` ç‚ºç©ºï¼Œå›ç­”ã€ŒæŠ±æ­‰ï¼Œè³‡æ–™åº«ä¸­æœªæ‰¾åˆ°...ã€

**æ’æŸ¥æ­¥é©Ÿ**:
1. ç¢ºèª PostgreSQL æœå‹™é‹è¡Œä¸­
2. ç¢ºèªå°æ‡‰ collection å­˜åœ¨ä¸”æœ‰è³‡æ–™
3. æª¢æŸ¥ `RETRIEVAL_CONFIG['default_datasource_ids']` é…ç½®
4. å˜—è©¦é™ä½ç›¸ä¼¼åº¦é–¾å€¼

### 10.3 vLLM é€£æ¥å¤±æ•—

**ç—‡ç‹€**: `Connection refused` æˆ– `timeout`

**è§£æ±ºæ–¹æ¡ˆ**:
1. ç¢ºèª vLLM æœå‹™é‹è¡Œä¸­ï¼ˆç«¯å£ 8080 å’Œ 8081ï¼‰
2. æª¢æŸ¥ `CUDA_VISIBLE_DEVICES` ç’°å¢ƒè®Šæ•¸
3. ç¢ºèª GPU è¨˜æ†¶é«”è¶³å¤ 

### 10.4 Langfuse è¿½è¹¤æœªé¡¯ç¤º

**æ’æŸ¥æ­¥é©Ÿ**:
1. ç¢ºèª `LANGFUSE_ENABLED=true`
2. ç¢ºèª API å¯†é‘°æ­£ç¢º
3. èª¿ç”¨ `flush_langfuse()` å¼·åˆ¶ä¸Šå‚³

### 10.5 è¨˜æ†¶é«”ä¸è¶³

**è§£æ±ºæ–¹æ¡ˆ**:
1. é™ä½ `CACHE_CONFIG` ä¸­çš„å¿«å–å¤§å°
2. å•Ÿç”¨ Valkey/Redis å¤–éƒ¨å¿«å–
3. èª¿æ•´ `MESSAGE_SUMMARIZATION_CONFIG` æ›´ç©æ¥µåœ°æ‘˜è¦

### 10.6 API å•Ÿå‹•å¤±æ•— - Port Already in Use

**ç—‡ç‹€**: `ERROR: [Errno 98] error while attempting to bind on address ('172.23.37.2', 8100): address already in use`

**åŸå› **: æœ‰èˆŠçš„ API é€²ç¨‹ä»åœ¨ä½”ç”¨ç«¯å£ 8100

**è§£æ±ºæ–¹æ¡ˆ**:
```bash
# 1. æŸ¥çœ‹ä½”ç”¨ç«¯å£çš„é€²ç¨‹
lsof -i :8100

# 2. çµ‚æ­¢èˆŠé€²ç¨‹ï¼ˆå°‡ PID æ›¿æ›ç‚ºå¯¦éš›çš„é€²ç¨‹ IDï¼‰
kill <PID>

# 3. é‡æ–°å•Ÿå‹• API
bash manage_api.sh start
```

**é é˜²æªæ–½**: ä½¿ç”¨ `manage_api.sh restart` æœƒè‡ªå‹•è™•ç†èˆŠé€²ç¨‹

---

## é™„éŒ„ A: é‡è¦è³‡æ–™é¡

### ValidationResult (core/dataclass.py)

```python
class ValidationResult(BaseModel):
    validation_type: Literal["pass", "regenerate", "need_more_knowledge", "out_of_scope"]
    missing_info: Optional[str] = None
    suggested_sub_questions: Optional[List[str]] = None
    reasoning: str
```

### QueryPlanningResult (core/dataclass.py)

```python
class QueryPlanningResult(BaseModel):
    needs_planning: bool
    reasoning: str
    retrieval_steps: List[RetrievalStep] = []
```

### MedicalResponse (core/dataclass.py)

```python
class MedicalResponse(BaseModel):
    summary: str
    references: List[ReferenceSource]
    matched_table_images: List[dict]
    matched_educational_images: List[dict]
```

---

## é™„éŒ„ B: é—œéµå‡½æ•¸é€ŸæŸ¥

| å‡½æ•¸ | ä½ç½® | åŠŸèƒ½ |
|------|------|------|
| `retrieve_single_query()` | retrieval/retrieval_utils.py | å–®å€‹æŸ¥è©¢çš„æª¢ç´¢ |
| `retrieve_multiple_queries()` | graph/graph_nodes.py | ä¸¦è¡Œå¤šæŸ¥è©¢æª¢ç´¢ |
| `rebuild_references_from_used_sources()` | graph/graph_nodes.py | é‡å»ºåƒè€ƒæ–‡ç»å€å¡Š |
| `match_tables_for_answer()` | graph/graph_nodes.py | ç‚ºå›ç­”åŒ¹é…è¡¨æ ¼åœ–ç‰‡ |
| `get_langfuse_config()` | monitoring/langfuse_integration.py | ç²å– Langfuse é…ç½® |
| `get_cache_manager()` | graph/graph_nodes.py | ç²å–å¿«å–ç®¡ç†å™¨å¯¦ä¾‹ |

---

**äº¤æ¥å®Œç•¢ã€‚å¦‚æœ‰å•é¡Œè«‹è¯ç¹« Dannyã€‚Good Luck!**
