graph TD
    %% 樣式定義
    classDef startNode fill:#00c853,stroke:#333,stroke-width:2px,color:white;
    classDef processNode fill:#e1f5fe,stroke:#0277bd,stroke-width:2px;
    classDef parallelNode fill:#fff9c4,stroke:#fbc02d,stroke-width:2px;
    classDef decisionNode fill:#fce4ec,stroke:#c2185b,stroke-width:2px,shape:diamond;
    classDef loopNode fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px;
    classDef endNode fill:#424242,stroke:#333,stroke-width:2px,color:white;

    %% 節點定義
    Start([開始: prepare_data]) --> |準備市場數據 & 用戶設定| AnalystTeam[分析師團隊: run_analyst_team]
    
    subgraph Analyst_Phase [階段一：多維度分析]
        direction TB
        AnalystTeam --> |並行執行| Tech[技術分析師]
        AnalystTeam --> |並行執行| Sent[情緒分析師]
        AnalystTeam --> |並行執行| Fund[基本面分析師]
        AnalystTeam --> |並行執行| News[新聞分析師]
    end

    Tech & Sent & Fund & News --> Router1{需要交易決策?}
    
    Router1 --> |否: 僅請求分析| EndNode([結束])
    Router1 --> |是: 進入決策流程| DebateRound[研究辯論: run_research_debate]

    subgraph Debate_Phase [階段二：觀點辯論與驗證]
        direction TB
        DebateRound --> |生成觀點| Bull[多頭研究員/委員會]
        DebateRound --> |生成觀點| Bear[空頭研究員/委員會]
        DebateRound --> |生成觀點| Neutral[中立研究員]
        
        Bull & Bear & Neutral --> FactCheck[數據檢察官: FactChecker]
        FactCheck --> DebateCheck{繼續辯論?}
        
        DebateCheck --> |"輪次 < 3 且 無明顯勝者"| DebateRound
        DebateCheck --> |"輪次 >= 3 或 勝負已分"| Judge[裁判裁決: run_debate_judgment]
    end

    Judge --> |傳遞裁決結果| Trader[交易員決策: run_trader_decision]

    subgraph Execution_Phase [階段三：決策與執行]
        direction TB
        Trader --> RiskMgr[風險管理: run_risk_management]
        
        RiskMgr --> RiskCheck{風險批准?}
        
        RiskCheck --> |"否 (且未達重試上限)"| Trader
        RiskCheck --> |"是 (或已達上限)"| FundMgr[基金經理審批: run_fund_manager_approval]
        
        FundMgr --> Executor[交易執行: execute_trade_node]
    end

    Executor --> EndNode

    %% 樣式應用
    class Start startNode;
    class AnalystTeam,DebateRound,Judge,Trader,RiskMgr,FundMgr,Executor processNode;
    class Tech,Sent,Fund,News,Bull,Bear,Neutral,FactCheck parallelNode;
    class Router1,DebateCheck,RiskCheck decisionNode;
    class EndNode endNode;

    %% 註解
    click AnalystTeam "API調用與數據處理"
    click DebateRound "LLM 辯論循環"
